<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Products ‚Äì BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }
    .card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .card h3 i { color: #4F46E5; }

    /* Industry Selector - compact */
    .industry-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      padding: 0.35rem 0.65rem;
      font-size: 0.8rem;
      position: relative;
      transition: all 0.2s;
    }
    .industry-selector:hover {
      border-color: #CBD5E1;
      background: white;
    }
    .industry-selector-content {
      display: flex;
      flex-direction: column;
    }
    .industry-selector-title {
      font-size: 0.6rem;
      font-weight: 600;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .industry-selector select {
      border: none;
      background: transparent;
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      padding: 0;
      margin: 0;
      margin-left: -3px;
      outline: none;
    }
    .industry-selector select:focus {
      outline: none;
    }
    .industry-selector.food {
      background: #ECFDF5;
      border-color: #10B981;
    }
    .industry-selector.food .industry-selector-title {
      color: #059669;
    }
    .industry-selector.food select {
      color: #065F46;
    }
    
    .save-preference {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.7rem;
      color: #64748B;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
      margin-left: auto;
      background: rgba(0,0,0,0.05);
    }
    .save-preference:hover {
      background: rgba(0,0,0,0.08);
      color: #334155;
    }
    .save-preference input {
      width: 12px;
      height: 12px;
      cursor: pointer;
    }
    .save-preference.saved {
      color: #10B981;
      background: rgba(16, 185, 129, 0.1);
    }

    /* Toggle Containers */
    .toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 2px solid #E2E8F0;
      position: relative;
    }
    .toggle-container.production { border-color: #10B981; }
    .toggle-container.excel { border-color: #F59E0B; }
    
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: #334155; }
    .toggle-label i { color: #4F46E5; }
    .toggle-label i.production { color: #10B981; }
    .toggle-label i.excel { color: #F59E0B; }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: #CBD5E1;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.active { background: #4F46E5; }
    .toggle-switch.active.production { background: #10B981; }
    .toggle-switch.active.excel { background: #F59E0B; }
    .toggle-switch-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .toggle-switch.active .toggle-switch-slider { transform: translateX(28px); }

    /* Info Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: #E2E8F0;
      color: #64748B;
      border-radius: 50%;
      font-size: 0.7rem;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: all 0.2s;
    }
    .info-icon:hover { background: #4F46E5; color: white; }
    
    .info-tooltip {
      display: none;
      position: absolute;
      background: #1E293B;
      color: white;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 400;
      width: 300px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      line-height: 1.5;
      top: 100%;
      left: 0;
      margin-top: 0.5rem;
    }
    .info-tooltip.show { display: block; }
    .info-tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 20px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #1E293B;
    }
    .info-tooltip code {
      background: rgba(255,255,255,0.15);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    /* Expandable Sections */
    .expandable-section {
      display: none;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    .expandable-section.show { display: block; }
    .expandable-section.batch { background: #FEF3C7; border: 2px solid #FDE047; }
    .expandable-section.production { background: #ECFDF5; border: 2px solid #10B981; }
    .expandable-section.excel { background: #FEF3C7; border: 2px solid #F59E0B; }
    .expandable-section h4 { margin-bottom: 0.75rem; }
    .expandable-section.batch h4 { color: #92400E; }
    .expandable-section.production h4 { color: #065F46; }
    .expandable-section.excel h4 { color: #92400E; }
    .expandable-section p { font-size: 0.9rem; margin-bottom: 0; }
    .expandable-section.batch p { color: #92400E; }
    .expandable-section.production p { color: #047857; }
    .expandable-section.excel p { color: #92400E; }

    .batch-info { margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.875rem; color: #92400E; }

    /* Excel Upload Area */
    .excel-instructions {
      color: #92400E;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    .excel-instructions code {
      background: white;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      font-style: normal;
      color: #B45309;
    }

    .excel-upload-area {
      border: 2px dashed #F59E0B;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .excel-upload-area:hover { background: #FFFBEB; }
    .excel-upload-area.dragover { background: #FEF3C7; border-style: solid; }
    .excel-upload-area i { font-size: 2.5rem; color: #F59E0B; margin-bottom: 0.75rem; }
    .excel-upload-area p { color: #92400E; font-weight: 500; margin-bottom: 0.25rem; }
    .excel-upload-area small { color: #B45309; }

    .excel-preview {
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #E2E8F0;
    }
    .excel-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #F8FAFC;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-header strong { color: #334155; }
    .excel-preview-clear {
      background: none;
      border: none;
      color: #DC2626;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .excel-preview-table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
    }
    .excel-preview-table th, .excel-preview-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-table th { background: #F8FAFC; font-weight: 600; color: #64748B; }
    .excel-preview-table tr:last-child td { border-bottom: none; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #334155; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #F8FAFC;
    }
    .form-group input:disabled { background: #F1F5F9; color: #94A3B8; cursor: not-allowed; opacity: 0.6; }
    .form-group input:focus:not(:disabled), .form-group textarea:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      background: white;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      width: 100%;
      justify-content: center;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      box-shadow: none;
      padding: 0.75rem 1.5rem;
      width: auto;
    }
    .btn-secondary:hover:not(:disabled) { background: #F8FAFC; transform: none; }

    .message { padding: 1rem; border-radius: 12px; margin-top: 1rem; font-weight: 500; display: flex; align-items: flex-start; gap: 0.75rem; }
    .message.success { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
    .message.error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .message.info { background: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; }

    /* Quick Links - Stacked */

    /* Compact Header Bar */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .header-bar h1 {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1E293B;
      margin: 0;
    }
    .header-subtitle {
      font-size: 0.85rem;
      color: #64748B;
      margin: 0 0 1rem 0;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    /* Quick Links - Compact Row */
    .quick-links-row {
      display: flex;
      gap: 0.5rem;
    }
    .quick-link-compact {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.65rem;
      background: #F8FAFC;
      border-radius: 8px;
      border: 1px solid #E2E8F0;
      text-decoration: none;
      color: #334155;
      font-weight: 500;
      font-size: 0.75rem;
      transition: all 0.2s;
    }
    .quick-link-compact:hover { border-color: #4F46E5; background: white; }
    .quick-link-compact i { font-size: 0.75rem; color: #4F46E5; }
    .quick-link-compact.production i { color: #10B981; }
    .quick-link-compact.production:hover { border-color: #10B981; }
    .quick-link-count {
      background: #E2E8F0;
      color: #64748B;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 600;
    }
    
    .qr-badge {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      padding: 0.4rem 0.75rem;
      border-radius: 10px;
      font-size: 0.8rem;
    }
    .qr-badge-number {
      font-weight: 800;
      font-size: 1.1rem;
    }
    .qr-badge-label {
      opacity: 0.9;
      font-size: 0.65rem;
    }
    .qr-badge-tier {
      background: rgba(255,255,255,0.2);
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      font-size: 0.6rem;
      font-weight: 600;
    }

    /* Single item helper text */
    .single-item-helper {
      color: #64748B;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1rem;
      background: #FFFBEB;
      border-radius: 8px;
      border: 1px solid #FDE68A;
    }
    .single-item-helper i {
      color: #F59E0B;
      margin-right: 0.5rem;
    }

    @media (max-width: 768px) {
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; padding-top: 5rem; }
      .header-bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .header-controls { width: 100%; flex-wrap: wrap; gap: 0.5rem; }
      .quick-links-row { width: 100%; }
      .toggle-container { flex-wrap: wrap; gap: 0.75rem; }
      .industry-selector { flex: 1; }
      .qr-badge { flex: 1; justify-content: center; }
    }
  </style>
</head>
<body>
  <script src="js/SI-sidebar.js"></script>

  <div class="main-with-sidebar">
    <!-- Compact Header Bar -->
    <div class="header-bar">
      <h1>Create Products</h1>
      <div class="header-controls">
        <!-- Industry Selector -->
        <div class="industry-selector" id="industrySelector">
          <div class="industry-selector-content">
            <span class="industry-selector-title">Industry</span>
            <select id="industrySelect" onchange="handleIndustryChange()">
              <option value="general">General</option>
              <option value="food">Food / Farm to Table</option>
            </select>
          </div>
          <label class="save-preference" id="savePreferenceLabel">
            <input type="checkbox" id="savePreferenceCheckbox" onchange="handleSavePreference()" />
            <span id="savePreferenceText">Save</span>
          </label>
        </div>
        
        <div class="qr-badge">
          <div>
            <div class="qr-badge-number"><span id="qrUsedCount">0</span> <span style="font-size: 0.875rem; font-weight: 400;">/ <span id="qrLimitCount">10</span></span></div>
            <div class="qr-badge-label">QR codes this month</div>
          </div>
          <span class="qr-badge-tier" id="tierName">Free</span>
        </div>
        
        <div class="quick-links-row">
          <a href="products.html" class="quick-link-compact">
            <i class="fas fa-box-check"></i>
            <span>Finished</span>
            <span class="quick-link-count" id="finishedCount">-</span>
          </a>
          <a href="production.html" class="quick-link-compact production">
            <i class="fas fa-industry"></i>
            <span>In Progress</span>
            <span class="quick-link-count" id="productionCount">-</span>
          </a>
        </div>
      </div>
    </div>
    <p class="header-subtitle" id="headerSubtitle">Mint products, documents, certificates, or any data to the blockchain for permanent verification.</p>

    <div class="card">
      <h3><i class="fas fa-plus-circle"></i> <span id="cardTitle">New Product</span></h3>
      
      <!-- Batch Toggle -->
      <div class="toggle-container" id="batchToggleContainer">
        <div class="toggle-label">
          <i class="fas fa-layer-group"></i>
          <span id="batchToggleText">Batch Upload</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'batchTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="batchTooltip">
          <strong>What is Batch Upload?</strong><br><br>
          <span id="batchTooltipContent">Have multiple items to mint at once? Enable batch mode to either enter a quantity (for identical items) or upload an Excel file (for different products with unique SKUs).</span>
        </div>
        <div class="toggle-switch" id="batchToggle" onclick="toggleBatchMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Production Mode Toggle -->
      <div class="toggle-container production">
        <div class="toggle-label">
          <i class="fas fa-route production"></i>
          <span id="productionToggleText">Production Mode</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'productionTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="productionTooltip">
          <strong id="productionTooltipTitle">What is Production Mode?</strong><br><br>
          <span id="productionTooltipContent">Does your product have multiple steps before reaching a consumer? Production Mode lets you track each checkpoint in your supply chain‚Äîmanufacturing, quality checks, shipping, distribution‚Äîbefore going live.<br><br>
          Each stop scans the same QR code to log their part of the journey. When ready, hit "Go Live" and customers see the full verified timeline.</span>
        </div>
        <div class="toggle-switch production" id="productionToggle" onclick="toggleProductionMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Single Item Helper Text -->
      <p class="single-item-helper" id="singleItemHelper">
        <i class="fas fa-lightbulb"></i>
        <span id="singleItemHelperText"><strong>Just need one QR code?</strong> Skip the toggles and fill out the form below. 
        It doesn't have to be a product‚Äîmint anything: documents, certificates, artwork, event tickets, or any data point you want permanently verified.</span>
      </p>

      <!-- Batch Section (quantity input + Excel option below) -->
      <div class="expandable-section batch" id="batchSection">
        <h4><i class="fas fa-boxes"></i> <span id="batchSectionTitle">Batch Settings</span></h4>
        
        <!-- Quantity Input -->
        <div class="form-group">
          <label for="batchQuantity">
            <span id="batchQuantityLabel">How many identical items?</span>
            <span id="remainingQRs" style="color: #059669; font-size: 0.875rem;"></span>
          </label>
          <input id="batchQuantity" type="number" min="1" max="1000" value="5" placeholder="Enter quantity..." />
          <p style="font-size: 0.8rem; color: #92400E; margin-top: 0.5rem;" id="batchSkuHelp">
            SKUs will be auto-generated (e.g., HONEY-001, HONEY-002, ...)
          </p>
        </div>

        <!-- OR divider -->
        <div style="display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0;">
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
          <span style="color: #92400E; font-weight: 600; font-size: 0.85rem;" id="batchOrDivider">OR upload an Excel for a batch with individual items</span>
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
        </div>

        <!-- Excel Upload -->
        <div id="batchExcelInput">
          <p class="excel-instructions" id="excelInstructions">
            <strong>Do not include headers.</strong> Each row becomes a product entry.<br>
            Enter data in columns as follows:<br>
            <code>A: Product Name</code> <code>B: SKU</code> <code>C: Batch #</code> <code>D: Notes</code>
          </p>
          
          <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display: none;" />
          
          <div class="excel-upload-area" id="excelUploadArea" onclick="document.getElementById('excelInput').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag & drop</p>
            <small>.xlsx, .xls, or .csv</small>
          </div>

          <div class="excel-preview" id="excelPreview" style="display: none;">
            <div class="excel-preview-header">
              <strong><i class="fas fa-table"></i> <span id="excelFileName">file.xlsx</span></strong>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                  <span id="excelRowCount">0</span> <span id="excelRowLabel">products</span>
                </span>
                <button class="excel-preview-clear" onclick="clearExcelUpload()"><i class="fas fa-times"></i> Clear</button>
              </div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
              <table class="excel-preview-table">
                <thead>
                  <tr id="excelPreviewHeader">
                    <th>Product Name</th>
                    <th>SKU</th>
                    <th>Batch #</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="excelPreviewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Production Mode Section -->
      <div class="expandable-section production" id="productionSection">
        <h4><i class="fas fa-info-circle"></i> <span id="productionSectionTitle">Production Mode Enabled</span></h4>
        <p id="productionSectionDesc">Products will start in <strong>production tracking mode</strong>. You can log checkpoints (QC, shipping, etc.) before finalizing for customer verification. No QR codes charged until you "Go Live".</p>
      </div>

      <!-- Manual Entry Form -->
      <div id="manualEntryForm">
        <div class="form-group">
          <label for="dashProdName" id="prodNameLabel">Name *</label>
          <input id="dashProdName" type="text" placeholder="e.g. Organic Honey, Certificate #1042, Event Ticket" id="prodNameInput" />
        </div>
        
        <div class="form-group" id="skuGroup">
          <label for="dashSku" id="skuLabel">
            SKU <span style="color: #64748B; font-weight: 400;">(optional)</span>
            <span class="info-icon" onclick="toggleTooltip(event, 'skuTooltip')"><i class="fas fa-info"></i></span>
          </label>
          <div class="info-tooltip" id="skuTooltip">
            <strong>What is a SKU?</strong><br><br>
            <span id="skuTooltipContent">SKU (Stock Keeping Unit) is your internal product code for inventory tracking. Examples:<br>
            ‚Ä¢ <code>STRAW-LEM-001</code><br>
            ‚Ä¢ <code>HONEY-RAW-16OZ</code><br><br>
            <strong>Leave blank</strong> and we'll auto-generate one for you!</span>
          </div>
          <input id="dashSku" type="text" placeholder="e.g. MANGO-001 or leave blank to auto-generate" />
          <p id="skuSingleHelp" style="font-size: 0.8rem; color: #64748B; margin-top: 0.25rem;">
            This is encoded in your inventory barcode for internal tracking
          </p>
          <div id="skuBatchOptions" style="display: none; margin-top: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; font-size: 0.875rem; color: #475569; cursor: pointer;">
              <input type="checkbox" id="sameSku" style="width: 16px; height: 16px; cursor: pointer;" />
              <span id="sameSkuLabel">Give all items the same SKU</span>
            </label>
            <p id="skuHelpText" style="font-size: 0.8rem; color: #64748B; margin-top: 0.25rem;">
              If unchecked, we'll add -001, -002, etc. to make each item unique
            </p>
          </div>
        </div>
        
        <div class="form-group">
          <label for="dashBatch" id="batchNumberLabel">
            Batch Number <span style="color: #64748B; font-weight: 400;">(optional)</span>
            <span class="info-icon" onclick="toggleTooltip(event, 'batchTooltip2')"><i class="fas fa-info"></i></span>
          </label>
          <div class="info-tooltip" id="batchTooltip2">
            <strong id="batchTooltip2Title">What is a Batch Number?</strong><br><br>
            <span id="batchTooltip2Content">Use this to group products made together. Examples:<br>
            ‚Ä¢ Date made: <code>120524</code><br>
            ‚Ä¢ Batch ID: <code>BATCH-042</code><br>
            ‚Ä¢ Or just: <code>1</code><br><br>
            <strong>Skip it</strong> if you make products fresh/individually!</span>
          </div>
          <input id="dashBatch" type="text" placeholder="e.g. 120524, BATCH-001, or skip" />
        </div>
        
        <div class="form-group">
          <label for="dashMetadata" id="metadataLabel">
            Additional Info <span style="color: #64748B; font-weight: 400;">(optional)</span>
          </label>
          <textarea id="dashMetadata" placeholder="e.g. Made with real fruit, Fresh squeezed daily, Local pickup available, Ingredients: lemon, sugar, water" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label id="photosLabel">Photos (optional)</label>
          <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" />
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
              <i class="fas fa-camera"></i> Take Photo
            </button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
              <i class="fas fa-images"></i> Gallery
            </button>
            <button type="button" class="btn btn-secondary" id="captureLocationBtn">
              <i class="fas fa-map-marker-alt"></i> <span id="locationBtnText">Location</span>
            </button>
          </div>
          <div id="photoPreview" style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;"></div>
          <p id="locationDisplay" style="margin-top: 0.75rem; color: #10B981; font-size: 0.875rem; display: none;">
            <i class="fas fa-check-circle"></i> <span id="locationDisplayText">Location captured!</span>
          </p>
        </div>
      </div>
      
      <button class="btn" id="dashCreateBtn">
        <i class="fas fa-rocket"></i>
        <span id="mintButtonText">Mint to Blockchain</span>
      </button>
      
      <div id="dashMsg"></div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let isBatchMode = false;
    let isProductionMode = false;
    let selectedPhotos = [];
    let capturedLocation = null;
    let qrUsedThisMonth = 0;
    let qrLimit = 10;
    let currentTier = 'free';
    let excelData = [];
    let currentIndustry = 'general';
    let savedIndustryPreference = null;

    // ==========================================
    // INDUSTRY-SPECIFIC CONTENT
    // ==========================================
    const industryContent = {
      general: {
        headerSubtitle: 'Mint products, documents, certificates, or any data to the blockchain for permanent verification.',
        cardTitle: 'New Product',
        prodNameLabel: 'Name *',
        prodNameLabelBatch: 'Batch Name *',
        prodNamePlaceholder: 'e.g. Organic Honey, Certificate #1042, Event Ticket',
        prodNamePlaceholderBatch: 'e.g. Summer 2025 Collection',
        skuPlaceholder: 'e.g. MANGO-001 or leave blank to auto-generate',
        skuTooltipContent: 'SKU (Stock Keeping Unit) is your internal product code for inventory tracking. Examples:<br>‚Ä¢ <code>STRAW-LEM-001</code><br>‚Ä¢ <code>HONEY-RAW-16OZ</code><br><br><strong>Leave blank</strong> and we\'ll auto-generate one for you!',
        batchNumberLabel: 'Batch Number',
        batchNumberPlaceholder: 'e.g. 120524, BATCH-001, or skip',
        batchTooltip2Title: 'What is a Batch Number?',
        batchTooltip2Content: 'Use this to group products made together. Examples:<br>‚Ä¢ Date made: <code>120524</code><br>‚Ä¢ Batch ID: <code>BATCH-042</code><br>‚Ä¢ Or just: <code>1</code><br><br><strong>Skip it</strong> if you make products fresh/individually!',
        metadataLabel: 'Additional Info',
        metadataPlaceholder: 'e.g. Made with real fruit, Fresh squeezed daily, Local pickup available, Ingredients: lemon, sugar, water',
        singleItemHelperText: '<strong>Just need one QR code?</strong> Skip the toggles and fill out the form below. It doesn\'t have to be a product‚Äîmint anything: documents, certificates, artwork, event tickets, or any data point you want permanently verified.',
        batchTooltipContent: 'Have multiple items to mint at once? Enable batch mode to either enter a quantity (for identical items) or upload an Excel file (for different products with unique SKUs).',
        batchQuantityLabel: 'How many identical items?',
        batchSkuHelp: 'SKUs will be auto-generated (e.g., HONEY-001, HONEY-002, ...)',
        productionTooltipTitle: 'What is Production Mode?',
        productionTooltipContent: 'Does your product have multiple steps before reaching a consumer? Production Mode lets you track each checkpoint in your supply chain‚Äîmanufacturing, quality checks, shipping, distribution‚Äîbefore going live.<br><br>Each stop scans the same QR code to log their part of the journey. When ready, hit "Go Live" and customers see the full verified timeline.',
        productionSectionDesc: 'Products will start in <strong>production tracking mode</strong>. You can log checkpoints (QC, shipping, etc.) before finalizing for customer verification. No QR codes charged until you "Go Live".',
        excelInstructions: '<strong>Do not include headers.</strong> Each row becomes a product entry.<br>Enter data in columns as follows:<br><code>A: Product Name</code> <code>B: SKU</code> <code>C: Batch #</code> <code>D: Notes</code>',
        excelPreviewHeaders: ['Product Name', 'SKU', 'Batch #', 'Notes'],
        excelRowLabel: 'products',
        photosLabel: 'Photos (optional)',
        locationDisplayText: 'Location captured!',
        selectorIcon: 'fa-industry'
      },
      food: {
        headerSubtitle: 'Track food products from farm to table with blockchain-verified supply chain transparency.',
        cardTitle: 'New Product / Harvest',
        prodNameLabel: 'Product / Harvest Name *',
        prodNameLabelBatch: 'Harvest Batch Name *',
        prodNamePlaceholder: 'e.g. Organic Strawberries, Free-Range Eggs, Atlantic Salmon',
        prodNamePlaceholderBatch: 'e.g. June 2025 Strawberry Harvest',
        skuPlaceholder: 'e.g. STRW-ORG-001 or leave blank to auto-generate',
        skuTooltipContent: 'SKU (Stock Keeping Unit) is your internal product code for inventory tracking. Examples:<br>‚Ä¢ <code>STRW-ORG-001</code> (Organic Strawberries)<br>‚Ä¢ <code>EGG-FR-DOZ</code> (Free-Range Eggs, Dozen)<br><br><strong>Leave blank</strong> and we\'ll auto-generate one for you!',
        batchNumberLabel: 'Lot / Batch Number',
        batchNumberPlaceholder: 'e.g. LOT-2025-06-15, HARVEST-042',
        batchTooltip2Title: 'What is a Lot/Batch Number?',
        batchTooltip2Content: 'Use this to group products harvested or processed together. Examples:<br>‚Ä¢ Harvest date: <code>LOT-2025-06-15</code><br>‚Ä¢ Processing batch: <code>PROC-042</code><br>‚Ä¢ Farm + date: <code>SMITH-0615</code><br><br>Critical for traceability and recalls!',
        metadataLabel: 'Product Details',
        metadataPlaceholder: 'e.g. Certified Organic, Non-GMO, Farm: Smith Family Farms, Harvest temp: 45¬∞F, Certifications: USDA Organic',
        singleItemHelperText: '<strong>Just need one QR code?</strong> Skip the toggles and fill out the form below. Track a single harvest, shipment, or product with full farm-to-table transparency.',
        batchTooltipContent: 'Have a full harvest or shipment to track? Enable batch mode to either enter a quantity (for identical items from same harvest) or upload an Excel file (for different products with unique lot numbers).',
        batchQuantityLabel: 'How many identical items from this harvest?',
        batchSkuHelp: 'SKUs will be auto-generated (e.g., STRWB-001, STRWB-002, ...)',
        productionTooltipTitle: 'What is Supply Chain Tracking?',
        productionTooltipContent: 'Track your product\'s journey from farm to table! Log each checkpoint:<br><br>üå± <strong>Harvest</strong> ‚Äî Date, farm, conditions<br>üè≠ <strong>Processing</strong> ‚Äî Facility, handling, temp<br>‚ùÑÔ∏è <strong>Cold Storage</strong> ‚Äî Temperature logs<br>üöö <strong>Distribution</strong> ‚Äî Transport, delivery<br>üè™ <strong>Retail</strong> ‚Äî Final destination<br><br>When ready, hit "Go Live" and consumers see the full verified journey.',
        productionSectionDesc: 'Products will start in <strong>supply chain tracking mode</strong>. Log checkpoints (harvest, processing, cold storage, distribution) before finalizing. Consumers will see the complete farm-to-table journey. No QR codes charged until you "Go Live".',
        excelInstructions: '<strong>Do not include headers.</strong> Each row becomes a product entry.<br>Enter data in columns as follows:<br><code>A: Product Name</code> <code>B: SKU/Lot #</code> <code>C: Harvest Date</code> <code>D: Notes/Origin</code>',
        excelPreviewHeaders: ['Product Name', 'SKU/Lot #', 'Harvest Date', 'Notes/Origin'],
        excelRowLabel: 'items',
        photosLabel: 'Photos (optional) ‚Äî harvest, facility, certifications',
        locationDisplayText: 'Farm/facility location captured!',
        selectorIcon: 'fa-seedling'
      }
    };

    // ==========================================
    // INDUSTRY PREFERENCE HANDLING
    // ==========================================
    async function loadIndustryPreference() {
      try {
        const response = await authenticatedFetch('/api/industry-preference');
        const data = await response.json();
        
        if (data.success && data.industryPreference) {
          savedIndustryPreference = data.industryPreference;
          currentIndustry = data.industryPreference;
          document.getElementById('industrySelect').value = currentIndustry;
          document.getElementById('savePreferenceCheckbox').checked = true;
          updateSavePreferenceUI(true);
          applyIndustryContent();
        }
      } catch (error) {
        console.error('Failed to load industry preference:', error);
      }
    }

    function handleIndustryChange() {
      const newIndustry = document.getElementById('industrySelect').value;
      currentIndustry = newIndustry;
      
      // If they change away from saved preference, uncheck the save box
      if (savedIndustryPreference && newIndustry !== savedIndustryPreference) {
        document.getElementById('savePreferenceCheckbox').checked = false;
        updateSavePreferenceUI(false);
      } else if (savedIndustryPreference && newIndustry === savedIndustryPreference) {
        document.getElementById('savePreferenceCheckbox').checked = true;
        updateSavePreferenceUI(true);
      }
      
      applyIndustryContent();
    }

    async function handleSavePreference() {
      const checkbox = document.getElementById('savePreferenceCheckbox');
      const isChecked = checkbox.checked;
      
      if (isChecked) {
        // Save the current selection as preference
        try {
          const response = await authenticatedFetch('/api/industry-preference', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ industryPreference: currentIndustry })
          });
          
          const data = await response.json();
          if (data.success) {
            savedIndustryPreference = currentIndustry;
            updateSavePreferenceUI(true);
          }
        } catch (error) {
          console.error('Failed to save preference:', error);
          checkbox.checked = false;
        }
      } else {
        // Clear the preference (set to general)
        try {
          const response = await authenticatedFetch('/api/industry-preference', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ industryPreference: 'general' })
          });
          
          const data = await response.json();
          if (data.success) {
            savedIndustryPreference = null;
            updateSavePreferenceUI(false);
          }
        } catch (error) {
          console.error('Failed to clear preference:', error);
        }
      }
    }

    function updateSavePreferenceUI(isSaved) {
      const label = document.getElementById('savePreferenceLabel');
      const text = document.getElementById('savePreferenceText');
      
      if (isSaved) {
        label.classList.add('saved');
        text.textContent = 'Saved';
      } else {
        label.classList.remove('saved');
        text.textContent = 'Save';
      }
    }

    function applyIndustryContent() {
      const content = industryContent[currentIndustry];
      const selector = document.getElementById('industrySelector');
      
      // Update selector styling
      if (currentIndustry === 'food') {
        selector.classList.add('food');
      } else {
        selector.classList.remove('food');
      }
      
      // Update header
      document.getElementById('headerSubtitle').textContent = content.headerSubtitle;
      
      // Update card title
      document.getElementById('cardTitle').textContent = content.cardTitle;
      
      // Update form labels and placeholders
      const prodNameLabel = document.getElementById('prodNameLabel');
      const prodNameInput = document.getElementById('dashProdName');
      
      if (isBatchMode) {
        prodNameLabel.textContent = content.prodNameLabelBatch;
        prodNameInput.placeholder = content.prodNamePlaceholderBatch;
      } else {
        prodNameLabel.textContent = content.prodNameLabel;
        prodNameInput.placeholder = content.prodNamePlaceholder;
      }
      
      // SKU
      document.getElementById('dashSku').placeholder = content.skuPlaceholder;
      document.getElementById('skuTooltipContent').innerHTML = content.skuTooltipContent;
      
      // Batch number
      document.getElementById('batchNumberLabel').innerHTML = content.batchNumberLabel + ' <span style="color: #64748B; font-weight: 400;">(optional)</span><span class="info-icon" onclick="toggleTooltip(event, \'batchTooltip2\')"><i class="fas fa-info"></i></span>';
      document.getElementById('dashBatch').placeholder = content.batchNumberPlaceholder;
      document.getElementById('batchTooltip2Title').textContent = content.batchTooltip2Title;
      document.getElementById('batchTooltip2Content').innerHTML = content.batchTooltip2Content;
      
      // Metadata
      document.getElementById('metadataLabel').innerHTML = content.metadataLabel + ' <span style="color: #64748B; font-weight: 400;">(optional)</span>';
      document.getElementById('dashMetadata').placeholder = content.metadataPlaceholder;
      
      // Helper text
      document.getElementById('singleItemHelperText').innerHTML = content.singleItemHelperText;
      
      // Batch section
      document.getElementById('batchTooltipContent').innerHTML = content.batchTooltipContent;
      document.getElementById('batchQuantityLabel').textContent = content.batchQuantityLabel;
      document.getElementById('batchSkuHelp').textContent = content.batchSkuHelp;
      
      // Production mode
      document.getElementById('productionTooltipTitle').textContent = content.productionTooltipTitle;
      document.getElementById('productionTooltipContent').innerHTML = content.productionTooltipContent;
      document.getElementById('productionSectionDesc').innerHTML = content.productionSectionDesc;
      
      // Excel
      document.getElementById('excelInstructions').innerHTML = content.excelInstructions;
      const headerRow = document.getElementById('excelPreviewHeader');
      headerRow.innerHTML = content.excelPreviewHeaders.map(h => `<th>${h}</th>`).join('');
      document.getElementById('excelRowLabel').textContent = content.excelRowLabel;
      
      // Photos
      document.getElementById('photosLabel').textContent = content.photosLabel;
      document.getElementById('locationDisplayText').textContent = content.locationDisplayText;
    }

    // ==========================================
    // TOOLTIPS
    // ==========================================
    function toggleTooltip(event, tooltipId) {
      event.stopPropagation();
      document.querySelectorAll('.info-tooltip').forEach(t => {
        if (t.id !== tooltipId) t.classList.remove('show');
      });
      document.getElementById(tooltipId).classList.toggle('show');
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.info-icon') && !e.target.closest('.info-tooltip')) {
        document.querySelectorAll('.info-tooltip').forEach(t => t.classList.remove('show'));
      }
    });

    // ==========================================
    // TOGGLE MODES
    // ==========================================
    function toggleBatchMode() {
      isBatchMode = !isBatchMode;
      const toggle = document.getElementById('batchToggle');
      const section = document.getElementById('batchSection');
      const toggleText = document.getElementById('batchToggleText');
      const skuInput = document.getElementById('dashSku');
      const skuLabel = document.getElementById('skuLabel');
      const skuBatchOptions = document.getElementById('skuBatchOptions');
      const skuSingleHelp = document.getElementById('skuSingleHelp');
      const content = industryContent[currentIndustry];
      
      if (isBatchMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Batch Upload ‚úì';
        skuInput.disabled = false;
        skuLabel.textContent = 'SKU';
        skuInput.placeholder = 'Leave blank to auto-generate';
        skuBatchOptions.style.display = 'block';
        skuSingleHelp.style.display = 'none';
        document.getElementById('sameSku').checked = false;
        updateSkuHelpText();
        document.getElementById('prodNameLabel').textContent = content.prodNameLabelBatch;
        document.getElementById('dashProdName').placeholder = content.prodNamePlaceholderBatch;
        document.getElementById('remainingQRs').textContent = '(' + (qrLimit - qrUsedThisMonth) + ' available)';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Batch Upload';
        skuInput.disabled = false;
        skuLabel.textContent = 'SKU';
        skuInput.placeholder = content.skuPlaceholder;
        skuBatchOptions.style.display = 'none';
        skuSingleHelp.style.display = 'block';
        document.getElementById('prodNameLabel').textContent = content.prodNameLabel;
        document.getElementById('dashProdName').placeholder = content.prodNamePlaceholder;
        document.getElementById('remainingQRs').textContent = '';
        clearExcelUpload();
      }
      updateMintButtonText();
    }
    
    function updateSkuHelpText() {
      const sameSku = document.getElementById('sameSku').checked;
      const helpText = document.getElementById('skuHelpText');
      if (sameSku) {
        helpText.textContent = 'All items will have the exact same SKU';
      } else {
        helpText.textContent = "If unchecked, we'll add -001, -002, etc. to make each item unique";
      }
    }
    
    document.getElementById('sameSku').addEventListener('change', updateSkuHelpText);

    function toggleProductionMode() {
      isProductionMode = !isProductionMode;
      const toggle = document.getElementById('productionToggle');
      const section = document.getElementById('productionSection');
      const toggleText = document.getElementById('productionToggleText');
      
      if (isProductionMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = currentIndustry === 'food' ? 'Supply Chain Tracking ‚úì' : 'Production Mode ‚úì';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = currentIndustry === 'food' ? 'Supply Chain Tracking' : 'Production Mode';
      }
      updateMintButtonText();
    }

    function updateMintButtonText() {
      const text = document.getElementById('mintButtonText');
      const hasExcel = excelData.length > 0;
      const isFood = currentIndustry === 'food';
      
      if (isProductionMode) {
        if (hasExcel) {
          text.textContent = isFood ? 'Create Supply Chain Entries' : 'Create Production Entries';
        } else if (isBatchMode) {
          text.textContent = isFood ? 'Create Supply Chain Batch' : 'Create Production Batch';
        } else {
          text.textContent = isFood ? 'Create Supply Chain Entry' : 'Create Production Entry';
        }
      } else {
        if (hasExcel) {
          text.textContent = 'Upload & Mint All';
        } else if (isBatchMode) {
          text.textContent = 'Mint Batch to Blockchain';
        } else {
          text.textContent = 'Mint to Blockchain';
        }
      }
    }

    // ==========================================
    // EXCEL HANDLING
    // ==========================================
    const excelInput = document.getElementById('excelInput');
    const excelUploadArea = document.getElementById('excelUploadArea');

    excelInput.addEventListener('change', handleExcelFile);

    excelUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelUploadArea.classList.add('dragover');
    });
    excelUploadArea.addEventListener('dragleave', () => {
      excelUploadArea.classList.remove('dragover');
    });
    excelUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      excelUploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) processExcelFile(file);
    });

    function handleExcelFile(e) {
      const file = e.target.files[0];
      if (file) processExcelFile(file);
    }

    function processExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          excelData = rows.filter(row => row.length > 0 && row[0]);
          
          if (excelData.length === 0) {
            alert('No data found in the spreadsheet.');
            return;
          }

          const remaining = qrLimit - qrUsedThisMonth;
          if (!isProductionMode && excelData.length > remaining) {
            alert(`You have ${remaining} QR codes remaining but are trying to upload ${excelData.length} products. Please upgrade your plan or reduce the number of products.`);
            excelData = [];
            return;
          }

          document.getElementById('excelFileName').textContent = file.name;
          document.getElementById('excelRowCount').textContent = excelData.length;
          
          const tbody = document.getElementById('excelPreviewBody');
          tbody.innerHTML = '';
          
          const previewRows = excelData.slice(0, 5);
          previewRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHtml(row[0] || '')}</td>
              <td>${escapeHtml(row[1] || '')}</td>
              <td>${escapeHtml(row[2] || '')}</td>
              <td>${escapeHtml(row[3] || '')}</td>
            `;
            tbody.appendChild(tr);
          });
          
          if (excelData.length > 5) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" style="text-align:center;color:#64748B;font-style:italic;">...and ${excelData.length - 5} more</td>`;
            tbody.appendChild(tr);
          }

          document.getElementById('excelPreview').style.display = 'block';
          document.getElementById('excelUploadArea').style.display = 'none';
          document.getElementById('batchToggle').style.pointerEvents = 'none';
          document.getElementById('batchToggle').style.opacity = '0.5';
          document.getElementById('dashSku').disabled = true;
          document.getElementById('dashSku').value = '';
          document.getElementById('dashSku').placeholder = 'Provided in Excel';
          document.getElementById('skuBatchOptions').style.display = 'none';
          document.getElementById('dashBatch').disabled = true;
          document.getElementById('dashBatch').placeholder = 'Provided in Excel';
          updateMintButtonText();
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function clearExcelUpload() {
      const content = industryContent[currentIndustry];
      excelData = [];
      document.getElementById('excelInput').value = '';
      document.getElementById('excelPreview').style.display = 'none';
      document.getElementById('excelUploadArea').style.display = 'block';
      document.getElementById('batchToggle').style.pointerEvents = 'auto';
      document.getElementById('batchToggle').style.opacity = '1';
      document.getElementById('dashSku').disabled = false;
      document.getElementById('skuLabel').textContent = 'SKU';
      document.getElementById('dashSku').placeholder = content.skuPlaceholder;
      document.getElementById('skuBatchOptions').style.display = 'block';
      document.getElementById('dashBatch').disabled = false;
      document.getElementById('dashBatch').placeholder = content.batchNumberPlaceholder;
      updateMintButtonText();
    }

    function clearForm() {
      const content = industryContent[currentIndustry];
      document.getElementById('dashProdName').value = '';
      document.getElementById('dashSku').value = '';
      document.getElementById('dashBatch').value = '';
      document.getElementById('dashMetadata').value = '';
      if (document.getElementById('batchQuantity')) {
        document.getElementById('batchQuantity').value = '5';
      }
      selectedPhotos = [];
      document.getElementById('photoPreview').innerHTML = '';
      capturedLocation = null;
      document.getElementById('locationDisplay').style.display = 'none';
      document.getElementById('locationBtnText').textContent = 'Location';
    }

    // ==========================================
    // SUBSCRIPTION & LIMITS
    // ==========================================
    async function loadSubscriptionLimits() {
      try {
        const response = await authenticatedFetch('/api/check-limits');
        const data = await response.json();
        
        if (data.success) {
          qrUsedThisMonth = data.subscription.qrUsed;
          qrLimit = data.subscription.qrLimit;
          currentTier = data.subscription.tier;
          
          document.getElementById('qrUsedCount').textContent = qrUsedThisMonth.toLocaleString();
          document.getElementById('qrLimitCount').textContent = qrLimit.toLocaleString();
          document.getElementById('tierName').textContent = currentTier.charAt(0).toUpperCase() + currentTier.slice(1);
          
          const remaining = qrLimit - qrUsedThisMonth;
          const maxBatch = Math.min(data.subscription.maxBatchSize || 10, remaining);
          document.getElementById('batchQuantity').max = maxBatch;
        }
      } catch (error) {
        console.error('Failed to load limits:', error);
      }
    }

    // ==========================================
    // LOAD PRODUCT COUNTS
    // ==========================================
    async function loadProductCounts() {
      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();
        
        if (data.success && data.products) {
          let finished = 0;
          let production = 0;
          
          data.products.forEach(p => {
            if (p.mode === 'production' && !p.isFinalized) {
              production++;
            } else {
              finished++;
            }
          });
          
          document.getElementById('finishedCount').textContent = finished;
          document.getElementById('productionCount').textContent = production;
        }
      } catch (error) {
        console.error('Failed to load counts:', error);
      }
    }

    // ==========================================
    // PHOTO HANDLING
    // ==========================================
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const MAX = 1200;
            if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
            else if (h > MAX) { w *= MAX / h; h = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('photoInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    document.getElementById('cameraInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    function displayPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      selectedPhotos.forEach((photo, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'position: relative; width: 80px; height: 80px;';
        div.innerHTML = '<img src="' + photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:2px solid #E2E8F0;"/><button onclick="removePhoto(' + i + ')" style="position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#DC2626;color:white;border:none;cursor:pointer;font-size:10px;">‚úï</button>';
        preview.appendChild(div);
      });
    }

    window.removePhoto = (i) => { selectedPhotos.splice(i, 1); displayPhotoPreview(); };

    document.getElementById('captureLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      const btn = document.getElementById('captureLocationBtn');
      btn.disabled = true;
      document.getElementById('locationBtnText').textContent = 'Getting...';
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          capturedLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
          document.getElementById('locationDisplay').style.display = 'block';
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Update';
        },
        (err) => {
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Location';
          alert('Location error: ' + err.message);
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
      );
    });

    // ==========================================
    // MINT / CREATE PRODUCT
    // ==========================================
    document.getElementById('dashCreateBtn').addEventListener('click', async () => {
      const msgEl = document.getElementById('dashMsg');
      const btn = document.getElementById('dashCreateBtn');
      msgEl.innerHTML = '';

      // Excel mode
      if (excelData.length > 0) {
        btn.disabled = true;
        const origText = btn.innerHTML;
        
        const batchGroupId = 'batch-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const totalItems = excelData.length;
        const batchName = document.getElementById('dashProdName').value.trim() || 'Excel Batch Upload';
        const batchNumberFromForm = document.getElementById('dashBatch').value.trim();
        
        const mintingMessage = isProductionMode 
          ? `<div class="message info" style="text-align: left;">
              <i class="fas fa-spinner fa-spin"></i> <strong>Creating ${totalItems} products in ${currentIndustry === 'food' ? 'Supply Chain' : 'Production'} Mode...</strong><br>
              <small style="color: #64748B;">Products will be ready for checkpoint tracking. No blockchain minting until you "Go Live".</small>
            </div>`
          : `<div class="message info" style="text-align: left;">
              <i class="fas fa-spinner fa-spin"></i> <strong>Minting ${totalItems} products to blockchain...</strong><br>
              <small style="color: #64748B;">We're recording each product on IPFS & XRPL for permanent verification. Creating unique QR codes for each item. Please don't refresh the page.</small>
            </div>`;
        msgEl.innerHTML = mintingMessage;
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < excelData.length; i++) {
          const row = excelData[i];
          const productName = String(row[0] || '').trim();
          const sku = String(row[1] || '').trim();
          const batchNumber = String(row[2] || '').trim();
          const notes = String(row[3] || '').trim();
          
          if (!productName || !sku) {
            errorCount++;
            continue;
          }
          
          btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${i + 1} / ${totalItems}...`;
          
          try {
            const response = await fetch('/api/mint-product', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('biztrack-auth-token')
              },
              body: JSON.stringify({
                productName,
                sku,
                batchNumber: batchNumber || batchNumberFromForm,
                metadata: notes ? { notes } : {},
                mode: isProductionMode ? 'production' : 'live',
                isExcelBatch: true,
                excelBatchGroupId: batchGroupId,
                excelBatchTotal: totalItems,
                excelBatchIndex: i + 1,
                excelBatchName: batchName,
                industryType: currentIndustry
              })
            });
            
            const result = await response.json();
            if (response.ok && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (err) {
            errorCount++;
          }
        }
        
        btn.disabled = false;
        btn.innerHTML = origText;
        
        const viewPage = isProductionMode ? 'In Progress' : 'Finished Products';
        const viewLink = isProductionMode ? 'production.html' : 'products.html';
        if (errorCount === 0) {
          msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> Successfully created ${successCount} products as a batch! <a href="${viewLink}" style="color: #065F46; font-weight: 600;">View in ${viewPage} ‚Üí</a></div>`;
        } else {
          msgEl.innerHTML = `<div class="message info"><i class="fas fa-info-circle"></i> Created ${successCount} products. ${errorCount} failed (missing name or SKU). <a href="${viewLink}" style="color: #1E40AF; font-weight: 600;">View in ${viewPage} ‚Üí</a></div>`;
        }
        
        clearExcelUpload();
        clearForm();
        await loadSubscriptionLimits();
        await loadProductCounts();
        return;
      }

      // Manual / Batch mode
      const productName = document.getElementById('dashProdName').value.trim();
      const sku = document.getElementById('dashSku').value.trim();
      const batchNumber = document.getElementById('dashBatch').value.trim();
      const metadata = document.getElementById('dashMetadata').value.trim();
      const batchQuantity = isBatchMode ? parseInt(document.getElementById('batchQuantity').value) : 1;
      
      if (!productName) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Name is required.</div>';
        return;
      }

      btn.disabled = true;
      const origText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Minting...';
      
      const itemCount = isBatchMode ? batchQuantity : 1;
      const mintingMessage = isProductionMode 
        ? `<div class="message info" style="text-align: left;">
            <i class="fas fa-spinner fa-spin"></i> <strong>Creating ${itemCount > 1 ? itemCount + ' products' : 'product'} in ${currentIndustry === 'food' ? 'Supply Chain' : 'Production'} Mode...</strong><br>
            <small style="color: #64748B;">Your product${itemCount > 1 ? 's' : ''} will be ready for checkpoint tracking. No blockchain minting until you "Go Live".</small>
          </div>`
        : `<div class="message info" style="text-align: left;">
            <i class="fas fa-spinner fa-spin"></i> <strong>Minting ${itemCount > 1 ? itemCount + ' products' : 'product'} to blockchain...</strong><br>
            <small style="color: #64748B;">We're permanently recording data on IPFS & the XRP Ledger for customer verification. Creating unique QR codes. Please don't refresh.</small>
          </div>`;
      msgEl.innerHTML = mintingMessage;

      try {
        const token = localStorage.getItem('biztrack-auth-token');
        if (!token) throw new Error('Session expired');

        const response = await fetch('/api/mint-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({
            productName,
            sku: isBatchMode ? (sku || undefined) : sku,
            batchNumber,
            metadata: metadata ? { notes: metadata } : {},
            photos: selectedPhotos.length ? selectedPhotos : null,
            location: capturedLocation,
            isBatchOrder: isBatchMode,
            batchQuantity,
            sameSku: isBatchMode ? document.getElementById('sameSku').checked : false,
            mode: isProductionMode ? 'production' : 'live',
            industryType: currentIndustry
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.details || result.error || 'Minting failed');

        const viewPage = isProductionMode ? 'In Progress' : 'Finished Products';
        const viewLink = isProductionMode ? 'production.html' : 'products.html';
        const successMsg = isProductionMode 
          ? (result.isBatch ? `Batch of ${batchQuantity} created in ${currentIndustry === 'food' ? 'Supply Chain' : 'Production'} Mode!` : `Product created in ${currentIndustry === 'food' ? 'Supply Chain' : 'Production'} Mode!`)
          : (result.isBatch ? `Batch of ${batchQuantity} minted to blockchain!` : 'Product minted to blockchain!');
        msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> ${successMsg} <a href="${viewLink}" style="color: #065F46; font-weight: 600;">View in ${viewPage} ‚Üí</a></div>`;
        
        clearForm();
        await loadSubscriptionLimits();
        await loadProductCounts();
      } catch (err) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> ' + err.message + '</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    });

    // ==========================================
    // HELPERS
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // INIT
    // ==========================================
    loadSubscriptionLimits();
    loadProductCounts();
    loadIndustryPreference();
    applyIndustryContent(); // Apply default content initially
  </script>
</body>
</html>
