<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Products â€“ BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }
    .card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .card h3 i { color: #4F46E5; }

    /* Industry Selector */
    .industry-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      border-radius: 10px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      position: relative;
      transition: all 0.2s;
      height: 52px;
      box-sizing: border-box;
    }
    .industry-selector:hover {
      border-color: #CBD5E1;
      background: white;
    }
    .industry-selector-content {
      display: flex;
      flex-direction: column;
    }
    .industry-selector-title {
      font-size: 0.6rem;
      font-weight: 600;
      color: #64748B;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .industry-selector select {
      border: none;
      background: transparent;
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: #334155;
      cursor: pointer;
      padding: 0;
      margin: 0;
      margin-left: -3px;
      outline: none;
    }
    .industry-selector.food {
      background: #ECFDF5;
      border-color: #10B981;
    }
    .industry-selector.food .industry-selector-title {
      color: #059669;
    }
    .industry-selector.food select {
      color: #065F46;
    }
    
    .save-preference {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.7rem;
      color: #64748B;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      transition: all 0.2s;
      margin-left: auto;
      background: rgba(0,0,0,0.05);
    }
    .save-preference:hover {
      background: rgba(0,0,0,0.08);
      color: #334155;
    }
    .save-preference input {
      width: 12px;
      height: 12px;
      cursor: pointer;
    }
    .save-preference.saved {
      color: #10B981;
      background: rgba(16, 185, 129, 0.1);
    }

    /* Toggle Containers */
    .toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 2px solid #E2E8F0;
      position: relative;
    }
    .toggle-container.production { border-color: #10B981; }
    .toggle-container.excel { border-color: #F59E0B; }
    .toggle-container.rewards { border-color: #F59E0B; background: #FFFBEB; }
    
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: #334155; }
    .toggle-label i { color: #4F46E5; }
    .toggle-label i.production { color: #10B981; }
    .toggle-label i.excel { color: #F59E0B; }
    .toggle-label i.rewards { color: #F59E0B; }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: #CBD5E1;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.active { background: #4F46E5; }
    .toggle-switch.active.production { background: #10B981; }
    .toggle-switch.active.excel { background: #F59E0B; }
    .toggle-switch.active.rewards { background: #F59E0B; }
    .toggle-switch-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .toggle-switch.active .toggle-switch-slider { transform: translateX(28px); }

    /* Info Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: #E2E8F0;
      color: #64748B;
      border-radius: 50%;
      font-size: 0.7rem;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: all 0.2s;
    }
    .info-icon:hover { background: #4F46E5; color: white; }
    
    .info-tooltip {
      display: none;
      position: absolute;
      background: #1E293B;
      color: white;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 400;
      width: 300px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      line-height: 1.5;
      top: 100%;
      left: 0;
      margin-top: 0.5rem;
    }
    .info-tooltip.show { display: block; }
    .info-tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 20px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #1E293B;
    }
    .info-tooltip code {
      background: rgba(255,255,255,0.15);
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
    }

    /* Expandable Sections */
    .expandable-section {
      display: none;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    .expandable-section.show { display: block; }
    .expandable-section.batch { background: #FEF3C7; border: 2px solid #FDE047; }
    .expandable-section.production { background: #ECFDF5; border: 2px solid #10B981; }
    .expandable-section.excel { background: #FEF3C7; border: 2px solid #F59E0B; }
    .expandable-section.rewards { background: #FEF3C7; border: 2px solid #F59E0B; }
    .expandable-section h4 { margin-bottom: 0.75rem; }
    .expandable-section.batch h4 { color: #92400E; }
    .expandable-section.production h4 { color: #065F46; }
    .expandable-section.excel h4 { color: #92400E; }
    .expandable-section.rewards h4 { color: #92400E; }
    .expandable-section p { font-size: 0.9rem; margin-bottom: 0; }
    .expandable-section.batch p { color: #92400E; }
    .expandable-section.production p { color: #047857; }
    .expandable-section.excel p { color: #92400E; }
    .expandable-section.rewards p { color: #92400E; }

    .batch-info { margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.875rem; color: #92400E; }

    /* Rewards Points Input */
    .rewards-points-input {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      padding: 1rem;
      background: white;
      border-radius: 10px;
    }
    .rewards-points-input label {
      font-weight: 600;
      color: #92400E;
      white-space: nowrap;
    }
    .rewards-points-input input {
      width: 100px;
      padding: 0.5rem 0.75rem;
      border: 2px solid #F59E0B;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 700;
      text-align: center;
      color: #92400E;
    }
    .rewards-points-input input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .rewards-points-input span {
      color: #B45309;
      font-size: 0.85rem;
    }

    /* Excel Upload Area */
    .excel-instructions {
      color: #92400E;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    .excel-instructions code {
      background: white;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      font-style: normal;
      color: #B45309;
    }

    .excel-upload-area {
      border: 2px dashed #F59E0B;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .excel-upload-area:hover { background: #FFFBEB; }
    .excel-upload-area.dragover { background: #FEF3C7; border-style: solid; }
    .excel-upload-area i { font-size: 2.5rem; color: #F59E0B; margin-bottom: 0.75rem; }
    .excel-upload-area p { color: #92400E; font-weight: 500; margin-bottom: 0.25rem; }
    .excel-upload-area small { color: #B45309; }

    .excel-preview {
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #E2E8F0;
    }
    .excel-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #F8FAFC;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-header strong { color: #334155; }
    .excel-preview-clear {
      background: none;
      border: none;
      color: #DC2626;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .excel-preview-table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
    }
    .excel-preview-table th, .excel-preview-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-table th { background: #F8FAFC; font-weight: 600; color: #64748B; }
    .excel-preview-table tr:last-child td { border-bottom: none; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #334155; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #F8FAFC;
    }
    .form-group input:disabled, .form-group select:disabled { background: #F1F5F9; color: #94A3B8; cursor: not-allowed; opacity: 0.6; }
    .form-group input:focus:not(:disabled), .form-group textarea:focus, .form-group select:focus:not(:disabled) {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      background: white;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }

    /* Net Quantity Row */
    .net-quantity-row {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }
    .net-quantity-row .form-group {
      margin-bottom: 0;
    }
    .net-quantity-row .form-group:first-child {
      flex: 1;
      max-width: 150px;
    }
    .net-quantity-row .form-group:nth-child(2) {
      flex: 1;
      max-width: 140px;
    }
    .net-quantity-row .form-group:nth-child(2) select {
      padding: 0.875rem 0.75rem;
    }
    .net-quantity-help {
      font-size: 0.8rem;
      color: #64748B;
      margin-top: 0.5rem;
    }
    .net-quantity-help code {
      background: #F1F5F9;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      color: #475569;
    }

    .btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      width: 100%;
      justify-content: center;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      box-shadow: none;
      padding: 0.75rem 1.5rem;
      width: auto;
    }
    .btn-secondary:hover:not(:disabled) { background: #F8FAFC; transform: none; }

    .message { padding: 1rem; border-radius: 12px; margin-top: 1rem; font-weight: 500; display: flex; align-items: flex-start; gap: 0.75rem; }
    .message.success { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
    .message.error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .message.info { background: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; }

    /* Compact Header Bar */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .header-bar h1 {
      font-size: 1.5rem;
      font-weight: 800;
      color: #1E293B;
      margin: 0;
    }
    .header-subtitle {
      font-size: 0.85rem;
      color: #64748B;
      margin: 0 0 1rem 0;
    }
    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    /* Quick Links */
    .quick-links-stacked {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      height: 52px;
      justify-content: center;
    }
    .quick-link-compact {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      background: #F8FAFC;
      border-radius: 6px;
      border: 1px solid #E2E8F0;
      text-decoration: none;
      color: #334155;
      font-weight: 500;
      font-size: 0.7rem;
      transition: all 0.2s;
    }
    .quick-link-compact:hover { border-color: #4F46E5; background: white; }
    .quick-link-compact i { font-size: 0.7rem; color: #4F46E5; }
    .quick-link-compact.production i { color: #10B981; }
    .quick-link-compact.production:hover { border-color: #10B981; }
    .quick-link-count {
      background: #E2E8F0;
      color: #64748B;
      padding: 0.05rem 0.35rem;
      border-radius: 8px;
      font-size: 0.6rem;
      font-weight: 600;
    }
    
    .qr-badge {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: 10px;
      font-size: 0.8rem;
      height: 52px;
      box-sizing: border-box;
    }
    .qr-badge-number {
      font-weight: 800;
      font-size: 1.1rem;
    }
    .qr-badge-label {
      opacity: 0.9;
      font-size: 0.65rem;
    }
    .qr-badge-tier {
      background: rgba(255,255,255,0.2);
      padding: 0.2rem 0.4rem;
      border-radius: 6px;
      font-size: 0.6rem;
      font-weight: 600;
    }

    /* Single item helper text */
    .single-item-helper {
      color: #64748B;
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1rem;
      background: #FFFBEB;
      border-radius: 8px;
      border: 1px solid #FDE68A;
    }
    .single-item-helper i {
      color: #F59E0B;
      margin-right: 0.5rem;
    }

    /* ==========================================
       NUTRITIONAL TABLE LINK & MODAL
    ========================================== */
    .nutrition-link-container {
      margin: 1rem 0;
      padding: 1rem;
      background: #F0FDF4;
      border: 2px solid #BBF7D0;
      border-radius: 12px;
    }
    .nutrition-link {
      color: #059669;
      font-weight: 600;
      text-decoration: underline;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nutrition-link:hover {
      color: #047857;
    }
    .nutrition-link i {
      font-size: 1rem;
    }
    .nutrition-link.has-data {
      color: #059669;
    }
    .nutrition-link.has-data::after {
      content: 'âœ“';
      margin-left: 0.25rem;
      color: #10B981;
    }
    .nutrition-status {
      font-size: 0.85rem;
      color: #047857;
      margin-top: 0.5rem;
    }

    /* Nutrition Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1400;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.show {
      display: flex;
    }
    .nutrition-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 550px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .nutrition-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #E2E8F0;
    }
    .nutrition-modal-header h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1E293B;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nutrition-modal-header h2 i {
      color: #10B981;
    }
    .modal-close {
      background: #F1F5F9;
      border: none;
      font-size: 1.25rem;
      color: #64748B;
      cursor: pointer;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #E2E8F0;
      color: #1E293B;
    }
    .nutrition-modal-body {
      padding: 1.5rem 2rem;
      overflow-y: auto;
      flex: 1;
    }
    .nutrition-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }
    .nutrition-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .nutrition-field.full-width {
      grid-column: 1 / -1;
    }
    .nutrition-field label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #64748B;
      text-transform: uppercase;
    }
    .nutrition-field input {
      padding: 0.6rem 0.75rem;
      border: 2px solid #E2E8F0;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: 'Inter', sans-serif;
    }
    .nutrition-field input:focus {
      outline: none;
      border-color: #10B981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    .nutrition-divider {
      grid-column: 1 / -1;
      border-top: 1px solid #E2E8F0;
      margin: 0.5rem 0;
    }
    .nutrition-section-title {
      grid-column: 1 / -1;
      font-size: 0.75rem;
      font-weight: 700;
      color: #10B981;
      text-transform: uppercase;
      margin-top: 0.5rem;
    }
    .nutrition-modal-footer {
      padding: 1rem 2rem;
      border-top: 2px solid #E2E8F0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .nutrition-modal-footer .btn {
      width: auto;
      padding: 0.75rem 1.5rem;
    }
    .btn-success {
      background: linear-gradient(135deg, #10B981, #059669);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-success:hover:not(:disabled) {
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }
    .btn-outline {
      background: white;
      color: #64748B;
      border: 2px solid #E2E8F0;
      box-shadow: none;
    }
    .btn-outline:hover:not(:disabled) {
      background: #F8FAFC;
      border-color: #CBD5E1;
    }

    @media (max-width: 768px) {
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; padding-top: 5rem; }
      .header-bar { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
      .header-controls { width: 100%; flex-wrap: wrap; gap: 0.5rem; }
      .quick-links-stacked { flex-direction: row; height: auto; }
      .toggle-container { flex-wrap: wrap; gap: 0.75rem; }
      .industry-selector { flex: 1; height: auto; }
      .qr-badge { flex: 1; justify-content: center; height: auto; }
      .rewards-points-input { flex-direction: column; align-items: flex-start; }
      .nutrition-form-grid { grid-template-columns: 1fr; }
      .net-quantity-row { flex-direction: column; align-items: stretch; }
      .net-quantity-row .form-group:first-child,
      .net-quantity-row .form-group:nth-child(2) { max-width: none; }
    }
  </style>
</head>
<body>
  <script src="js/SI-sidebar.js"></script>

  <div class="main-with-sidebar">
    <!-- Compact Header Bar -->
    <div class="header-bar">
      <h1>Create Products</h1>
      <div class="header-controls">
        <!-- Industry Selector -->
        <div class="industry-selector" id="industrySelector">
          <div class="industry-selector-content">
            <span class="industry-selector-title">Industry</span>
            <select id="industrySelect" onchange="handleIndustryChange()">
              <option value="general">General</option>
              <option value="food">Food / Farm to Table</option>
            </select>
          </div>
          <label class="save-preference" id="savePreferenceLabel">
            <input type="checkbox" id="savePreferenceCheckbox" onchange="handleSavePreference()" />
            <span id="savePreferenceText">Save</span>
          </label>
        </div>
        
        <div class="qr-badge">
          <div>
            <div class="qr-badge-number"><span id="qrUsedCount">0</span> <span style="font-size: 0.875rem; font-weight: 400;">/ <span id="qrLimitCount">10</span></span></div>
            <div class="qr-badge-label">QR codes this month</div>
          </div>
          <span class="qr-badge-tier" id="tierName">Free</span>
        </div>
        
        <div class="quick-links-stacked">
          <a href="products.html" class="quick-link-compact">
            <i class="fas fa-box-check"></i>
            <span>Finished</span>
            <span class="quick-link-count" id="finishedCount">-</span>
          </a>
          <a href="production.html" class="quick-link-compact production">
            <i class="fas fa-industry"></i>
            <span>In Progress</span>
            <span class="quick-link-count" id="productionCount">-</span>
          </a>
        </div>
      </div>
    </div>
    <p class="header-subtitle" id="headerSubtitle">Mint products, documents, certificates, or any data to the blockchain for permanent verification.</p>

    <div class="card">
      <h3><i class="fas fa-plus-circle"></i> <span id="cardTitle">New Product</span></h3>
      
      <!-- Batch Toggle -->
      <div class="toggle-container" id="batchToggleContainer">
        <div class="toggle-label">
          <i class="fas fa-layer-group"></i>
          <span id="batchToggleText">Batch Upload</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'batchTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="batchTooltip">
          <strong>What is Batch Upload?</strong><br><br>
          <span id="batchTooltipContent">Have multiple items to mint at once? Enable batch mode to either enter a quantity (for identical items) or upload an Excel file (for different products with unique SKUs).</span>
        </div>
        <div class="toggle-switch" id="batchToggle" onclick="toggleBatchMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Production Mode Toggle -->
      <div class="toggle-container production">
        <div class="toggle-label">
          <i class="fas fa-route production"></i>
          <span id="productionToggleText">Production Mode</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'productionTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="productionTooltip">
          <strong id="productionTooltipTitle">What is Production Mode?</strong><br><br>
          <span id="productionTooltipContent">Does your product have multiple steps before reaching a consumer? Production Mode lets you track each checkpoint in your supply chainâ€”manufacturing, quality checks, shipping, distributionâ€”before going live.<br><br>
          Each stop scans the same QR code to log their part of the journey. When ready, hit "Go Live" and customers see the full verified timeline.</span>
        </div>
        <div class="toggle-switch production" id="productionToggle" onclick="toggleProductionMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Customer Rewards Toggle -->
      <div class="toggle-container rewards" id="rewardsToggleContainer" style="display: none;">
        <div class="toggle-label">
          <i class="fas fa-gift rewards"></i>
          <span>Customer Rewards</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'rewardsTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="rewardsTooltip">
          <strong>What are Customer Rewards?</strong><br><br>
          Let customers earn loyalty points when they scan this product's QR code!
        </div>
        <div class="toggle-switch rewards" id="rewardsToggle" onclick="toggleRewardsMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Rewards Points Section -->
      <div class="expandable-section rewards" id="rewardsSection">
        <h4><i class="fas fa-coins"></i> Reward Points for This Product</h4>
        <p>Customers who scan and claim will earn these points.</p>
        <div class="rewards-points-input">
          <label for="rewardsPoints">Points:</label>
          <input type="number" id="rewardsPoints" value="10" min="1" max="1000" />
          <span>ðŸ’¡ Example: Small=5, Medium=10, Large=15</span>
        </div>
      </div>

      <!-- Single Item Helper Text -->
      <p class="single-item-helper" id="singleItemHelper">
        <i class="fas fa-lightbulb"></i>
        <span id="singleItemHelperText"><strong>Just need one QR code?</strong> Skip the toggles and fill out the form below.</span>
      </p>

      <!-- Batch Section -->
      <div class="expandable-section batch" id="batchSection">
        <h4><i class="fas fa-boxes"></i> <span id="batchSectionTitle">Batch Settings</span></h4>
        
        <div class="form-group">
          <label for="batchQuantity">
            <span id="batchQuantityLabel">How many identical items?</span>
            <span id="remainingQRs" style="color: #059669; font-size: 0.875rem;"></span>
          </label>
          <input id="batchQuantity" type="number" min="1" max="1000" value="5" placeholder="Enter quantity..." />
          <p style="font-size: 0.8rem; color: #92400E; margin-top: 0.5rem;" id="batchSkuHelp">
            SKUs will be auto-generated
          </p>
        </div>

        <div style="display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0;">
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
          <span style="color: #92400E; font-weight: 600; font-size: 0.85rem;" id="batchOrDivider">OR upload Excel</span>
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
        </div>

        <div id="batchExcelInput">
          <p class="excel-instructions" id="excelInstructions">
            <strong>Do not include headers.</strong> Each row becomes a product.<br>
            <code>A: Product Name</code> <code>B: SKU</code> <code>C: Batch #</code> <code>D: Notes</code>
          </p>
          
          <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display: none;" />
          
          <div class="excel-upload-area" id="excelUploadArea" onclick="document.getElementById('excelInput').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag & drop</p>
            <small>.xlsx, .xls, or .csv</small>
          </div>

          <div class="excel-preview" id="excelPreview" style="display: none;">
            <div class="excel-preview-header">
              <strong><i class="fas fa-table"></i> <span id="excelFileName">file.xlsx</span></strong>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                  <span id="excelRowCount">0</span> <span id="excelRowLabel">products</span>
                </span>
                <button class="excel-preview-clear" onclick="clearExcelUpload()"><i class="fas fa-times"></i> Clear</button>
              </div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
              <table class="excel-preview-table">
                <thead>
                  <tr id="excelPreviewHeader">
                    <th>Product Name</th>
                    <th>SKU</th>
                    <th>Batch #</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="excelPreviewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Production Mode Section -->
      <div class="expandable-section production" id="productionSection">
        <h4><i class="fas fa-info-circle"></i> <span id="productionSectionTitle">Production Mode Enabled</span></h4>
        <p id="productionSectionDesc">Products will start in <strong>production tracking mode</strong>. No QR codes charged until you "Go Live".</p>
      </div>

      <!-- Manual Entry Form -->
      <div id="manualEntryForm">
        <div class="form-group">
          <label for="dashProdName" id="prodNameLabel">Name *</label>
          <input id="dashProdName" type="text" placeholder="e.g. Organic Honey, Certificate #1042" />
        </div>

        <!-- ==========================================
             NET QUANTITY FIELDS (FDA REQUIRED - NEW!)
        ========================================== -->
        <div id="netQuantityGroup">
          <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #334155;">
            Net Quantity <span style="color: #64748B; font-weight: 400;">(for labels)</span>
          </label>
          <div class="net-quantity-row">
            <div class="form-group">
              <input id="netQuantityValue" type="number" step="0.01" min="0" placeholder="e.g. 12" />
            </div>
            <div class="form-group">
              <select id="netQuantityUnit">
                <option value="">Select unit</option>
                <optgroup label="Volume (liquids)">
                  <option value="fl oz">fl oz</option>
                  <option value="mL">mL</option>
                  <option value="L">L</option>
                  <option value="gal">gal</option>
                </optgroup>
                <optgroup label="Weight (solids)">
                  <option value="oz">oz</option>
                  <option value="g">g</option>
                  <option value="kg">kg</option>
                  <option value="lb">lb</option>
                </optgroup>
                <optgroup label="Count">
                  <option value="ct">ct (count)</option>
                  <option value="pcs">pcs (pieces)</option>
                </optgroup>
              </select>
            </div>
          </div>
          <p class="net-quantity-help">
            <i class="fas fa-info-circle" style="color: #64748B;"></i>
            FDA requires this on labels. Example: <code>Net 12 fl oz (355 mL)</code>
          </p>
        </div>
        
        <div class="form-group" id="skuGroup">
          <label for="dashSku" id="skuLabel">
            SKU <span style="color: #64748B; font-weight: 400;">(optional)</span>
          </label>
          <input id="dashSku" type="text" placeholder="e.g. MANGO-001 or leave blank" />
          <p id="skuSingleHelp" style="font-size: 0.8rem; color: #64748B; margin-top: 0.25rem;">
            Encoded in your inventory barcode
          </p>
          <div id="skuBatchOptions" style="display: none; margin-top: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; font-size: 0.875rem; color: #475569; cursor: pointer;">
              <input type="checkbox" id="sameSku" style="width: 16px; height: 16px; cursor: pointer;" />
              <span id="sameSkuLabel">Give all items the same SKU</span>
            </label>
          </div>
        </div>
        
        <div class="form-group">
          <label for="dashBatch" id="batchNumberLabel">
            Batch Number <span style="color: #64748B; font-weight: 400;">(optional)</span>
          </label>
          <input id="dashBatch" type="text" placeholder="e.g. 120524, BATCH-001" />
        </div>
        
        <div class="form-group">
          <label for="dashMetadata" id="metadataLabel">
            Additional Info <span style="color: #64748B; font-weight: 400;">(optional)</span>
          </label>
          <textarea id="dashMetadata" placeholder="e.g. Made with real fruit, Ingredients: lemon, sugar, water" rows="3"></textarea>
        </div>

        <!-- ==========================================
             NUTRITIONAL TABLE LINK
        ========================================== -->
        <div class="nutrition-link-container" id="nutritionLinkContainer">
          <span class="nutrition-link" id="nutritionLink" onclick="openNutritionModal()">
            <i class="fas fa-clipboard-list"></i>
            <span id="nutritionLinkText">Need a nutritional table? Click here</span>
          </span>
          <p class="nutrition-status" id="nutritionStatus" style="display: none;">
            <i class="fas fa-check-circle"></i> Nutritional data saved â€” will appear on customer verification page
          </p>
        </div>

        <div class="form-group">
          <label id="photosLabel">Photos (optional)</label>
          <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" />
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
              <i class="fas fa-camera"></i> Take Photo
            </button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
              <i class="fas fa-images"></i> Gallery
            </button>
            <button type="button" class="btn btn-secondary" id="captureLocationBtn">
              <i class="fas fa-map-marker-alt"></i> <span id="locationBtnText">Location</span>
            </button>
          </div>
          <div id="photoPreview" style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;"></div>
          <p id="locationDisplay" style="margin-top: 0.75rem; color: #10B981; font-size: 0.875rem; display: none;">
            <i class="fas fa-check-circle"></i> <span id="locationDisplayText">Location captured!</span>
          </p>
        </div>
      </div>
      
      <button class="btn" id="dashCreateBtn">
        <i class="fas fa-rocket"></i>
        <span id="mintButtonText">Mint to Blockchain</span>
      </button>
      
      <div id="dashMsg"></div>
    </div>
  </div>

  <!-- ==========================================
       NUTRITIONAL TABLE MODAL
  ========================================== -->
  <div class="modal-overlay" id="nutritionModalOverlay" onclick="closeNutritionModal(event)">
    <div class="nutrition-modal" onclick="event.stopPropagation()">
      <div class="nutrition-modal-header">
        <h2><i class="fas fa-clipboard-list"></i> Nutrition Facts</h2>
        <button class="modal-close" onclick="closeNutritionModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="nutrition-modal-body">
        <p style="color: #64748B; font-size: 0.9rem; margin-bottom: 1rem;">
          Fill out the FDA-style nutrition facts. This will be displayed when customers scan your product's QR code.
        </p>
        <div class="nutrition-form-grid">
          <div class="nutrition-field full-width">
            <label>Serving Size *</label>
            <input type="text" id="nf_servingSize" placeholder="e.g., 1 bottle (240ml), 1 cup (30g)" />
          </div>
          <div class="nutrition-field">
            <label>Servings Per Container</label>
            <input type="text" id="nf_servingsPerContainer" placeholder="e.g., 1, 2, About 8" />
          </div>
          <div class="nutrition-field">
            <label>Calories *</label>
            <input type="text" id="nf_calories" placeholder="e.g., 120" />
          </div>
          
          <div class="nutrition-section-title">Fats</div>
          <div class="nutrition-field">
            <label>Total Fat (g)</label>
            <input type="text" id="nf_totalFat" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Saturated Fat (g)</label>
            <input type="text" id="nf_saturatedFat" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Trans Fat (g)</label>
            <input type="text" id="nf_transFat" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Cholesterol (mg)</label>
            <input type="text" id="nf_cholesterol" placeholder="0" />
          </div>
          
          <div class="nutrition-section-title">Carbohydrates</div>
          <div class="nutrition-field">
            <label>Sodium (mg)</label>
            <input type="text" id="nf_sodium" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Total Carbohydrates (g)</label>
            <input type="text" id="nf_totalCarbs" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Dietary Fiber (g)</label>
            <input type="text" id="nf_fiber" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Total Sugars (g)</label>
            <input type="text" id="nf_sugars" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Added Sugars (g)</label>
            <input type="text" id="nf_addedSugars" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Protein (g)</label>
            <input type="text" id="nf_protein" placeholder="0" />
          </div>
          
          <div class="nutrition-section-title">Vitamins & Minerals</div>
          <div class="nutrition-field">
            <label>Vitamin D (mcg)</label>
            <input type="text" id="nf_vitaminD" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Calcium (mg)</label>
            <input type="text" id="nf_calcium" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Iron (mg)</label>
            <input type="text" id="nf_iron" placeholder="0" />
          </div>
          <div class="nutrition-field">
            <label>Potassium (mg)</label>
            <input type="text" id="nf_potassium" placeholder="0" />
          </div>
          <div class="nutrition-field full-width">
            <label>Ingredients List *</label>
            <input type="text" id="nf_ingredients" placeholder="e.g., Water, Lemon Juice, Cane Sugar, Natural Flavors" />
            <p style="font-size: 0.75rem; color: #64748B; margin-top: 0.25rem;">
              <i class="fas fa-info-circle"></i> <strong>FDA requires:</strong> List ingredients in order from <strong>most</strong> to <strong>least</strong> by weight
            </p>
          </div>
        </div>
      </div>
      <div class="nutrition-modal-footer">
        <button class="btn btn-outline" onclick="clearNutritionForm()">
          <i class="fas fa-eraser"></i> Clear All
        </button>
        <div style="display: flex; gap: 0.75rem;">
          <button class="btn btn-outline" onclick="closeNutritionModal()">Cancel</button>
          <button class="btn btn-success" onclick="saveNutrition()">
            <i class="fas fa-save"></i> Save Nutrition Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let isBatchMode = false;
    let isProductionMode = false;
    let isRewardsMode = false;
    let rewardsEnabled = false;
    let selectedPhotos = [];
    let capturedLocation = null;
    let qrUsedThisMonth = 0;
    let qrLimit = 10;
    let currentTier = 'free';
    let excelData = [];
    let currentIndustry = 'general';
    let savedIndustryPreference = null;
    
    // ==========================================
    // NUTRITIONAL DATA STATE
    // ==========================================
    let nutritionData = null;

    // ==========================================
    // NUTRITION MODAL FUNCTIONS
    // ==========================================
    function openNutritionModal() {
      if (nutritionData) {
        loadNutritionForm(nutritionData);
      }
      document.getElementById('nutritionModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeNutritionModal(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('nutritionModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
    }

    function getNutritionFormData() {
      return {
        servingSize: document.getElementById('nf_servingSize').value.trim(),
        servingsPerContainer: document.getElementById('nf_servingsPerContainer').value.trim(),
        calories: document.getElementById('nf_calories').value.trim(),
        totalFat: document.getElementById('nf_totalFat').value.trim(),
        saturatedFat: document.getElementById('nf_saturatedFat').value.trim(),
        transFat: document.getElementById('nf_transFat').value.trim(),
        cholesterol: document.getElementById('nf_cholesterol').value.trim(),
        sodium: document.getElementById('nf_sodium').value.trim(),
        totalCarbs: document.getElementById('nf_totalCarbs').value.trim(),
        fiber: document.getElementById('nf_fiber').value.trim(),
        sugars: document.getElementById('nf_sugars').value.trim(),
        addedSugars: document.getElementById('nf_addedSugars').value.trim(),
        protein: document.getElementById('nf_protein').value.trim(),
        vitaminD: document.getElementById('nf_vitaminD').value.trim(),
        calcium: document.getElementById('nf_calcium').value.trim(),
        iron: document.getElementById('nf_iron').value.trim(),
        potassium: document.getElementById('nf_potassium').value.trim(),
        ingredients: document.getElementById('nf_ingredients').value.trim()
      };
    }

    function loadNutritionForm(data) {
      document.getElementById('nf_servingSize').value = data.servingSize || '';
      document.getElementById('nf_servingsPerContainer').value = data.servingsPerContainer || '';
      document.getElementById('nf_calories').value = data.calories || '';
      document.getElementById('nf_totalFat').value = data.totalFat || '';
      document.getElementById('nf_saturatedFat').value = data.saturatedFat || '';
      document.getElementById('nf_transFat').value = data.transFat || '';
      document.getElementById('nf_cholesterol').value = data.cholesterol || '';
      document.getElementById('nf_sodium').value = data.sodium || '';
      document.getElementById('nf_totalCarbs').value = data.totalCarbs || '';
      document.getElementById('nf_fiber').value = data.fiber || '';
      document.getElementById('nf_sugars').value = data.sugars || '';
      document.getElementById('nf_addedSugars').value = data.addedSugars || '';
      document.getElementById('nf_protein').value = data.protein || '';
      document.getElementById('nf_vitaminD').value = data.vitaminD || '';
      document.getElementById('nf_calcium').value = data.calcium || '';
      document.getElementById('nf_iron').value = data.iron || '';
      document.getElementById('nf_potassium').value = data.potassium || '';
      document.getElementById('nf_ingredients').value = data.ingredients || '';
    }

    function clearNutritionForm() {
      document.querySelectorAll('.nutrition-modal-body input').forEach(input => input.value = '');
    }

    function saveNutrition() {
      const data = getNutritionFormData();
      
      // Check required fields: serving size, calories, and ingredients
      if (!data.servingSize) {
        alert('Please fill in Serving Size');
        document.getElementById('nf_servingSize').focus();
        return;
      }
      if (!data.calories) {
        alert('Please fill in Calories');
        document.getElementById('nf_calories').focus();
        return;
      }
      if (!data.ingredients) {
        alert('Please fill in Ingredients List (required by FDA)');
        document.getElementById('nf_ingredients').focus();
        return;
      }
      
      nutritionData = data;
      
      const link = document.getElementById('nutritionLink');
      const linkText = document.getElementById('nutritionLinkText');
      const status = document.getElementById('nutritionStatus');
      
      link.classList.add('has-data');
      linkText.textContent = 'Nutritional Table (click to edit)';
      status.style.display = 'block';
      
      closeNutritionModal();
    }

    function resetNutritionUI() {
      nutritionData = null;
      const link = document.getElementById('nutritionLink');
      const linkText = document.getElementById('nutritionLinkText');
      const status = document.getElementById('nutritionStatus');
      
      link.classList.remove('has-data');
      linkText.textContent = 'Need a nutritional table? Click here';
      status.style.display = 'none';
      clearNutritionForm();
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeNutritionModal();
      }
    });

    // ==========================================
    // INDUSTRY-SPECIFIC CONTENT
    // ==========================================
    const industryContent = {
      general: {
        headerSubtitle: 'Mint products, documents, certificates, or any data to the blockchain for permanent verification.',
        cardTitle: 'New Product',
        prodNameLabel: 'Name *',
        prodNamePlaceholder: 'e.g. Organic Honey, Certificate #1042, Event Ticket',
        showNetQuantity: false
      },
      food: {
        headerSubtitle: 'Track food products from farm to table with blockchain-verified supply chain transparency.',
        cardTitle: 'New Product / Harvest',
        prodNameLabel: 'Product / Harvest Name *',
        prodNamePlaceholder: 'e.g. Organic Strawberries, Free-Range Eggs',
        showNetQuantity: true
      }
    };

    // ==========================================
    // TOOLTIPS
    // ==========================================
    function toggleTooltip(event, tooltipId) {
      event.stopPropagation();
      document.querySelectorAll('.info-tooltip').forEach(t => {
        if (t.id !== tooltipId) t.classList.remove('show');
      });
      document.getElementById(tooltipId).classList.toggle('show');
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.info-icon') && !e.target.closest('.info-tooltip')) {
        document.querySelectorAll('.info-tooltip').forEach(t => t.classList.remove('show'));
      }
    });

    // ==========================================
    // TOGGLE MODES
    // ==========================================
    function toggleBatchMode() {
      isBatchMode = !isBatchMode;
      const toggle = document.getElementById('batchToggle');
      const section = document.getElementById('batchSection');
      const toggleText = document.getElementById('batchToggleText');
      
      if (isBatchMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Batch Upload âœ“';
        document.getElementById('skuBatchOptions').style.display = 'block';
        document.getElementById('skuSingleHelp').style.display = 'none';
        document.getElementById('remainingQRs').textContent = '(' + (qrLimit - qrUsedThisMonth) + ' available)';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Batch Upload';
        document.getElementById('skuBatchOptions').style.display = 'none';
        document.getElementById('skuSingleHelp').style.display = 'block';
        document.getElementById('remainingQRs').textContent = '';
        clearExcelUpload();
      }
      updateMintButtonText();
    }

    function toggleProductionMode() {
      isProductionMode = !isProductionMode;
      const toggle = document.getElementById('productionToggle');
      const section = document.getElementById('productionSection');
      const toggleText = document.getElementById('productionToggleText');
      
      if (isProductionMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Production Mode âœ“';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Production Mode';
      }
      updateMintButtonText();
    }

    function toggleRewardsMode() {
      isRewardsMode = !isRewardsMode;
      const toggle = document.getElementById('rewardsToggle');
      const section = document.getElementById('rewardsSection');
      
      if (isRewardsMode) {
        toggle.classList.add('active');
        section.classList.add('show');
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
      }
    }

    function updateMintButtonText() {
      const text = document.getElementById('mintButtonText');
      const hasExcel = excelData.length > 0;
      
      if (isProductionMode) {
        if (hasExcel) text.textContent = 'Create Production Entries';
        else if (isBatchMode) text.textContent = 'Create Production Batch';
        else text.textContent = 'Create Production Entry';
      } else {
        if (hasExcel) text.textContent = 'Upload & Mint All';
        else if (isBatchMode) text.textContent = 'Mint Batch to Blockchain';
        else text.textContent = 'Mint to Blockchain';
      }
    }

    // ==========================================
    // INDUSTRY HANDLING
    // ==========================================
    async function loadIndustryPreference() {
      try {
        const response = await authenticatedFetch('/api/industry-preference');
        const data = await response.json();
        if (data.success && data.industryPreference) {
          savedIndustryPreference = data.industryPreference;
          currentIndustry = data.industryPreference;
          document.getElementById('industrySelect').value = currentIndustry;
          document.getElementById('savePreferenceCheckbox').checked = true;
          updateSavePreferenceUI(true);
          applyIndustryContent();
        }
      } catch (error) {
        console.error('Failed to load industry preference:', error);
      }
    }

    function handleIndustryChange() {
      currentIndustry = document.getElementById('industrySelect').value;
      if (currentIndustry === 'food') {
        document.getElementById('industrySelector').classList.add('food');
      } else {
        document.getElementById('industrySelector').classList.remove('food');
      }
      applyIndustryContent();
    }

    async function handleSavePreference() {
      const checkbox = document.getElementById('savePreferenceCheckbox');
      try {
        await authenticatedFetch('/api/industry-preference', {
          method: 'POST',
          body: JSON.stringify({ industryPreference: checkbox.checked ? currentIndustry : 'general' })
        });
        savedIndustryPreference = checkbox.checked ? currentIndustry : null;
        updateSavePreferenceUI(checkbox.checked);
      } catch (error) {
        console.error('Failed to save preference:', error);
      }
    }

    function updateSavePreferenceUI(isSaved) {
      const label = document.getElementById('savePreferenceLabel');
      const text = document.getElementById('savePreferenceText');
      if (isSaved) { label.classList.add('saved'); text.textContent = 'Saved'; }
      else { label.classList.remove('saved'); text.textContent = 'Save'; }
    }

    function applyIndustryContent() {
      const content = industryContent[currentIndustry];
      document.getElementById('headerSubtitle').textContent = content.headerSubtitle;
      document.getElementById('cardTitle').textContent = content.cardTitle;
      document.getElementById('prodNameLabel').textContent = content.prodNameLabel;
      document.getElementById('dashProdName').placeholder = content.prodNamePlaceholder;
      
      // Show/hide net quantity based on industry
      const netQuantityGroup = document.getElementById('netQuantityGroup');
      if (content.showNetQuantity) {
        netQuantityGroup.style.display = 'block';
      } else {
        netQuantityGroup.style.display = 'none';
      }
    }

    // ==========================================
    // EXCEL HANDLING
    // ==========================================
    const excelInput = document.getElementById('excelInput');
    const excelUploadArea = document.getElementById('excelUploadArea');

    excelInput.addEventListener('change', handleExcelFile);
    excelUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); excelUploadArea.classList.add('dragover'); });
    excelUploadArea.addEventListener('dragleave', () => { excelUploadArea.classList.remove('dragover'); });
    excelUploadArea.addEventListener('drop', (e) => { e.preventDefault(); excelUploadArea.classList.remove('dragover'); if (e.dataTransfer.files[0]) processExcelFile(e.dataTransfer.files[0]); });

    function handleExcelFile(e) { if (e.target.files[0]) processExcelFile(e.target.files[0]); }

    function processExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          excelData = rows.filter(row => row.length > 0 && row[0]);
          
          if (excelData.length === 0) { alert('No data found'); return; }
          const remaining = qrLimit - qrUsedThisMonth;
          if (!isProductionMode && excelData.length > remaining) {
            alert(`You have ${remaining} QR codes remaining but are trying to upload ${excelData.length} products.`);
            excelData = [];
            return;
          }

          document.getElementById('excelFileName').textContent = file.name;
          document.getElementById('excelRowCount').textContent = excelData.length;
          
          const tbody = document.getElementById('excelPreviewBody');
          tbody.innerHTML = '';
          excelData.slice(0, 5).forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${escapeHtml(row[0]||'')}</td><td>${escapeHtml(row[1]||'')}</td><td>${escapeHtml(row[2]||'')}</td><td>${escapeHtml(row[3]||'')}</td>`;
            tbody.appendChild(tr);
          });
          if (excelData.length > 5) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" style="text-align:center;color:#64748B;font-style:italic;">...and ${excelData.length - 5} more</td>`;
            tbody.appendChild(tr);
          }

          document.getElementById('excelPreview').style.display = 'block';
          document.getElementById('excelUploadArea').style.display = 'none';
          document.getElementById('dashSku').disabled = true;
          document.getElementById('dashBatch').disabled = true;
          updateMintButtonText();
        } catch (err) { alert('Error reading file: ' + err.message); }
      };
      reader.readAsArrayBuffer(file);
    }

    function clearExcelUpload() {
      excelData = [];
      document.getElementById('excelInput').value = '';
      document.getElementById('excelPreview').style.display = 'none';
      document.getElementById('excelUploadArea').style.display = 'block';
      document.getElementById('dashSku').disabled = false;
      document.getElementById('dashBatch').disabled = false;
      updateMintButtonText();
    }

    // ==========================================
    // SUBSCRIPTION & LIMITS
    // ==========================================
    async function loadSubscriptionLimits() {
      try {
        const response = await authenticatedFetch('/api/check-limits');
        const data = await response.json();
        if (data.success) {
          qrUsedThisMonth = data.subscription.qrUsed;
          qrLimit = data.subscription.qrLimit;
          currentTier = data.subscription.tier;
          document.getElementById('qrUsedCount').textContent = qrUsedThisMonth.toLocaleString();
          document.getElementById('qrLimitCount').textContent = qrLimit.toLocaleString();
          document.getElementById('tierName').textContent = currentTier.charAt(0).toUpperCase() + currentTier.slice(1);
         document.getElementById('batchQuantity').max = qrLimit - qrUsedThisMonth;
        }
      } catch (error) { console.error('Failed to load limits:', error); }
    }

    async function loadProductCounts() {
      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();
        if (data.success && data.products) {
          let finished = 0, production = 0;
          data.products.forEach(p => {
            if (p.mode === 'production' && !p.isFinalized) production++;
            else finished++;
          });
          document.getElementById('finishedCount').textContent = finished;
          document.getElementById('productionCount').textContent = production;
        }
      } catch (error) { console.error('Failed to load counts:', error); }
    }

    async function loadRewardsSettings() {
      try {
        const response = await authenticatedFetch('/api/rewards-settings');
        const data = await response.json();
        if (data.success && data.settings?.rewardsEnabled) {
          rewardsEnabled = true;
          document.getElementById('rewardsToggleContainer').style.display = 'flex';
          document.getElementById('rewardsPoints').value = data.settings.pointsPerClaim || 10;
        }
      } catch (error) { console.error('Failed to load rewards settings:', error); }
    }

    // ==========================================
    // PHOTO HANDLING
    // ==========================================
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const MAX = 1200;
            if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
            else if (h > MAX) { w *= MAX / h; h = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('photoInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    document.getElementById('cameraInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    function displayPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      selectedPhotos.forEach((photo, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'position: relative; width: 80px; height: 80px;';
        div.innerHTML = '<img src="' + photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:2px solid #E2E8F0;"/><button onclick="removePhoto(' + i + ')" style="position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#DC2626;color:white;border:none;cursor:pointer;font-size:10px;">âœ•</button>';
        preview.appendChild(div);
      });
    }

    window.removePhoto = (i) => { selectedPhotos.splice(i, 1); displayPhotoPreview(); };

    document.getElementById('captureLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      const btn = document.getElementById('captureLocationBtn');
      btn.disabled = true;
      document.getElementById('locationBtnText').textContent = 'Getting...';
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          capturedLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
          document.getElementById('locationDisplay').style.display = 'block';
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Update';
        },
        (err) => { btn.disabled = false; document.getElementById('locationBtnText').textContent = 'Location'; alert('Location error: ' + err.message); },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
      );
    });

    function clearForm() {
      document.getElementById('dashProdName').value = '';
      document.getElementById('dashSku').value = '';
      document.getElementById('dashBatch').value = '';
      document.getElementById('dashMetadata').value = '';
      document.getElementById('batchQuantity').value = '5';
      document.getElementById('netQuantityValue').value = '';
      document.getElementById('netQuantityUnit').value = '';
      selectedPhotos = [];
      document.getElementById('photoPreview').innerHTML = '';
      capturedLocation = null;
      document.getElementById('locationDisplay').style.display = 'none';
      document.getElementById('locationBtnText').textContent = 'Location';
      resetNutritionUI();
    }

    // ==========================================
    // MINT / CREATE PRODUCT
    // ==========================================
    document.getElementById('dashCreateBtn').addEventListener('click', async () => {
      const msgEl = document.getElementById('dashMsg');
      const btn = document.getElementById('dashCreateBtn');
      msgEl.innerHTML = '';

      const rewardsPoints = isRewardsMode ? parseInt(document.getElementById('rewardsPoints').value) || 10 : null;
      
      // Get net quantity data
      const netQuantityValue = document.getElementById('netQuantityValue').value.trim();
      const netQuantityUnit = document.getElementById('netQuantityUnit').value;
      let netQuantity = null;
      if (netQuantityValue && netQuantityUnit) {
        netQuantity = {
          value: parseFloat(netQuantityValue),
          unit: netQuantityUnit,
          display: `${netQuantityValue} ${netQuantityUnit}`
        };
      }

      // Excel mode
      if (excelData.length > 0) {
        btn.disabled = true;
        const origText = btn.innerHTML;
        const batchGroupId = 'batch-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        const totalItems = excelData.length;
        const batchName = document.getElementById('dashProdName').value.trim() || 'Excel Batch Upload';
        
        msgEl.innerHTML = `<div class="message info"><i class="fas fa-spinner fa-spin"></i> Creating ${totalItems} products...</div>`;
        
        let successCount = 0, errorCount = 0;
        
        for (let i = 0; i < excelData.length; i++) {
          const row = excelData[i];
          const productName = String(row[0] || '').trim();
          const sku = String(row[1] || '').trim();
          const batchNumber = String(row[2] || '').trim();
          const notes = String(row[3] || '').trim();
          
          if (!productName || !sku) { errorCount++; continue; }
          
          btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${i + 1} / ${totalItems}...`;
          
          try {
            const metadata = notes ? { notes } : {};
            if (nutritionData) {
              metadata.nutritionFacts = nutritionData;
            }
            if (netQuantity) {
              metadata.netQuantity = netQuantity;
            }
            
            const response = await fetch('/api/mint-product', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + localStorage.getItem('biztrack-auth-token') },
              body: JSON.stringify({
                productName, sku, batchNumber,
                metadata,
                mode: isProductionMode ? 'production' : 'live',
                isExcelBatch: true,
                excelBatchGroupId: batchGroupId,
                excelBatchTotal: totalItems,
                excelBatchIndex: i + 1,
                excelBatchName: batchName,
                industryType: currentIndustry,
                rewardsPoints
              })
            });
            
            const result = await response.json();
            if (response.ok && result.success) successCount++;
            else errorCount++;
          } catch (err) { errorCount++; }
        }
        
        btn.disabled = false;
        btn.innerHTML = origText;
        
        const viewPage = isProductionMode ? 'In Progress' : 'Finished Products';
        const viewLink = isProductionMode ? 'production.html' : 'products.html';
        if (errorCount === 0) {
          msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> Successfully created ${successCount} products! <a href="${viewLink}" style="color: #065F46; font-weight: 600;">View in ${viewPage} â†’</a></div>`;
        } else {
          msgEl.innerHTML = `<div class="message info"><i class="fas fa-info-circle"></i> Created ${successCount} products. ${errorCount} failed. <a href="${viewLink}" style="color: #1E40AF; font-weight: 600;">View in ${viewPage} â†’</a></div>`;
        }
        
        clearExcelUpload();
        clearForm();
        await loadSubscriptionLimits();
        await loadProductCounts();
        return;
      }

      // Manual / Batch mode
      const productName = document.getElementById('dashProdName').value.trim();
      const sku = document.getElementById('dashSku').value.trim();
      const batchNumber = document.getElementById('dashBatch').value.trim();
      const metadataNotes = document.getElementById('dashMetadata').value.trim();
      const batchQuantity = isBatchMode ? parseInt(document.getElementById('batchQuantity').value) : 1;
      
      if (!productName) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Name is required.</div>';
        return;
      }

      btn.disabled = true;
      const origText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Minting...';
      
      const itemCount = isBatchMode ? batchQuantity : 1;
      msgEl.innerHTML = `<div class="message info"><i class="fas fa-spinner fa-spin"></i> Creating ${itemCount > 1 ? itemCount + ' products' : 'product'}...</div>`;

      try {
        const token = localStorage.getItem('biztrack-auth-token');
        if (!token) throw new Error('Session expired');

        // Build metadata with nutrition and net quantity
        const metadata = {};
        if (metadataNotes) {
          metadata.notes = metadataNotes;
        }
        if (nutritionData) {
          metadata.nutritionFacts = nutritionData;
          console.log('[NUTRITION] Including nutrition facts in product:', nutritionData);
        }
        if (netQuantity) {
          metadata.netQuantity = netQuantity;
          console.log('[NET QUANTITY] Including net quantity in product:', netQuantity);
        }

        const response = await fetch('/api/mint-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({
            productName,
            sku: isBatchMode ? (sku || undefined) : sku,
            batchNumber,
            metadata: Object.keys(metadata).length > 0 ? metadata : {},
            photos: selectedPhotos.length ? selectedPhotos : null,
            location: capturedLocation,
            isBatchOrder: isBatchMode,
            batchQuantity,
            sameSku: isBatchMode ? document.getElementById('sameSku').checked : false,
            mode: isProductionMode ? 'production' : 'live',
            industryType: currentIndustry,
            rewardsPoints
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.details || result.error || 'Minting failed');

        const viewPage = isProductionMode ? 'In Progress' : 'Finished Products';
        const viewLink = isProductionMode ? 'production.html' : 'products.html';
        const successMsg = result.isBatch ? `Batch of ${batchQuantity} created!` : 'Product created!';
        
        const nutritionNote = nutritionData ? ' Nutrition facts included.' : '';
        const netQtyNote = netQuantity ? ` Net quantity: ${netQuantity.display}.` : '';
        msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> ${successMsg}${nutritionNote}${netQtyNote} <a href="${viewLink}" style="color: #065F46; font-weight: 600;">View in ${viewPage} â†’</a></div>`;
        
        clearForm();
        await loadSubscriptionLimits();
        await loadProductCounts();
      } catch (err) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> ' + err.message + '</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    });

    // ==========================================
    // HELPERS
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // INIT
    // ==========================================
    loadSubscriptionLimits();
    loadProductCounts();
    loadIndustryPreference();
    loadRewardsSettings();
    applyIndustryContent();
  </script>
</body>
</html>
