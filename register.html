<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      position: relative;
    }

    .back-home {
      position: fixed;
      top: 2rem;
      left: 2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.75rem 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.2s;
      z-index: 100;
    }

    .back-home:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-3px);
    }

    .back-home i {
      font-size: 1.125rem;
    }

    .register-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 3rem;
      width: 100%;
      max-width: 450px;
    }

    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }

    .logo h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: #1E293B;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .logo-emoji {
      font-size: 2.5rem;
    }

    h1 {
      font-size: 2rem;
      font-weight: 800;
      color: #1E293B;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #64748B;
      margin-bottom: 2rem;
    }

    .plan-badge {
      background: rgba(59, 130, 246, 0.15);
      color: #1e40af;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 600;
      border: 1px solid rgba(59, 130, 246, 0.3);
      font-size: 0.95rem;
    }

    .plan-badge i {
      margin-right: 0.5rem;
      color: #3b82f6;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #334155;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background-color: white;
    }

    .form-group select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23334155' d='M10.293 3.293L6 7.586 1.707 3.293A1 1 0 00.293 4.707l5 5a1 1 0 001.414 0l5-5a1 1 0 10-1.414-1.414z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
    }

    .business-type-info {
      font-size: 0.875rem;
      color: #64748B;
      margin-top: 0.5rem;
      display: flex;
      align-items: start;
      gap: 0.5rem;
    }

    .business-type-info i {
      margin-top: 0.125rem;
      color: #4F46E5;
    }

    .password-requirements {
      font-size: 0.875rem;
      color: #64748B;
      margin-top: 0.5rem;
    }

    .btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      opacity: 1;
      cursor: not-allowed;
    }

    .message {
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      font-weight: 500;
      display: none;
    }

    .message.show {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .message.error {
      background: #FEE2E2;
      color: #DC2626;
      border: 1px solid #FCA5A5;
    }

    .message.success {
      background: #D1FAE5;
      color: #059669;
      border: 1px solid #6EE7B7;
    }

    .message.info {
      background: #DBEAFE;
      color: #1D4ED8;
      border: 1px solid #93C5FD;
    }

    .links {
      text-align: center;
      margin-top: 1.5rem;
      color: #64748B;
    }

    .links a {
      color: #4F46E5;
      text-decoration: none;
      font-weight: 600;
    }

    .links a:hover {
      text-decoration: underline;
    }

    @media (max-width: 500px) {
      .back-home {
        top: 1rem;
        left: 1rem;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
      }

      .register-container {
        padding: 2rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      .logo h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-home">
    <i class="fas fa-arrow-left"></i>
    Back to Home
  </a>

  <div class="register-container">
    <div class="logo">
      <h1><span class="logo-emoji">ðŸšš</span> BizTrack</h1>
    </div>

    <h1>Create Your Account</h1>
    <p class="subtitle">Start tracking your supply chain today</p>

    <div id="planBadge" class="plan-badge" style="display: none;">
      <i class="fas fa-tag"></i>
      <span id="planName"></span>
    </div>

    <div id="message" class="message"></div>

    <form id="registerForm">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="companyName">Company Name (Optional)</label>
        <input type="text" id="companyName" autocomplete="organization">
      </div>

      <div class="form-group">
        <label for="businessType">Business Type <span style="color: #DC2626;">*</span></label>
        <select id="businessType" required>
          <option value="">Select your business type</option>
          <option value="general">General Business</option>
          <option value="pharma">Pharmaceutical Business</option>
        </select>
        <div class="business-type-info">
          <i class="fas fa-info-circle"></i>
          <span>This determines your available pricing plans and cannot be changed later.</span>
        </div>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" required autocomplete="new-password">
        <p class="password-requirements">Must be at least 8 characters</p>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input type="password" id="confirmPassword" required autocomplete="new-password">
      </div>

      <button type="submit" class="btn" id="registerBtn">
        <i class="fas fa-rocket"></i>
        Create Account
      </button>
    </form>

    <div class="links">
      Already have an account? <a href="login.html">Login</a>
    </div>
  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';

    // Get plan from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedPlan = urlParams.get('plan');
    const planPrice = urlParams.get('price');

    function showMessage(text, type = 'error') {
      const messageEl = document.getElementById('message');
      messageEl.className = `message ${type} show`;
      const icon = type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle';
      messageEl.innerHTML = `
        <i class="fas fa-${icon}"></i>
        ${text}
      `;
    }

    function hideMessage() {
      const messageEl = document.getElementById('message');
      messageEl.classList.remove('show');
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const companyName = document.getElementById('companyName').value.trim();
      const businessType = document.getElementById('businessType').value;
      const registerBtn = document.getElementById('registerBtn');

      // Validation
      if (!email || !password) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      if (!businessType) {
        showMessage('Please select your business type', 'error');
        return;
      }

      if (password.length < 8) {
        showMessage('Password must be at least 8 characters', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }

      registerBtn.disabled = true;
      registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

      try {
        // Step 1: Register the user
        console.log('Step 1: Registering user with business type:', businessType);
        const registerResponse = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            email, 
            password, 
            companyName: companyName || null,
            businessType
          })
        });

        const registerData = await registerResponse.json();
        console.log('Register response:', registerResponse.status, registerData);

        if (!registerResponse.ok || !registerData.success) {
          throw new Error(registerData.error || 'Registration failed');
        }

        // âœ… Show success in button (turns green)
        registerBtn.innerHTML = '<i class="fas fa-check-circle"></i> Success! Signing you in...';
        registerBtn.style.background = 'linear-gradient(135deg, #10B981, #059669)';

        // Step 2: Automatically log them in
        console.log('Step 2: Logging in user...');
        const loginResponse = await fetch(`${API_BASE}/api/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });

        const loginData = await loginResponse.json();
        console.log('Login response:', loginResponse.status, loginData);

        if (!loginResponse.ok || !loginData.success || !loginData.token) {
          throw new Error('Login failed after registration');
        }

        // Save token
        localStorage.setItem('biztrack-auth-token', loginData.token);
        localStorage.setItem('biztrack-user-email', email);

        // Step 3: Redirect to appropriate pricing page based on business type
        registerBtn.innerHTML = '<i class="fas fa-rocket"></i> Redirecting... (Don\'t refresh!)';
        
        setTimeout(() => {
          // Route based on business type
          if (businessType === 'pharma') {
            window.location.href = '/SI-pharma-pricing.html';
          } else {
            window.location.href = '/pricing.html';
          }
        }, 1500);

      } catch (error) {
        console.error('Registration error:', error);
        showMessage(error.message || 'Something went wrong. Please try again.', 'error');
        
        registerBtn.disabled = false;
        registerBtn.innerHTML = '<i class="fas fa-rocket"></i> Create Account';
        registerBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    });

    // Check if already logged in
    const existingToken = localStorage.getItem('biztrack-auth-token');
    if (existingToken && !selectedPlan) {
      window.location.href = '/dashboard.html';
    }
  </script>
</body>
</html>
