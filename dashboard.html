<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Products – BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .dashboard-header { margin-bottom: 2rem; }
    .dashboard-header h1 { font-size: 2.5rem; font-weight: 800; color: #1E293B; margin-bottom: 0.5rem; }
    .dashboard-header p { font-size: 1.125rem; color: #64748B; }

    .usage-counter {
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .usage-counter h4 { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; }
    .usage-counter-numbers { font-size: 2.5rem; font-weight: 800; }
    .usage-counter-numbers small { font-size: 1.25rem; opacity: 0.8; }
    .usage-counter-upgrade {
      background: white;
      color: #4F46E5;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .usage-counter-upgrade:hover { transform: translateY(-2px); }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }
    .card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .card h3 i { color: #4F46E5; }

    /* Toggle Containers */
    .toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 2px solid #E2E8F0;
      position: relative;
    }
    .toggle-container.production { border-color: #10B981; }
    .toggle-container.excel { border-color: #F59E0B; }
    
    .toggle-label { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: #334155; }
    .toggle-label i { color: #4F46E5; }
    .toggle-label i.production { color: #10B981; }
    .toggle-label i.excel { color: #F59E0B; }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: #CBD5E1;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .toggle-switch.active { background: #4F46E5; }
    .toggle-switch.active.production { background: #10B981; }
    .toggle-switch.active.excel { background: #F59E0B; }
    .toggle-switch-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .toggle-switch.active .toggle-switch-slider { transform: translateX(28px); }

    /* Info Tooltip */
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      background: #E2E8F0;
      color: #64748B;
      border-radius: 50%;
      font-size: 0.7rem;
      cursor: pointer;
      margin-left: 0.5rem;
      transition: all 0.2s;
    }
    .info-icon:hover { background: #4F46E5; color: white; }
    
    .info-tooltip {
      display: none;
      position: absolute;
      background: #1E293B;
      color: white;
      padding: 1rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 400;
      width: 300px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      line-height: 1.5;
      top: 100%;
      left: 0;
      margin-top: 0.5rem;
    }
    .info-tooltip.show { display: block; }
    .info-tooltip::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 20px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #1E293B;
    }

    /* Expandable Sections */
    .expandable-section {
      display: none;
      padding: 1.5rem;
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    .expandable-section.show { display: block; }
    .expandable-section.batch { background: #FEF3C7; border: 2px solid #FDE047; }
    .expandable-section.production { background: #ECFDF5; border: 2px solid #10B981; }
    .expandable-section.excel { background: #FEF3C7; border: 2px solid #F59E0B; }
    .expandable-section h4 { margin-bottom: 0.75rem; }
    .expandable-section.batch h4 { color: #92400E; }
    .expandable-section.production h4 { color: #065F46; }
    .expandable-section.excel h4 { color: #92400E; }
    .expandable-section p { font-size: 0.9rem; margin-bottom: 0; }
    .expandable-section.batch p { color: #92400E; }
    .expandable-section.production p { color: #047857; }
    .expandable-section.excel p { color: #92400E; }

    .batch-info { margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.875rem; color: #92400E; }

    /* Excel Upload Area */
    .excel-instructions {
      font-style: italic;
      color: #92400E;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      line-height: 1.6;
    }
    .excel-instructions code {
      background: white;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-family: monospace;
      font-style: normal;
      color: #B45309;
    }

    .excel-upload-area {
      border: 2px dashed #F59E0B;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .excel-upload-area:hover { background: #FFFBEB; }
    .excel-upload-area.dragover { background: #FEF3C7; border-style: solid; }
    .excel-upload-area i { font-size: 2.5rem; color: #F59E0B; margin-bottom: 0.75rem; }
    .excel-upload-area p { color: #92400E; font-weight: 500; margin-bottom: 0.25rem; }
    .excel-upload-area small { color: #B45309; }

    .excel-preview {
      margin-top: 1rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #E2E8F0;
    }
    .excel-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #F8FAFC;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-header strong { color: #334155; }
    .excel-preview-clear {
      background: none;
      border: none;
      color: #DC2626;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .excel-preview-table {
      width: 100%;
      font-size: 0.85rem;
      border-collapse: collapse;
    }
    .excel-preview-table th, .excel-preview-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid #E2E8F0;
    }
    .excel-preview-table th { background: #F8FAFC; font-weight: 600; color: #64748B; }
    .excel-preview-table tr:last-child td { border-bottom: none; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #334155; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #F8FAFC;
    }
    .form-group input:disabled { background: #F1F5F9; color: #94A3B8; cursor: not-allowed; opacity: 0.6; }
    .form-group input:focus:not(:disabled), .form-group textarea:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      background: white;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      width: 100%;
      justify-content: center;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      box-shadow: none;
      padding: 0.75rem 1.5rem;
      width: auto;
    }
    .btn-secondary:hover:not(:disabled) { background: #F8FAFC; transform: none; }

    .message { padding: 1rem; border-radius: 12px; margin-top: 1rem; font-weight: 500; display: flex; align-items: flex-start; gap: 0.75rem; }
    .message.success { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
    .message.error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .message.info { background: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; }

    /* Quick Links */
    .quick-links {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .quick-link {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.25rem;
      background: #F8FAFC;
      border-radius: 12px;
      border: 2px solid #E2E8F0;
      text-decoration: none;
      color: #334155;
      font-weight: 600;
      transition: all 0.2s;
    }
    .quick-link:hover { border-color: #4F46E5; background: white; }
    .quick-link i { font-size: 1.5rem; color: #4F46E5; }
    .quick-link.production i { color: #10B981; }
    .quick-link.production:hover { border-color: #10B981; }
    .quick-link-count {
      margin-left: auto;
      background: #E2E8F0;
      color: #64748B;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    @media (max-width: 768px) {
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; padding-top: 5rem; }
      .usage-counter { flex-direction: column; gap: 1rem; text-align: center; }
      .toggle-container { flex-wrap: wrap; gap: 0.75rem; }
    }
  </style>
</head>
<body>
  <script src="js/SI-sidebar.js"></script>

  <div class="main-with-sidebar">
    <div class="dashboard-header">
      <h1>Create Products</h1>
      <p>Mint new products to blockchain or start production tracking.</p>
    </div>

    <div class="usage-counter">
      <div class="usage-counter-info">
        <h4>QR Codes Used This Month</h4>
        <div class="usage-counter-numbers">
          <span id="qrUsedCount">0</span> <small>/ <span id="qrLimitCount">10</span></small>
        </div>
        <p style="margin-top: 0.5rem; font-size: 0.875rem; opacity: 0.9;" id="tierName">Free Plan</p>
      </div>
      <button class="usage-counter-upgrade" id="planButton" onclick="goToPricing()">
        <i class="fas fa-arrow-up"></i> <span id="planButtonText">Upgrade Plan</span>
      </button>
    </div>

    <!-- Quick Links to New Pages -->
    <div class="card" style="padding: 1.5rem;">
      <div class="quick-links">
        <a href="products.html" class="quick-link">
          <i class="fas fa-box-check"></i>
          <span>Finished Products</span>
          <span class="quick-link-count" id="finishedCount">-</span>
        </a>
        <a href="production.html" class="quick-link production">
          <i class="fas fa-industry"></i>
          <span>In Production</span>
          <span class="quick-link-count" id="productionCount">-</span>
        </a>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-plus-circle"></i> Mint New Product</h3>
      
      <!-- Batch Toggle -->
      <div class="toggle-container">
        <div class="toggle-label">
          <i class="fas fa-layer-group"></i>
          <span id="batchToggleText">Batch Upload</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'batchTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="batchTooltip">
          <strong>What is Batch Upload?</strong><br><br>
          Have multiple items to mint at once? Enable batch mode to either enter a quantity (for identical items) or upload an Excel file (for different products with unique SKUs).
        </div>
        <div class="toggle-switch" id="batchToggle" onclick="toggleBatchMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Production Mode Toggle -->
      <div class="toggle-container production">
        <div class="toggle-label">
          <i class="fas fa-route production"></i>
          <span id="productionToggleText">Production Mode</span>
          <span class="info-icon" onclick="toggleTooltip(event, 'productionTooltip')"><i class="fas fa-info"></i></span>
        </div>
        <div class="info-tooltip" id="productionTooltip">
          <strong>What is Production Mode?</strong><br><br>
          Does your product have multiple steps before reaching a consumer? Production Mode lets you track each checkpoint in your supply chain—manufacturing, quality checks, shipping, distribution—before going live.<br><br>
          Each stop scans the same QR code to log their part of the journey. When ready, hit "Go Live" and customers see the full verified timeline.
        </div>
        <div class="toggle-switch production" id="productionToggle" onclick="toggleProductionMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- Batch Section (quantity input + Excel option below) -->
      <div class="expandable-section batch" id="batchSection">
        <h4><i class="fas fa-boxes"></i> Batch Settings</h4>
        
        <!-- Quantity Input -->
        <div class="form-group">
          <label for="batchQuantity">
            How many identical items? 
            <span id="remainingQRs" style="color: #059669; font-size: 0.875rem;"></span>
          </label>
          <input id="batchQuantity" type="number" min="1" max="1000" value="5" placeholder="Enter quantity..." />
          <p style="font-size: 0.8rem; color: #92400E; margin-top: 0.5rem;">
            SKUs will be auto-generated (e.g., HONEY-001, HONEY-002, ...)
          </p>
        </div>

        <!-- OR divider -->
        <div style="display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0;">
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
          <span style="color: #92400E; font-weight: 600; font-size: 0.85rem;">OR upload a list</span>
          <div style="flex: 1; height: 2px; background: #E2E8F0;"></div>
        </div>

        <!-- Excel Upload -->
        <div id="batchExcelInput">
          <p class="excel-instructions">
            Have a spreadsheet with unique SKUs? Upload it here.<br>
            Columns: <code>Product Name</code> <code>SKU</code> <code>Batch Number</code> <code>Notes</code><br>
            <span style="font-size: 0.8rem;">No headers needed—just your data, one product per row.</span>
          </p>
          
          <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display: none;" />
          
          <div class="excel-upload-area" id="excelUploadArea" onclick="document.getElementById('excelInput').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag & drop</p>
            <small>.xlsx, .xls, or .csv</small>
          </div>

          <div class="excel-preview" id="excelPreview" style="display: none;">
            <div class="excel-preview-header">
              <strong><i class="fas fa-table"></i> <span id="excelFileName">file.xlsx</span></strong>
              <div style="display: flex; align-items: center; gap: 1rem;">
                <span style="background: #10B981; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                  <span id="excelRowCount">0</span> products
                </span>
                <button class="excel-preview-clear" onclick="clearExcelUpload()"><i class="fas fa-times"></i> Clear</button>
              </div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
              <table class="excel-preview-table">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>SKU</th>
                    <th>Batch #</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody id="excelPreviewBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Production Mode Section -->
      <div class="expandable-section production" id="productionSection">
        <h4><i class="fas fa-info-circle"></i> Production Mode Enabled</h4>
        <p>Products will start in <strong>production tracking mode</strong>. You can log checkpoints (QC, shipping, etc.) before finalizing for customer verification. No QR codes charged until you "Go Live".</p>
      </div>

      <!-- Manual Entry Form (hidden when Excel mode is on) -->
      <div id="manualEntryForm">
        <div class="form-group">
          <label for="dashProdName">Product Name *</label>
          <input id="dashProdName" type="text" placeholder="e.g. Organic Honey" />
        </div>
        
        <div class="form-group" id="skuGroup">
          <label for="dashSku" id="skuLabel">SKU *</label>
          <input id="dashSku" type="text" placeholder="e.g. HNY1234" />
        </div>
        
        <div class="form-group">
          <label for="dashBatch">Batch Number</label>
          <input id="dashBatch" type="text" placeholder="e.g. 001" />
        </div>
        
        <div class="form-group">
          <label for="dashMetadata">Additional Info (optional)</label>
          <textarea id="dashMetadata" placeholder="e.g. Harvest date, origin, certifications" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Photos (optional)</label>
          <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" />
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
          <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
              <i class="fas fa-camera"></i> Take Photo
            </button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
              <i class="fas fa-images"></i> Gallery
            </button>
            <button type="button" class="btn btn-secondary" id="captureLocationBtn">
              <i class="fas fa-map-marker-alt"></i> <span id="locationBtnText">Location</span>
            </button>
          </div>
          <div id="photoPreview" style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;"></div>
          <p id="locationDisplay" style="margin-top: 0.75rem; color: #10B981; font-size: 0.875rem; display: none;">
            <i class="fas fa-check-circle"></i> Location captured!
          </p>
        </div>
      </div>
      
      <button class="btn" id="dashCreateBtn">
        <i class="fas fa-rocket"></i>
        <span id="mintButtonText">Mint to Blockchain</span>
      </button>
      
      <div id="dashMsg"></div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let isBatchMode = false;
    let isProductionMode = false;
    let selectedPhotos = [];
    let capturedLocation = null;
    let qrUsedThisMonth = 0;
    let qrLimit = 10;
    let currentTier = 'free';
    let excelData = [];

    // ==========================================
    // TOOLTIPS
    // ==========================================
    function toggleTooltip(event, tooltipId) {
      event.stopPropagation();
      // Close all tooltips first
      document.querySelectorAll('.info-tooltip').forEach(t => {
        if (t.id !== tooltipId) t.classList.remove('show');
      });
      document.getElementById(tooltipId).classList.toggle('show');
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.info-icon') && !e.target.closest('.info-tooltip')) {
        document.querySelectorAll('.info-tooltip').forEach(t => t.classList.remove('show'));
      }
    });

    // ==========================================
    // TOGGLE MODES
    // ==========================================
    function toggleBatchMode() {
      isBatchMode = !isBatchMode;
      const toggle = document.getElementById('batchToggle');
      const section = document.getElementById('batchSection');
      const toggleText = document.getElementById('batchToggleText');
      const skuInput = document.getElementById('dashSku');
      const manualForm = document.getElementById('manualEntryForm');
      
      if (isBatchMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Batch Upload ✓';
        skuInput.disabled = true;
        skuInput.value = '';
        skuInput.placeholder = 'Auto-generated from batch';
        document.getElementById('remainingQRs').textContent = '(' + (qrLimit - qrUsedThisMonth) + ' available)';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Batch Upload';
        skuInput.disabled = false;
        skuInput.placeholder = 'e.g. HNY1234';
        document.getElementById('remainingQRs').textContent = '';
        clearExcelUpload();
      }
      updateMintButtonText();
    }

    function toggleProductionMode() {
      isProductionMode = !isProductionMode;
      const toggle = document.getElementById('productionToggle');
      const section = document.getElementById('productionSection');
      const toggleText = document.getElementById('productionToggleText');
      
      if (isProductionMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Production Mode ✓';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Production Mode';
      }
      updateMintButtonText();
    }

    function updateMintButtonText() {
      const text = document.getElementById('mintButtonText');
      const hasExcel = excelData.length > 0;
      
      if (isProductionMode) {
        // Production mode - no blockchain yet
        if (hasExcel) {
          text.textContent = 'Create Production Entries';
        } else if (isBatchMode) {
          text.textContent = 'Create Production Batch';
        } else {
          text.textContent = 'Create Production Entry';
        }
      } else {
        // Live mode - mint to blockchain
        if (hasExcel) {
          text.textContent = 'Upload & Mint All';
        } else if (isBatchMode) {
          text.textContent = 'Mint Batch to Blockchain';
        } else {
          text.textContent = 'Mint to Blockchain';
        }
      }
    }

    // ==========================================
    // EXCEL HANDLING
    // ==========================================
    const excelInput = document.getElementById('excelInput');
    const excelUploadArea = document.getElementById('excelUploadArea');

    excelInput.addEventListener('change', handleExcelFile);

    // Drag and drop
    excelUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      excelUploadArea.classList.add('dragover');
    });
    excelUploadArea.addEventListener('dragleave', () => {
      excelUploadArea.classList.remove('dragover');
    });
    excelUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      excelUploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) processExcelFile(file);
    });

    function handleExcelFile(e) {
      const file = e.target.files[0];
      if (file) processExcelFile(file);
    }

    function processExcelFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          // Filter out empty rows
          excelData = rows.filter(row => row.length > 0 && row[0]);
          
          if (excelData.length === 0) {
            alert('No data found in the spreadsheet.');
            return;
          }

          // Check if we have enough QR codes (only matters for live mode)
          const remaining = qrLimit - qrUsedThisMonth;
          if (!isProductionMode && excelData.length > remaining) {
            alert(`You have ${remaining} QR codes remaining but are trying to upload ${excelData.length} products. Please upgrade your plan or reduce the number of products.`);
            excelData = [];
            return;
          }

          // Show preview
          document.getElementById('excelFileName').textContent = file.name;
          document.getElementById('excelRowCount').textContent = excelData.length;
          
          const tbody = document.getElementById('excelPreviewBody');
          tbody.innerHTML = '';
          
          // Show first 5 rows as preview
          const previewRows = excelData.slice(0, 5);
          previewRows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHtml(row[0] || '')}</td>
              <td>${escapeHtml(row[1] || '')}</td>
              <td>${escapeHtml(row[2] || '')}</td>
              <td>${escapeHtml(row[3] || '')}</td>
            `;
            tbody.appendChild(tr);
          });
          
          if (excelData.length > 5) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="4" style="text-align:center;color:#64748B;font-style:italic;">...and ${excelData.length - 5} more</td>`;
            tbody.appendChild(tr);
          }

          document.getElementById('excelPreview').style.display = 'block';
          document.getElementById('excelUploadArea').style.display = 'none';
          
          // Update button text to reflect Excel upload
          updateMintButtonText();
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function clearExcelUpload() {
      excelData = [];
      document.getElementById('excelInput').value = '';
      document.getElementById('excelPreview').style.display = 'none';
      document.getElementById('excelUploadArea').style.display = 'block';
      updateMintButtonText();
    }

    // ==========================================
    // SUBSCRIPTION & LIMITS
    // ==========================================
    async function loadSubscriptionLimits() {
      try {
        const response = await authenticatedFetch('/api/check-limits');
        const data = await response.json();
        
        if (data.success) {
          qrUsedThisMonth = data.subscription.qrUsed;
          qrLimit = data.subscription.qrLimit;
          currentTier = data.subscription.tier;
          
          document.getElementById('qrUsedCount').textContent = qrUsedThisMonth.toLocaleString();
          document.getElementById('qrLimitCount').textContent = qrLimit.toLocaleString();
          document.getElementById('tierName').textContent = currentTier.charAt(0).toUpperCase() + currentTier.slice(1) + ' Plan';
          
          const topTiers = ['enterprise', 'pharma_enterprise'];
          if (topTiers.includes(currentTier)) {
            document.getElementById('planButtonText').textContent = 'View Plan';
            document.getElementById('planButton').querySelector('i').className = 'fas fa-eye';
          }
          
          const remaining = qrLimit - qrUsedThisMonth;
          const maxBatch = Math.min(data.subscription.maxBatchSize || 10, remaining);
          
          document.getElementById('maxBatchQuantity').textContent = maxBatch;
          document.getElementById('batchQuantity').max = maxBatch;
        }
      } catch (error) {
        console.error('Failed to load limits:', error);
      }
    }

    // ==========================================
    // LOAD PRODUCT COUNTS
    // ==========================================
    async function loadProductCounts() {
      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();
        
        console.log('API Response:', data);
        
        if (data.success && data.products) {
          let finished = 0;
          let production = 0;
          
          data.products.forEach(p => {
            if (p.mode === 'production' && !p.isFinalized) {
              production++;
            } else {
              finished++;
            }
          });
          
          document.getElementById('finishedCount').textContent = finished;
          document.getElementById('productionCount').textContent = production;
        }
      } catch (error) {
        console.error('Failed to load counts:', error);
      }
    }

    // ==========================================
    // PHOTO HANDLING
    // ==========================================
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const MAX = 1200;
            if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
            else if (h > MAX) { w *= MAX / h; h = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('photoInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    document.getElementById('cameraInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    function displayPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      selectedPhotos.forEach((photo, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'position: relative; width: 80px; height: 80px;';
        div.innerHTML = '<img src="' + photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:2px solid #E2E8F0;"/><button onclick="removePhoto(' + i + ')" style="position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#DC2626;color:white;border:none;cursor:pointer;font-size:10px;">✕</button>';
        preview.appendChild(div);
      });
    }

    window.removePhoto = (i) => { selectedPhotos.splice(i, 1); displayPhotoPreview(); };

    document.getElementById('captureLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      const btn = document.getElementById('captureLocationBtn');
      btn.disabled = true;
      document.getElementById('locationBtnText').textContent = 'Getting...';
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          capturedLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
          document.getElementById('locationDisplay').style.display = 'block';
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Update';
        },
        (err) => {
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Location';
          alert('Location error: ' + err.message);
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
      );
    });

    // ==========================================
    // MINT / CREATE PRODUCT
    // ==========================================
    document.getElementById('dashCreateBtn').addEventListener('click', async () => {
      const msgEl = document.getElementById('dashMsg');
      const btn = document.getElementById('dashCreateBtn');
      msgEl.innerHTML = '';

      // Excel mode - if Excel data exists, use that (ignores quantity field)
      if (excelData.length > 0) {
        btn.disabled = true;
        const origText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < excelData.length; i++) {
          const row = excelData[i];
          const productName = row[0];
          const sku = row[1];
          const batchNumber = row[2] || '';
          const notes = row[3] || '';
          
          if (!productName || !sku) {
            errorCount++;
            continue;
          }
          
          btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${i + 1} / ${excelData.length}...`;
          
          try {
            const response = await fetch('/api/mint-product', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('biztrack-auth-token')
              },
              body: JSON.stringify({
                productName,
                sku,
                batchNumber,
                metadata: notes ? { notes } : {},
                mode: isProductionMode ? 'production' : 'live'
              })
            });
            
            const result = await response.json();
            if (response.ok && result.success) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (err) {
            errorCount++;
          }
        }
        
        btn.disabled = false;
        btn.innerHTML = origText;
        
        if (errorCount === 0) {
          msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> Successfully created ${successCount} products!</div>`;
        } else {
          msgEl.innerHTML = `<div class="message info"><i class="fas fa-info-circle"></i> Created ${successCount} products. ${errorCount} failed (missing name or SKU).</div>`;
        }
        
        clearExcelUpload();
        await loadSubscriptionLimits();
        await loadProductCounts();
        return;
      }

      // Manual / Batch mode
      const productName = document.getElementById('dashProdName').value.trim();
      const sku = document.getElementById('dashSku').value.trim();
      const batchNumber = document.getElementById('dashBatch').value.trim();
      const metadata = document.getElementById('dashMetadata').value.trim();
      const batchQuantity = isBatchMode ? parseInt(document.getElementById('batchQuantity').value) : 1;
      
      if (!productName) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Product name required.</div>';
        return;
      }
      if (!isBatchMode && !sku) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> SKU required.</div>';
        return;
      }

      btn.disabled = true;
      const origText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Minting...';
      msgEl.innerHTML = '<div class="message info"><i class="fas fa-info-circle"></i> Processing...</div>';

      try {
        const token = localStorage.getItem('biztrack-auth-token');
        if (!token) throw new Error('Session expired');

        const response = await fetch('/api/mint-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({
            productName,
            sku: isBatchMode ? undefined : sku,
            batchNumber,
            metadata: metadata ? { notes: metadata } : {},
            photos: selectedPhotos.length ? selectedPhotos : null,
            location: capturedLocation,
            isBatchOrder: isBatchMode,
            batchQuantity,
            mode: isProductionMode ? 'production' : 'live'
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.details || result.error || 'Minting failed');

        const successMsg = isProductionMode 
          ? (result.isBatch ? 'Batch created in production mode!' : 'Product created in production mode!')
          : (result.isBatch ? 'Batch minted!' : 'Product minted!');
        msgEl.innerHTML = '<div class="message success"><i class="fas fa-check-circle"></i> ' + successMsg + '</div>';
        
        // Clear form
        document.getElementById('dashProdName').value = '';
        document.getElementById('dashSku').value = '';
        document.getElementById('dashBatch').value = '';
        document.getElementById('dashMetadata').value = '';
        selectedPhotos = [];
        capturedLocation = null;
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('locationDisplay').style.display = 'none';

        await loadSubscriptionLimits();
        await loadProductCounts();
      } catch (err) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> ' + err.message + '</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    });

    // ==========================================
    // HELPERS
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // INIT
    // ==========================================
    loadSubscriptionLimits();
    loadProductCounts();
  </script>
</body>
</html>
