<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Products in Production â€“ BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .page-header h1 { font-size: 2rem; font-weight: 800; color: #1E293B; }
    .page-header h1 i { color: #10B981; }
    .page-header p { font-size: 1rem; color: #64748B; margin-top: 0.25rem; }

    .header-stats {
      display: flex;
      gap: 1.5rem;
    }
    .stat-box {
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      border: 2px solid #10B981;
      text-align: center;
    }
    .stat-box-value { font-size: 1.5rem; font-weight: 800; color: #10B981; }
    .stat-box-label { font-size: 0.75rem; color: #065F46; text-transform: uppercase; }

    /* Info Banner */
    .info-banner {
      background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
      border: 2px solid #10B981;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }
    .info-banner i { color: #10B981; font-size: 1.25rem; margin-top: 0.1rem; }
    .info-banner-content { flex: 1; }
    .info-banner-content strong { color: #065F46; }
    .info-banner-content p { color: #047857; font-size: 0.9rem; margin: 0; }

    /* Search */
    .search-bar {
      background: white;
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid #E2E8F0;
      margin-bottom: 1.5rem;
    }
    .search-box {
      position: relative;
      max-width: 400px;
    }
    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #94A3B8;
    }
    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.75rem;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .search-box input:focus {
      outline: none;
      border-color: #10B981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    /* Product List */
    .products-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .product-card {
      background: white;
      border-radius: 16px;
      border: 2px solid #10B981;
      overflow: hidden;
      transition: all 0.2s;
    }
    .product-card:hover {
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
    }

    .product-card-header {
      padding: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: linear-gradient(135deg, #F0FDF4 0%, #ECFDF5 100%);
    }
    .product-card-header:hover { background: #ECFDF5; }

    .product-card-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .product-card-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #1E293B;
    }
    .product-card-sku {
      font-size: 0.85rem;
      color: #64748B;
      font-family: monospace;
    }

    .product-card-badges {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .badge {
      padding: 0.3rem 0.7rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .badge-production { background: #10B981; color: white; }
    .badge-checkpoints { background: #F59E0B; color: white; }
    .badge-batch { background: #3B82F6; color: white; }

    .expand-icon {
      color: #64748B;
      font-size: 1.25rem;
      transition: transform 0.2s;
    }
    .product-card.expanded .expand-icon { transform: rotate(180deg); }

    .product-card-body {
      display: none;
      padding: 1.5rem;
      border-top: 2px solid #D1FAE5;
    }
    .product-card.expanded .product-card-body { display: block; }

    /* Timeline */
    .timeline-section {
      margin-bottom: 1.5rem;
    }
    .timeline-section h4 {
      font-size: 1rem;
      font-weight: 700;
      color: #065F46;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .timeline {
      position: relative;
      padding-left: 2rem;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, #10B981, #3B82F6);
      border-radius: 3px;
    }

    .timeline-item {
      position: relative;
      padding-bottom: 1.25rem;
    }
    .timeline-item:last-child { padding-bottom: 0; }

    .timeline-dot {
      position: absolute;
      left: -2rem;
      top: 0;
      width: 20px;
      height: 20px;
      background: #10B981;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 0 0 2px #10B981;
    }

    .timeline-content {
      background: #F8FAFC;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid #E2E8F0;
      position: relative;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    .timeline-who {
      font-weight: 600;
      color: #1E293B;
    }
    .timeline-role {
      font-size: 0.7rem;
      color: white;
      background: #10B981;
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    .timeline-when {
      font-size: 0.8rem;
      color: #94A3B8;
    }
    .timeline-location {
      font-size: 0.85rem;
      color: #64748B;
      margin-bottom: 0.25rem;
    }
    .timeline-location i { color: #3B82F6; margin-right: 0.25rem; }
    .timeline-notes {
      font-size: 0.9rem;
      color: #475569;
      background: white;
      padding: 0.5rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      border-left: 3px solid #10B981;
    }
    .timeline-photos {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .timeline-photos img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #E2E8F0;
      transition: all 0.2s;
    }
    .timeline-photos img:hover { transform: scale(1.1); border-color: #10B981; }

    .timeline-delete {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      color: #94A3B8;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .timeline-delete:hover { color: #DC2626; background: #FEF2F2; }

    .timeline-empty {
      text-align: center;
      padding: 2rem;
      color: #94A3B8;
      background: #F8FAFC;
      border-radius: 10px;
    }
    .timeline-empty i { font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5; }

    /* Actions */
    .product-actions {
      display: flex;
      gap: 0.75rem;
      padding-top: 1rem;
      border-top: 2px solid #E2E8F0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      border: none;
    }
    .btn-finalize {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn-finalize:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4); }
    .btn-finalize:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary {
      background: white;
      color: #475569;
      border: 2px solid #E2E8F0;
    }
    .btn-secondary:hover { background: #F8FAFC; border-color: #CBD5E1; }
    .btn-danger {
      background: white;
      color: #DC2626;
      border: 2px solid #FECACA;
    }
    .btn-danger:hover { background: #FEF2F2; }
    .btn-qr {
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
    }
    .btn-qr:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94A3B8;
    }
    .empty-state i { font-size: 4rem; margin-bottom: 1rem; color: #10B981; opacity: 0.5; }
    .empty-state h3 { font-size: 1.25rem; color: #64748B; margin-bottom: 0.5rem; }
    .empty-state p { margin-bottom: 1.5rem; }
    .empty-state a { color: #10B981; text-decoration: none; font-weight: 600; }
    .empty-state a:hover { text-decoration: underline; }

    /* Confirmation Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      max-width: 450px;
      width: 90%;
      text-align: center;
    }
    .modal h3 { font-size: 1.25rem; margin-bottom: 0.75rem; color: #1E293B; }
    .modal p { color: #64748B; margin-bottom: 1.5rem; font-size: 0.95rem; }
    .modal-buttons { display: flex; gap: 0.75rem; justify-content: center; }
    .modal-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .modal-btn-cancel { background: #F1F5F9; color: #64748B; }
    .modal-btn-cancel:hover { background: #E2E8F0; }
    .modal-btn-danger { background: #DC2626; color: white; }
    .modal-btn-danger:hover { background: #B91C1C; }
    .modal-btn-success { background: #10B981; color: white; }
    .modal-btn-success:hover { background: #059669; }

    /* QR Modal */
    .qr-modal {
      max-width: 400px;
    }
    .qr-modal img {
      width: 200px;
      height: 200px;
      border-radius: 12px;
      border: 2px solid #10B981;
      padding: 8px;
      margin-bottom: 1rem;
    }
    .qr-modal-sku {
      font-family: monospace;
      background: #F1F5F9;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: inline-block;
    }

    @media (max-width: 768px) {
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; padding-top: 5rem; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .header-stats { width: 100%; }
      .stat-box { flex: 1; }
      .product-card-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
      .product-actions { flex-direction: column; }
      .product-actions .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <script src="js/SI-sidebar.js"></script>

  <div class="main-with-sidebar">
    <div class="page-header">
      <div>
        <h1><i class="fas fa-industry"></i> Products in Production</h1>
        <p>Track your products through the supply chain before going live.</p>
      </div>
      <div class="header-stats">
        <div class="stat-box">
          <div class="stat-box-value" id="totalInProduction">-</div>
          <div class="stat-box-label">In Production</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="totalCheckpoints">-</div>
          <div class="stat-box-label">Total Checkpoints</div>
        </div>
      </div>
    </div>

    <!-- Info Banner -->
    <div class="info-banner">
      <i class="fas fa-info-circle"></i>
      <div class="info-banner-content">
        <p><strong>How it works:</strong> Products in production mode can be scanned at each supply chain checkpoint to log progress. When ready, click "Go Live" to mint to blockchain and make it available for customer verification.</p>
      </div>
    </div>

    <!-- Search -->
    <div class="search-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search by name or SKU..." />
      </div>
    </div>

    <!-- Products List -->
    <div id="productsContainer">
      <div class="empty-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirmModal" onclick="closeModal('confirmModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <h3 id="confirmModalTitle">Confirm</h3>
      <p id="confirmModalMessage">Are you sure?</p>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal('confirmModal')">Cancel</button>
        <button class="modal-btn" id="confirmModalBtn" onclick="confirmAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal-overlay" id="qrModal" onclick="closeModal('qrModal')">
    <div class="modal qr-modal" onclick="event.stopPropagation()">
      <h3><i class="fas fa-qrcode" style="color: #10B981;"></i> Tracking QR Code</h3>
      <img id="qrModalImage" src="" alt="QR Code" />
      <div class="qr-modal-sku" id="qrModalSku">SKU: ---</div>
      <p style="font-size: 0.85rem; color: #64748B; margin-bottom: 1rem;">Scan this QR code at each checkpoint to log progress.</p>
      <div class="modal-buttons">
        <a id="qrModalDownload" class="modal-btn modal-btn-success" href="#" download style="text-decoration: none;">
          <i class="fas fa-download"></i> Download
        </a>
        <button class="modal-btn modal-btn-cancel" onclick="closeModal('qrModal')">Close</button>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let allProducts = [];
    let filteredProducts = [];
    let confirmCallback = null;

    // ==========================================
    // LOAD PRODUCTS
    // ==========================================
    async function loadProducts() {
      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load products');
        }

        // Filter for production mode only (not finalized)
        allProducts = (data.products || []).filter(p => {
          return p.mode === 'production' && !p.isFinalized;
        });

        // Calculate stats
        let totalCheckpoints = 0;
        allProducts.forEach(p => {
          totalCheckpoints += (p.checkpointCount || 0);
        });

        document.getElementById('totalInProduction').textContent = allProducts.length;
        document.getElementById('totalCheckpoints').textContent = totalCheckpoints;

        applyFilters();
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('productsContainer').innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Products</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // ==========================================
    // FILTERS
    // ==========================================
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      filteredProducts = allProducts.filter(p => {
        return !searchTerm || 
          p.productName?.toLowerCase().includes(searchTerm) ||
          p.sku?.toLowerCase().includes(searchTerm) ||
          p.productId?.toLowerCase().includes(searchTerm);
      });

      renderProducts();
    }

    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));

    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // ==========================================
    // RENDER PRODUCTS
    // ==========================================
    function renderProducts() {
      const container = document.getElementById('productsContainer');

      if (filteredProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-industry"></i>
            <h3>No Products in Production</h3>
            <p>Enable "Production Mode" when creating products to track them through your supply chain.</p>
            <a href="dashboard.html"><i class="fas fa-plus"></i> Create Product with Production Mode</a>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="products-list">
          ${filteredProducts.map(product => renderProductCard(product)).join('')}
        </div>
      `;
    }

    function renderProductCard(product) {
      const checkpointCount = product.checkpointCount || 0;
      const isBatch = product.isBatchGroup;
      const itemCount = product.quantity || 1;

      return `
        <div class="product-card" id="card-${product.productId}">
          <div class="product-card-header" onclick="toggleCard('${product.productId}')">
            <div class="product-card-info">
              <div>
                <div class="product-card-title">${escapeHtml(product.productName)}</div>
                <div class="product-card-sku">${escapeHtml(product.sku || product.productId)}</div>
              </div>
            </div>
            <div class="product-card-badges">
              <span class="badge badge-production">Production</span>
              <span class="badge badge-checkpoints">${checkpointCount} checkpoint${checkpointCount !== 1 ? 's' : ''}</span>
              ${isBatch ? `<span class="badge badge-batch">Batch ${itemCount}</span>` : ''}
              <i class="fas fa-chevron-down expand-icon"></i>
            </div>
          </div>
          <div class="product-card-body">
            <div class="timeline-section">
              <h4><i class="fas fa-route"></i> Supply Chain Timeline</h4>
              <div class="timeline" id="timeline-${product.productId}">
                <div class="timeline-empty">
                  <i class="fas fa-spinner fa-spin"></i>
                  <p>Loading checkpoints...</p>
                </div>
              </div>
            </div>
            <div class="product-actions">
              <button class="btn btn-finalize" onclick="finalizeProduct('${product.productId}', '${escapeHtml(product.productName)}')">
                <i class="fas fa-rocket"></i> Go Live
              </button>
              <a href="/production-scan.html?id=${product.productId}" target="_blank" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Add Checkpoint
              </a>
              <button class="btn btn-qr" onclick="showQRModal('${product.qrCodeUrl}', '${escapeHtml(product.sku || product.productId)}')">
                <i class="fas fa-qrcode"></i> QR Code
              </button>
              <button class="btn btn-danger" onclick="deleteProduct('${product.productId}', '${escapeHtml(product.productName)}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ==========================================
    // TOGGLE CARD
    // ==========================================
    window.toggleCard = async function(productId) {
      const card = document.getElementById('card-' + productId);
      const isExpanding = !card.classList.contains('expanded');
      
      // Toggle expanded state
      card.classList.toggle('expanded');
      
      // Load checkpoints if expanding
      if (isExpanding) {
        await loadCheckpoints(productId);
      }
    };

    // ==========================================
    // LOAD CHECKPOINTS
    // ==========================================
    async function loadCheckpoints(productId) {
      const timeline = document.getElementById('timeline-' + productId);
      
      try {
        const response = await authenticatedFetch('/api/get-production-timeline?productId=' + encodeURIComponent(productId));
        const data = await response.json();

        if (!data.success) {
          timeline.innerHTML = '<div class="timeline-empty">Failed to load checkpoints</div>';
          return;
        }

        const checkpoints = data.timeline?.checkpoints || [];

        if (checkpoints.length === 0) {
          timeline.innerHTML = `
            <div class="timeline-empty">
              <i class="fas fa-route"></i>
              <p>No checkpoints logged yet.<br>Scan the QR code to add the first checkpoint.</p>
            </div>
          `;
          return;
        }

        timeline.innerHTML = checkpoints.map(cp => `
          <div class="timeline-item" id="checkpoint-${cp.id}">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <button class="timeline-delete" onclick="deleteCheckpoint(${cp.id}, '${productId}')" title="Delete checkpoint">
                <i class="fas fa-trash"></i>
              </button>
              <div class="timeline-header">
                <div>
                  <span class="timeline-who">${escapeHtml(cp.scannedByName || 'Unknown')}</span>
                  ${cp.scannedByRole ? `<span class="timeline-role">${escapeHtml(cp.scannedByRole)}</span>` : ''}
                </div>
                <span class="timeline-when">${formatDate(cp.scannedAt)}</span>
              </div>
              ${cp.locationName ? `<div class="timeline-location"><i class="fas fa-map-marker-alt"></i> ${escapeHtml(cp.locationName)}</div>` : ''}
              ${cp.notes ? `<div class="timeline-notes">${escapeHtml(cp.notes)}</div>` : ''}
              ${cp.photos && cp.photos.length > 0 ? `
                <div class="timeline-photos">
                  ${cp.photos.map(photo => `<img src="${photo}" onclick="window.open('${photo}', '_blank')" alt="Checkpoint photo">`).join('')}
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Error loading checkpoints:', error);
        timeline.innerHTML = '<div class="timeline-empty">Error loading checkpoints</div>';
      }
    }

    // ==========================================
    // FINALIZE PRODUCT
    // ==========================================
    window.finalizeProduct = function(productId, productName) {
      showConfirmModal(
        'Go Live?',
        `Are you sure you want to finalize "${productName}"? This will mint it to the blockchain and make it available for customer verification. This cannot be undone.`,
        'modal-btn-success',
        'Go Live',
        async () => {
          try {
            const response = await authenticatedFetch('/api/finalize-product', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId })
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to finalize');
            }

            alert('ðŸš€ Product is now live! Customers can view the full supply chain timeline.');
            loadProducts();
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      );
    };

    // ==========================================
    // DELETE PRODUCT
    // ==========================================
    window.deleteProduct = function(productId, productName) {
      showConfirmModal(
        'Delete Production Entry?',
        `Are you sure you want to delete "${productName}" and all its checkpoints? This cannot be undone.`,
        'modal-btn-danger',
        'Delete',
        async () => {
          try {
            const response = await authenticatedFetch('/api/delete-production-product', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId })
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to delete');
            }

            loadProducts();
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      );
    };

    // ==========================================
    // DELETE CHECKPOINT
    // ==========================================
    window.deleteCheckpoint = function(scanId, productId) {
      showConfirmModal(
        'Delete Checkpoint?',
        'Are you sure you want to delete this checkpoint? This cannot be undone.',
        'modal-btn-danger',
        'Delete',
        async () => {
          try {
            const response = await authenticatedFetch('/api/delete-production-scan', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ scanId })
            });

            const data = await response.json();

            if (!data.success) {
              throw new Error(data.error || 'Failed to delete');
            }

            // Remove from DOM
            const el = document.getElementById('checkpoint-' + scanId);
            if (el) el.remove();

            // Check if no more checkpoints
            const timeline = document.getElementById('timeline-' + productId);
            if (timeline && timeline.querySelectorAll('.timeline-item').length === 0) {
              timeline.innerHTML = `
                <div class="timeline-empty">
                  <i class="fas fa-route"></i>
                  <p>No checkpoints logged yet.<br>Scan the QR code to add the first checkpoint.</p>
                </div>
              `;
            }

            // Refresh to update counts
            loadProducts();
          } catch (error) {
            alert('Error: ' + error.message);
          }
        }
      );
    };

    // ==========================================
    // MODALS
    // ==========================================
    function showConfirmModal(title, message, btnClass, btnText, callback) {
      document.getElementById('confirmModalTitle').textContent = title;
      document.getElementById('confirmModalMessage').textContent = message;
      const btn = document.getElementById('confirmModalBtn');
      btn.textContent = btnText;
      btn.className = 'modal-btn ' + btnClass;
      confirmCallback = callback;
      document.getElementById('confirmModal').classList.add('show');
    }

    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('show');
      if (modalId === 'confirmModal') confirmCallback = null;
    };

    window.confirmAction = function() {
      if (confirmCallback) confirmCallback();
      closeModal('confirmModal');
    };

    window.showQRModal = function(qrUrl, sku) {
      document.getElementById('qrModalImage').src = qrUrl;
      document.getElementById('qrModalSku').textContent = 'SKU: ' + sku;
      document.getElementById('qrModalDownload').href = qrUrl;
      document.getElementById('qrModal').classList.add('show');
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('confirmModal');
        closeModal('qrModal');
      }
    });

    // ==========================================
    // HELPERS
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    // ==========================================
    // INIT
    // ==========================================
    loadProducts();
  </script>
</body>
</html>
