<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finished Products – BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .page-header h1 { font-size: 2rem; font-weight: 800; color: #1E293B; }
    .page-header p { font-size: 1rem; color: #64748B; margin-top: 0.25rem; }

    .header-stats {
      display: flex;
      gap: 1.5rem;
    }
    .stat-box {
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      border: 1px solid #E2E8F0;
      text-align: center;
    }
    .stat-box-value { font-size: 1.5rem; font-weight: 800; color: #4F46E5; }
    .stat-box-label { font-size: 0.75rem; color: #64748B; text-transform: uppercase; }

    /* Company Logo Banner */
    .logo-banner {
      background: linear-gradient(135deg, #F0FDF4, #ECFDF5);
      border: 2px dashed #10B981;
      border-radius: 16px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }
    .logo-upload-slot {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: white;
      border: 2px dashed #CBD5E1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      overflow: hidden;
      flex-shrink: 0;
    }
    .logo-upload-slot:hover { border-color: #10B981; background: #F0FDF4; }
    .logo-upload-slot img { width: 100%; height: 100%; object-fit: contain; }
    .logo-upload-slot i { font-size: 1.5rem; color: #94A3B8; }
    .logo-banner-text h3 { font-size: 1rem; font-weight: 700; color: #065F46; margin-bottom: 0.25rem; }
    .logo-banner-text p { font-size: 0.85rem; color: #047857; }
    .logo-banner-actions { margin-left: auto; display: flex; gap: 0.5rem; }
    .logo-banner-actions button { padding: 0.5rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
    .logo-change-btn { background: white; border: 1px solid #10B981; color: #059669; }
    .logo-remove-btn { background: white; border: 1px solid #E2E8F0; color: #64748B; }

    /* Search & Filters */
    .filters-bar {
      background: white;
      padding: 1.25rem;
      border-radius: 12px;
      border: 1px solid #E2E8F0;
      margin-bottom: 1.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #94A3B8;
    }
    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.75rem;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .search-box input:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .filter-select {
      padding: 0.75rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
      min-width: 150px;
    }
    .filter-select:focus {
      outline: none;
      border-color: #4F46E5;
    }

    .clear-filters {
      padding: 0.75rem 1rem;
      background: #F1F5F9;
      border: none;
      border-radius: 10px;
      color: #64748B;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .clear-filters:hover { background: #E2E8F0; color: #334155; }

    /* Product Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }

    .product-card {
      background: white;
      border-radius: 16px;
      border: 1px solid #E2E8F0;
      overflow: hidden;
      transition: all 0.2s;
    }
    .product-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .product-card-header {
      padding: 1.25rem;
      border-bottom: 1px solid #E2E8F0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .product-card-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #1E293B;
      margin-bottom: 0.25rem;
    }
    .product-card-sku {
      font-size: 0.85rem;
      color: #64748B;
      font-family: monospace;
    }

    .product-card-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .badge {
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .badge-live { background: #DBEAFE; color: #1D4ED8; }
    .badge-batch { background: #E0E7FF; color: #4338CA; }
    .badge-finalized { background: #D1FAE5; color: #065F46; }
    .badge-nutrition { background: #FEF3C7; color: #92400E; }

    .product-card-body {
      padding: 1.25rem;
    }

    .product-card-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .meta-item {
      font-size: 0.85rem;
    }
    .meta-item-label {
      color: #94A3B8;
      font-size: 0.75rem;
      text-transform: uppercase;
      margin-bottom: 0.15rem;
    }
    .meta-item-value {
      color: #334155;
      font-weight: 600;
    }

    .product-card-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      text-decoration: none;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .btn-secondary {
      background: #F1F5F9;
      color: #475569;
    }
    .btn-secondary:hover { background: #E2E8F0; }
    .btn-outline {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
    }
    .btn-outline:hover { background: #F5F3FF; }
    .btn-success {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
    }
    .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #94A3B8;
    }
    .empty-state i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
    .empty-state h3 { font-size: 1.25rem; color: #64748B; margin-bottom: 0.5rem; }
    .empty-state p { margin-bottom: 1.5rem; }
    .empty-state a { color: #4F46E5; text-decoration: none; font-weight: 600; }
    .empty-state a:hover { text-decoration: underline; }

    /* Loading State */
    .loading-state {
      text-align: center;
      padding: 4rem 2rem;
      color: #64748B;
    }
    .loading-state i { font-size: 2rem; margin-bottom: 1rem; }

    /* QR Modal */
    .qr-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1100;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .qr-modal-overlay.show { display: flex; }
    .qr-modal {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 520px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .qr-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #E2E8F0;
    }
    .qr-modal-header h2 { font-size: 1.5rem; font-weight: 700; color: #1E293B; }
    .qr-modal-close {
      background: none; border: none; font-size: 1.5rem; color: #64748B;
      cursor: pointer; padding: 0.5rem; border-radius: 8px;
    }
    .qr-modal-close:hover { background: #F1F5F9; color: #1E293B; }
    .qr-modal-sku {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .qr-modal-sku span {
      background: #F1F5F9;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1rem;
      color: #334155;
    }
    .qr-codes-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .qr-code-box { text-align: center; position: relative; }
    .qr-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      color: #94A3B8;
    }
    .qr-code-box img {
      width: 140px; height: 140px;
      border-radius: 12px;
      border: 2px solid #E2E8F0;
      padding: 8px;
      background: white;
    }
    .qr-code-box.customer img { border-color: #A5B4FC; }
    .qr-code-box.inventory img { border-color: #CBD5E1; }
    .qr-code-label { margin-top: 0.75rem; font-weight: 600; font-size: 0.9rem; }
    .qr-code-box.customer .qr-code-label { color: #4F46E5; }
    .qr-code-box.inventory .qr-code-label { color: #64748B; }
    .qr-download-buttons { display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; }
    .qr-download-btn {
      padding: 0.75rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .qr-download-btn.customer {
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white; border: none;
    }
    .qr-download-btn.customer:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }
    .qr-download-btn.inventory {
      background: white; color: #64748B; border: 2px solid #CBD5E1;
    }
    .qr-download-btn.inventory:hover { background: #F8FAFC; }
    .qr-download-btn.both {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      color: white; border: none;
    }
    .qr-download-btn.both:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }

    /* Batch Modal */
    .batch-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .batch-modal-overlay.show { display: flex; }
    .batch-modal {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .batch-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #E2E8F0;
    }
    .batch-modal-header h2 { font-size: 1.5rem; font-weight: 700; color: #1E293B; margin: 0; }
    .batch-modal-close {
      background: #F1F5F9; 
      border: none; 
      font-size: 1.25rem; 
      color: #64748B;
      cursor: pointer; 
      padding: 0.75rem; 
      border-radius: 10px;
      transition: all 0.2s;
    }
    .batch-modal-close:hover { background: #E2E8F0; color: #1E293B; }
    .batch-modal-body {
      padding: 1.5rem 2rem;
      overflow-y: auto;
      flex: 1;
    }
    .batch-modal-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border: 1px solid #E2E8F0;
    }
    .batch-modal-item-info { display: flex; flex-direction: column; gap: 0.25rem; }
    .batch-modal-item-name { font-weight: 700; font-size: 1rem; color: #1E293B; }
    .batch-modal-item-sku { font-size: 0.8rem; color: #64748B; }
    .batch-modal-item-actions { display: flex; gap: 0.5rem; }

    /* ZIP Download Modal */
    .zip-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .zip-modal-overlay.show { display: flex; }
    .zip-modal {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .zip-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .zip-modal-header h2 {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1E293B;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .zip-modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #94A3B8;
      cursor: pointer;
      padding: 0.25rem;
    }
    .zip-modal-close:hover { color: #1E293B; }
    .zip-modal-subtitle {
      color: #64748B;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    .zip-modal-options {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .zip-option-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    .zip-option-btn:hover {
      border-color: #10B981;
      background: #F0FDF4;
    }
    .zip-option-btn.both {
      border-color: #F59E0B;
      background: #FFFBEB;
    }
    .zip-option-btn.both:hover {
      border-color: #D97706;
      background: #FEF3C7;
    }
    .zip-option-btn i {
      font-size: 1.5rem;
      color: #10B981;
      margin-bottom: 0.5rem;
    }
    .zip-option-btn.both i { color: #F59E0B; }
    .zip-option-btn span {
      font-weight: 600;
      color: #1E293B;
      font-size: 1rem;
    }
    .zip-option-btn small {
      color: #64748B;
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    .zip-option-btn.downloading {
      pointer-events: none;
      opacity: 0.7;
    }
    .zip-cancel-btn {
      background: none;
      border: none;
      color: #64748B;
      font-size: 0.9rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      margin-top: 0.5rem;
    }
    .zip-cancel-btn:hover { color: #1E293B; }

    /* Label Builder Modal */
    .label-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1300;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .label-modal-overlay.show { display: flex; }
    .label-modal {
      background: white;
      border-radius: 20px;
      width: 95%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .label-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem 2rem;
      border-bottom: 2px solid #E2E8F0;
    }
    .label-modal-header h2 { font-size: 1.25rem; font-weight: 700; color: #1E293B; display: flex; align-items: center; gap: 0.5rem; }
    .label-modal-header h2 i { color: #10B981; }
    .label-modal-body { padding: 1.5rem 2rem; overflow-y: auto; flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .label-config-section h4 { font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
    .label-config-section h4 i { color: #4F46E5; }
    .size-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
    .size-option { padding: 0.6rem; border: 2px solid #E2E8F0; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .size-option:hover { border-color: #4F46E5; }
    .size-option.selected { border-color: #4F46E5; background: #F5F3FF; }
    .size-option-name { font-weight: 600; font-size: 0.8rem; color: #334155; }
    .size-option-dims { font-size: 0.7rem; color: #64748B; }
    .custom-size-inputs { display: none; gap: 0.5rem; margin-bottom: 1rem; }
    .custom-size-inputs.show { display: flex; }
    .custom-size-inputs input { width: 80px; padding: 0.5rem; border: 2px solid #E2E8F0; border-radius: 8px; text-align: center; }
    .element-toggles { display: flex; flex-direction: column; gap: 0.5rem; }
    .element-toggle { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: #F8FAFC; border-radius: 8px; }
    .element-toggle input { width: 18px; height: 18px; cursor: pointer; }
    .element-toggle label { font-size: 0.85rem; font-weight: 500; color: #334155; cursor: pointer; flex: 1; }
    .element-toggle.disabled { opacity: 0.5; }
    .label-preview-section { background: #F8FAFC; border-radius: 12px; padding: 1rem; display: flex; flex-direction: column; align-items: center; }
    .label-preview-controls { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .label-preview-container { border: 1px solid #E2E8F0; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
    .label-preview-container .label-element { position: absolute; cursor: move; }
    .label-preview-container .label-element.dragging { opacity: 0.7; z-index: 10; }
    .label-modal-footer { padding: 1rem 2rem; border-top: 2px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }
    
    /* Net Quantity styling in preview */
    .net-quantity-display {
      background: rgba(255,255,255,0.95);
      border: 1px solid #334155;
      border-radius: 4px;
      padding: 2px 6px;
      font-weight: 700;
      text-align: center;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #E2E8F0;
    }
    .pagination-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #E2E8F0;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .pagination-btn:hover:not(:disabled) { border-color: #4F46E5; color: #4F46E5; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination-btn.active { background: #4F46E5; color: white; border-color: #4F46E5; }
    .pagination-info { color: #64748B; font-size: 0.9rem; margin: 0 1rem; }

    @media (max-width: 768px) {
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; padding-top: 5rem; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .header-stats { width: 100%; }
      .stat-box { flex: 1; }
      .products-grid { grid-template-columns: 1fr; }
      .qr-codes-container { grid-template-columns: 1fr; }
      .label-modal-body { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <script src="js/SI-sidebar.js"></script>

  <div class="main-with-sidebar">
    <div class="page-header">
      <div>
        <h1><i class="fas fa-box-check" style="color: #4F46E5;"></i> Finished Products</h1>
        <p>All your live and finalized products ready for customer verification.</p>
      </div>
      <div class="header-stats">
        <div class="stat-box">
          <div class="stat-box-value" id="totalProducts">-</div>
          <div class="stat-box-label">Total Products</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-value" id="totalBatches">-</div>
          <div class="stat-box-label">Batches</div>
        </div>
      </div>
    </div>

    <!-- Company Logo Banner -->
    <div class="logo-banner" id="logoBanner">
      <input type="file" id="logoInput" accept="image/*" style="display: none;" />
      <div class="logo-upload-slot" id="logoSlot" onclick="document.getElementById('logoInput').click()">
        <i class="fas fa-image" id="logoPlaceholder"></i>
        <img id="logoPreview" src="" style="display: none;" />
      </div>
      <div class="logo-banner-text">
        <h3>Company Logo</h3>
        <p id="logoStatus">Click to upload your logo for product labels</p>
      </div>
      <div class="logo-banner-actions" id="logoActions" style="display: none;">
        <button class="logo-change-btn" onclick="document.getElementById('logoInput').click()">Change</button>
        <button class="logo-remove-btn" onclick="removeCompanyLogo()">Remove</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search by name, SKU, or batch..." />
      </div>
      <select class="filter-select" id="sortSelect">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="name-az">Name A-Z</option>
        <option value="name-za">Name Z-A</option>
      </select>
      <select class="filter-select" id="typeSelect">
        <option value="all">All Types</option>
        <option value="single">Single Products</option>
        <option value="batch">Batches Only</option>
      </select>
      <button class="clear-filters" onclick="clearFilters()">
        <i class="fas fa-times"></i> Clear
      </button>
    </div>

    <!-- Products Grid -->
    <div id="productsContainer">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading products...</p>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination" style="display: none;"></div>
  </div>

  <!-- QR Code Modal -->
  <div class="qr-modal-overlay" id="qrModalOverlay" onclick="closeQRModal(event)">
    <div class="qr-modal" onclick="event.stopPropagation()">
      <div class="qr-modal-header">
        <h2><i class="fas fa-qrcode" style="color: #4F46E5;"></i> QR Codes</h2>
        <button class="qr-modal-close" onclick="closeQRModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="qr-modal-sku"><span id="modalSku">SKU: ---</span></div>
      <div class="qr-codes-container">
        <div class="qr-code-box customer">
          <div class="qr-loading" id="customerQRLoading"><i class="fas fa-spinner fa-spin"></i></div>
          <img id="modalCustomerQR" src="" alt="Customer QR" onload="this.previousElementSibling.style.display='none'" />
          <div class="qr-code-label">Customer</div>
        </div>
        <div class="qr-code-box inventory" id="inventoryQRBox">
          <div class="qr-loading" id="inventoryQRLoading"><i class="fas fa-spinner fa-spin"></i></div>
          <img id="modalInventoryQR" src="" alt="Inventory QR" onload="this.previousElementSibling.style.display='none'" />
          <div class="qr-code-label">Inventory</div>
        </div>
      </div>
      <div class="qr-download-buttons">
        <button id="downloadCustomerBtn" class="qr-download-btn customer" onclick="downloadQR('customer')"><i class="fas fa-download"></i> Customer</button>
        <button id="downloadInventoryBtn" class="qr-download-btn inventory" onclick="downloadQR('inventory')"><i class="fas fa-download"></i> Inventory</button>
        <button id="downloadBothBtn" class="qr-download-btn both" onclick="downloadBothQRs()"><i class="fas fa-layer-group"></i> Both</button>
      </div>
    </div>
  </div>

  <!-- Batch Items Modal -->
  <div class="batch-modal-overlay" id="batchModalOverlay" onclick="closeBatchModal(event)">
    <div class="batch-modal" onclick="event.stopPropagation()">
      <div class="batch-modal-header">
        <div>
          <h2 id="batchModalTitle">Batch Items</h2>
          <p id="batchModalSubtitle" style="color: #64748B; font-size: 0.9rem; margin-top: 0.25rem;"></p>
        </div>
        <button class="batch-modal-close" onclick="closeBatchModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="batch-modal-body" id="batchModalBody"></div>
    </div>
  </div>

  <!-- ZIP Download Modal -->
  <div class="zip-modal-overlay" id="zipModalOverlay" onclick="closeZipModal(event)">
    <div class="zip-modal" onclick="event.stopPropagation()">
      <div class="zip-modal-header">
        <h2><i class="fas fa-file-archive" style="color: #10B981;"></i> Download ZIP</h2>
        <button class="zip-modal-close" onclick="closeZipModal()"><i class="fas fa-times"></i></button>
      </div>
      <p class="zip-modal-subtitle" id="zipModalSubtitle">Choose which QR codes to download</p>
      <div class="zip-modal-options">
        <button class="zip-option-btn" onclick="downloadBatchZip('customer')">
          <i class="fas fa-mobile-alt"></i><span>Customer QRs</span><small>Verification links for customers</small>
        </button>
        <button class="zip-option-btn" onclick="downloadBatchZip('inventory')">
          <i class="fas fa-barcode"></i><span>Inventory QRs</span><small>Raw SKU codes for internal use</small>
        </button>
        <button class="zip-option-btn both" onclick="downloadBatchZip('both')">
          <i class="fas fa-layer-group"></i><span>Both</span><small>All QR codes in one ZIP</small>
        </button>
      </div>
      <button class="zip-cancel-btn" onclick="closeZipModal()">Cancel</button>
    </div>
  </div>

  <!-- Full Label Builder Modal -->
  <div class="label-modal-overlay" id="labelModalOverlay" onclick="closeLabelModal(event)">
    <div class="label-modal" onclick="event.stopPropagation()">
      <div class="label-modal-header">
        <h2><i class="fas fa-tag"></i> Full Label Builder</h2>
        <button class="batch-modal-close" onclick="closeLabelModal()"><i class="fas fa-times"></i></button>
      </div>
      <div id="labelBatchInfo" style="padding: 0 2rem; color: #64748B; font-size: 0.9rem;"></div>
      <div class="label-modal-body">
        <div class="label-config-section">
          <h4><i class="fas fa-ruler-combined"></i> Sticker Size</h4>
          <div class="size-options">
            <div class="size-option selected" data-width="4" data-height="3" onclick="selectSize(this)">
              <div class="size-option-name">Standard</div><div class="size-option-dims">4" × 3"</div>
            </div>
            <div class="size-option" data-width="4" data-height="6" onclick="selectSize(this)">
              <div class="size-option-name">Tall</div><div class="size-option-dims">4" × 6"</div>
            </div>
            <div class="size-option" data-width="2" data-height="4" onclick="selectSize(this)">
              <div class="size-option-name">Slim</div><div class="size-option-dims">2" × 4"</div>
            </div>
            <div class="size-option" data-width="3" data-height="3" onclick="selectSize(this)">
              <div class="size-option-name">Square</div><div class="size-option-dims">3" × 3"</div>
            </div>
            <div class="size-option" data-width="2.25" data-height="7.5" onclick="selectSize(this)">
              <div class="size-option-name">Bottle</div><div class="size-option-dims">2.25" × 7.5"</div>
            </div>
            <div class="size-option" data-width="0" data-height="0" onclick="selectSize(this)">
              <div class="size-option-name">Custom</div><div class="size-option-dims">Your size</div>
            </div>
          </div>
          <div class="custom-size-inputs" id="customSizeInputs">
            <input type="number" id="customWidth" placeholder="Width" step="0.25" min="1" max="12" value="4" onchange="updateCustomSize()" />
            <span style="color: #64748B;">×</span>
            <input type="number" id="customHeight" placeholder="Height" step="0.25" min="1" max="12" value="6" onchange="updateCustomSize()" />
            <span style="color: #64748B;">inches</span>
          </div>
          <h4 style="margin-top: 1.5rem;"><i class="fas fa-layer-group"></i> Include Elements</h4>
          <div class="element-toggles">
            <div class="element-toggle"><input type="checkbox" id="includeLogo" checked onchange="updatePreview()" /><label for="includeLogo">Company Logo</label></div>
<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #F5F3FF; border-radius: 8px; margin-top: 0.25rem; margin-bottom: 0.5rem;">
  <label style="font-size: 0.75rem; font-weight: 600; color: #4F46E5; min-width: 50px;">Size</label>
  <input type="range" id="logoSizeSlider" min="40" max="95" value="75" onchange="updatePreview(); document.getElementById('logoSizeDisplay').textContent = this.value + '%';" oninput="updatePreview(); document.getElementById('logoSizeDisplay').textContent = this.value + '%';" style="flex: 1;" />
  <span id="logoSizeDisplay" style="font-size: 0.75rem; color: #64748B; min-width: 35px;">75%</span>
</div>
            <div class="element-toggle" id="netQuantityToggle"><input type="checkbox" id="includeNetQuantity" checked onchange="updatePreview()" /><label for="includeNetQuantity">Net Quantity (FDA Required)</label></div>
<div id="netQuantityOptions" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #F0FDF4; border-radius: 8px; margin-top: 0.25rem; margin-bottom: 0.5rem;">
  <label style="font-size: 0.75rem; font-weight: 600; color: #059669; min-width: 50px;">Color</label>
  <input type="color" id="netQuantityColor" value="#1E293B" onchange="updatePreview()" style="width: 32px; height: 24px; border: 1px solid #10B981; border-radius: 4px; cursor: pointer;" />
</div>
            <div class="element-toggle"><input type="checkbox" id="includeNutrition" onchange="updatePreview()" /><label for="includeNutrition">Nutrition Facts</label></div>
            <div class="element-toggle"><input type="checkbox" id="includeCustomerQR" checked onchange="updatePreview()" /><label for="includeCustomerQR">Customer QR Code</label></div>
            <div class="element-toggle"><input type="checkbox" id="includeInventoryQR" onchange="updatePreview()" /><label for="includeInventoryQR">Inventory QR Code</label></div>
          </div>
          <h4 style="margin-top: 1.5rem;"><i class="fas fa-palette"></i> Label Style</h4>
<div class="style-options" style="display: flex; flex-direction: column; gap: 0.75rem;">
  <div style="display: flex; align-items: center; gap: 0.75rem;">
    <label style="font-size: 0.85rem; font-weight: 500; color: #334155; min-width: 100px;">Background</label>
    <input type="color" id="labelBgColor" value="#ffffff" onchange="updatePreview()" style="width: 40px; height: 32px; border: 2px solid #E2E8F0; border-radius: 6px; cursor: pointer; padding: 2px;" />
    <button class="btn btn-secondary" onclick="document.getElementById('labelBgColor').value='#ffffff'; updatePreview();" style="padding: 0.4rem 0.6rem; font-size: 0.75rem;">Reset</button>
  </div>
  <div style="display: flex; align-items: center; gap: 0.75rem;">
    <label style="font-size: 0.85rem; font-weight: 500; color: #334155; min-width: 100px;">Border</label>
    <select id="labelBorderStyle" onchange="updatePreview()" style="padding: 0.4rem 0.6rem; border: 2px solid #E2E8F0; border-radius: 6px; font-size: 0.85rem;">
      <option value="none">None</option>
      <option value="solid">Solid</option>
      <option value="double">Double</option>
      <option value="dashed">Dashed</option>
      <option value="rounded">Rounded</option>
    </select>
    <input type="color" id="labelBorderColor" value="#1E293B" onchange="updatePreview()" style="width: 40px; height: 32px; border: 2px solid #E2E8F0; border-radius: 6px; cursor: pointer; padding: 2px;" />
  </div>
  <div style="display: flex; align-items: center; gap: 0.75rem;">
    <label style="font-size: 0.85rem; font-weight: 500; color: #334155; min-width: 100px;">Border Width</label>
    <input type="range" id="labelBorderWidth" min="1" max="6" value="2" onchange="updatePreview(); document.getElementById('borderWidthDisplay').textContent = this.value + 'px';" style="flex: 1;" />
    <span id="borderWidthDisplay" style="font-size: 0.8rem; color: #64748B; min-width: 30px;">2px</span>
  </div>
</div>
<h4 style="margin-top: 1.5rem;"><i class="fas fa-file-alt"></i> Print Layout</h4>
<div id="printLayoutInfo" style="background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
  <div style="font-size: 0.85rem; color: #0369A1; margin-bottom: 0.5rem;">
    <span id="layoutRecommendation">Calculating...</span>
  </div>
  <div style="display: flex; align-items: center; gap: 0.75rem;">
    <label style="font-size: 0.85rem; font-weight: 500; color: #334155;">Labels per sheet:</label>
    <select id="labelsPerSheet" onchange="updateLayoutInfo()" style="padding: 0.4rem 0.6rem; border: 2px solid #E2E8F0; border-radius: 6px; font-size: 0.85rem; min-width: 80px;">
      <option value="1">1</option>
    </select>
  </div>
  <div style="font-size: 0.8rem; color: #64748B; margin-top: 0.5rem;">
    <i class="fas fa-info-circle"></i> <span id="pageCountInfo">This will create 1 page</span>
  </div>
</div>
        </div>
        <div class="label-preview-section">
          <h4 style="align-self: flex-start; margin-bottom: 0;"><i class="fas fa-eye" style="color: #4F46E5;"></i> Preview</h4>
          <div class="label-preview-controls">
            <button class="btn btn-secondary" onclick="zoomPreview(-25)" style="padding: 0.4rem 0.6rem;"><i class="fas fa-minus"></i></button>
            <span id="zoomLevel" style="font-size: 0.8rem; color: #64748B; min-width: 50px; text-align: center;">100%</span>
            <button class="btn btn-secondary" onclick="zoomPreview(25)" style="padding: 0.4rem 0.6rem;"><i class="fas fa-plus"></i></button>
          </div>
          <div class="label-preview-container" id="labelPreview" style="width: 288px; height: 216px;"></div>
        </div>
      </div>
      <div class="label-modal-footer">
        <button class="btn btn-secondary" onclick="closeLabelModal()">Cancel</button>
        <button class="btn btn-success" id="downloadLabelsBtn" onclick="downloadLabels()"><i class="fas fa-download"></i> Download Labels (PDF)</button>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 12;
    let currentQRData = null;
    let currentZipBatchGroupId = null;
    let currentZipProductName = null;

    // ==========================================
    // COMPANY LOGO
    // ==========================================
    let companyLogo = null;

    function initCompanyLogo() {
      const saved = localStorage.getItem('biztrack_company_logo');
      if (saved) {
        companyLogo = saved;
        document.getElementById('logoPreview').src = saved;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
        document.getElementById('logoActions').style.display = 'flex';
        document.getElementById('logoStatus').textContent = 'Logo saved for all labels';
      }
    }

    document.getElementById('logoInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        companyLogo = ev.target.result;
        localStorage.setItem('biztrack_company_logo', companyLogo);
        document.getElementById('logoPreview').src = companyLogo;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('logoPlaceholder').style.display = 'none';
        document.getElementById('logoActions').style.display = 'flex';
        document.getElementById('logoStatus').textContent = 'Logo saved for all labels';
      };
      reader.readAsDataURL(file);
    });

    window.removeCompanyLogo = function() {
      companyLogo = null;
      localStorage.removeItem('biztrack_company_logo');
      document.getElementById('logoPreview').src = '';
      document.getElementById('logoPreview').style.display = 'none';
      document.getElementById('logoPlaceholder').style.display = 'block';
      document.getElementById('logoActions').style.display = 'none';
      document.getElementById('logoStatus').textContent = 'Click to upload your logo for product labels';
    };

    // ==========================================
    // LABEL BUILDER
    // ==========================================
    let currentLabelBatch = null;
    let labelConfig = {
  width: 4, height: 3,
  bgColor: '#ffffff',
  borderStyle: 'none',
  borderColor: '#1E293B',
  borderWidth: 2,
  logoSize: 75,
  netQuantityColor: '#1E293B',
  elements: {
        logo: { enabled: true, x: 'center', y: 10, width: 140, height: 120 },
        netQuantity: { enabled: true, x: 'center', y: 'below-logo', width: 80, height: 24 },
        nutrition: { enabled: false, x: 10, y: 'below-netqty', width: 100, height: 120 },
        customerQR: { enabled: true, x: 'right', y: 'bottom', width: 60, height: 60 },
        inventoryQR: { enabled: false, x: 'left', y: 'bottom', width: 60, height: 60 }
      }
    };
    let previewZoom = 100;
    

    window.openLabelBuilder = function() {
      closeZipModal();
      const batch = allProducts.find(p => p.batchGroupId === currentZipBatchGroupId);
      if (!batch) { alert('Batch not found'); return; }
      currentLabelBatch = batch;
      document.getElementById('labelBatchInfo').innerHTML = 'Batch: <strong>' + escapeHtml(batch.metadata?.batchDisplayName || batch.productName) + '</strong> • <strong>' + (batch.items?.length || 1) + '</strong> labels';
      
      // Check for nutrition data
      const hasNutrition = batch.items?.[0]?.metadata?.nutritionFacts || batch.metadata?.nutritionFacts;
      document.getElementById('includeNutrition').checked = !!hasNutrition;
      document.getElementById('includeNutrition').disabled = !hasNutrition;
      document.getElementById('includeNutrition').parentElement.style.opacity = hasNutrition ? '1' : '0.5';
      
      // Check for net quantity data
      const hasNetQuantity = batch.items?.[0]?.metadata?.netQuantity || batch.metadata?.netQuantity;
      document.getElementById('includeNetQuantity').checked = !!hasNetQuantity;
      document.getElementById('includeNetQuantity').disabled = !hasNetQuantity;
      document.getElementById('netQuantityToggle').style.opacity = hasNetQuantity ? '1' : '0.5';
      
      updatePreview();
      document.getElementById('labelModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    };

    window.openSingleLabel = function(p) {
      if (typeof p === 'string') p = JSON.parse(p);
      currentLabelBatch = { ...p, items: [p] };
      document.getElementById('labelBatchInfo').innerHTML = 'Product: <strong>' + escapeHtml(p.productName) + '</strong>';
      
      // Check for nutrition data
      const hasNutrition = p.metadata?.nutritionFacts;
      document.getElementById('includeNutrition').checked = !!hasNutrition;
      document.getElementById('includeNutrition').disabled = !hasNutrition;
      document.getElementById('includeNutrition').parentElement.style.opacity = hasNutrition ? '1' : '0.5';
      
      // Check for net quantity data
      const hasNetQuantity = p.metadata?.netQuantity;
      document.getElementById('includeNetQuantity').checked = !!hasNetQuantity;
      document.getElementById('includeNetQuantity').disabled = !hasNetQuantity;
      document.getElementById('netQuantityToggle').style.opacity = hasNetQuantity ? '1' : '0.5';
      
      updatePreview();
      document.getElementById('labelModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    };

    window.closeLabelModal = function(e) {
      if (e && e.target !== e.currentTarget) return;
      document.getElementById('labelModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
      currentLabelBatch = null;
      rearrangeMode = false;
    };

    window.selectSize = function(el) {
      document.querySelectorAll('.size-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      const w = parseFloat(el.dataset.width), h = parseFloat(el.dataset.height);
      if (w === 0) {
        document.getElementById('customSizeInputs').classList.add('show');
        labelConfig.width = parseFloat(document.getElementById('customWidth').value) || 4;
        labelConfig.height = parseFloat(document.getElementById('customHeight').value) || 6;
      } else {
        document.getElementById('customSizeInputs').classList.remove('show');
        labelConfig.width = w;
        labelConfig.height = h;
      }
      updatePreview();
      updateLayoutInfo();
    };

    window.updateCustomSize = function() {
      labelConfig.width = parseFloat(document.getElementById('customWidth').value) || 4;
      labelConfig.height = parseFloat(document.getElementById('customHeight').value) || 6;
      updatePreview();
      updateLayoutInfo();
    };

    window.downloadLabels = async function() {
      if (!currentLabelBatch) return;
      const btn = document.getElementById('downloadLabelsBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
      
      try {
        const { jsPDF } = window.jspdf;
        const items = currentLabelBatch.items || [currentLabelBatch];
        
        const pageW = 8.5;
        const pageH = 11;
        const margin = 0.25;
        const labelW = labelConfig.width;
        const labelH = labelConfig.height;
        
        const maxPerSheet = calculateMaxLabelsPerSheet();
        const userLabelsPerSheet = parseInt(document.getElementById('labelsPerSheet')?.value) || maxPerSheet;
        
        const maxCols = Math.floor((pageW - margin * 2) / labelW);
        const maxRows = Math.floor((pageH - margin * 2) / labelH);
        
        let cols, rows;
        if (userLabelsPerSheet >= maxCols * maxRows) {
          cols = maxCols;
          rows = maxRows;
        } else if (userLabelsPerSheet <= maxCols) {
          cols = userLabelsPerSheet;
          rows = 1;
        } else {
          cols = maxCols;
          rows = Math.ceil(userLabelsPerSheet / maxCols);
        }
        const labelsPerPage = cols * rows;
        
        const gridW = cols * labelW;
        const gridH = rows * labelH;
        const offsetX = (pageW - gridW) / 2;
        const offsetY = (pageH - gridH) / 2;
        
        const bgColor = labelConfig.bgColor || '#ffffff';
        const borderStyle = labelConfig.borderStyle || 'none';
        const borderColor = labelConfig.borderColor || '#1E293B';
        const borderWidth = (labelConfig.borderWidth || 2) / 72;
        
        function hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : { r: 255, g: 255, b: 255 };
        }
        
        const bgRgb = hexToRgb(bgColor);
        const borderRgb = hexToRgb(borderColor);
        
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });
        
        const nf = items[0]?.metadata?.nutritionFacts || currentLabelBatch?.metadata?.nutritionFacts || {};
        const nq = items[0]?.metadata?.netQuantity || currentLabelBatch?.metadata?.netQuantity;
        
        const logoPercent = (labelConfig.logoSize || 75) / 100;
const logoW = labelW * logoPercent;
const logoH = labelH * 0.55 * logoPercent;
        const logoX = (labelW - logoW) / 2;
        const logoY = 0.15;
        
        const netQtyW = 1.0;
        const netQtyH = 0.3;
        const netQtyX = (labelW - netQtyW) / 2;
        const netQtyY = logoY + logoH + 0.1;
        
        const qrSize = Math.min(0.7, labelW * 0.28);
        const qrPadding = 0.08;
        const qrX = labelW - qrSize - qrPadding - 0.15;
        const qrY = labelH - qrSize - qrPadding - 0.25;
        
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          const posOnPage = i % labelsPerPage;
          
          if (posOnPage === 0 && i > 0) {
            pdf.addPage('letter', 'portrait');
          }
          
          const col = posOnPage % cols;
          const row = Math.floor(posOnPage / cols);
          const x = offsetX + (col * labelW);
          const y = offsetY + (row * labelH);
          
          pdf.setFillColor(bgRgb.r, bgRgb.g, bgRgb.b);
          pdf.rect(x, y, labelW, labelH, 'F');
          
          if (borderStyle !== 'none') {
            pdf.setDrawColor(borderRgb.r, borderRgb.g, borderRgb.b);
            pdf.setLineWidth(borderWidth);
            if (borderStyle === 'double') {
              pdf.rect(x + borderWidth, y + borderWidth, labelW - borderWidth * 2, labelH - borderWidth * 2);
              pdf.rect(x + borderWidth * 3, y + borderWidth * 3, labelW - borderWidth * 6, labelH - borderWidth * 6);
            } else if (borderStyle === 'dashed') {
              pdf.setLineDashPattern([0.1, 0.05], 0);
              pdf.rect(x + borderWidth / 2, y + borderWidth / 2, labelW - borderWidth, labelH - borderWidth);
              pdf.setLineDashPattern([], 0);
            } else {
              pdf.rect(x + borderWidth / 2, y + borderWidth / 2, labelW - borderWidth, labelH - borderWidth);
            }
          }
          
          if (labelConfig.elements.logo.enabled && companyLogo) {
            try { pdf.addImage(companyLogo, 'PNG', x + logoX, y + logoY, logoW, logoH); } catch (e) {}
          }
          
         if (labelConfig.elements.netQuantity.enabled && nq) {
  const nqText = nq.display || (nq.value + ' ' + nq.unit);
  const nqColorHex = labelConfig.netQuantityColor || '#1E293B';
  const nqRgb = hexToRgb(nqColorHex);
  pdf.setFontSize(11);
  pdf.setFont('helvetica', 'bold');
  pdf.setTextColor(nqRgb.r, nqRgb.g, nqRgb.b);
  const nqX = labelConfig.elements.inventoryQR.enabled ? (qrPadding + qrSize + 0.1) : 0.12;
  const nqY = qrY + qrSize - 0.02;
  pdf.text(nqText, x + nqX, y + nqY);
}
          
          if (labelConfig.elements.nutrition.enabled) {
            const nutX = 0.12;
            const nutY = netQtyY + netQtyH + 0.15;
            const nutW = Math.min(1.2, labelW * 0.4);
            const nutH = Math.min(1.5, labelH * 0.3);
            pdf.setFillColor(255, 255, 255);
            pdf.setDrawColor(0);
            pdf.setLineWidth(0.015);
            pdf.rect(x + nutX, y + nutY, nutW, nutH, 'FD');
            pdf.setFontSize(7);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(0);
            pdf.text('Nutrition Facts', x + nutX + 0.04, y + nutY + 0.1);
            pdf.setLineWidth(0.01);
            pdf.line(x + nutX, y + nutY + 0.12, x + nutX + nutW, y + nutY + 0.12);
            pdf.setFontSize(5);
            pdf.setFont('helvetica', 'normal');
            let ty = nutY + 0.18;
            pdf.text('Serving: ' + (nf.servingSize || '___'), x + nutX + 0.04, y + ty); ty += 0.07;
            pdf.setFont('helvetica', 'bold');
            pdf.text('Calories: ' + (nf.calories || '0'), x + nutX + 0.04, y + ty); ty += 0.07;
            pdf.setFont('helvetica', 'normal');
            pdf.text('Total Fat: ' + (nf.totalFat || '0') + 'g', x + nutX + 0.04, y + ty); ty += 0.07;
            pdf.text('Total Carbs: ' + (nf.totalCarbs || '0') + 'g', x + nutX + 0.04, y + ty); ty += 0.07;
            pdf.text('Protein: ' + (nf.protein || '0') + 'g', x + nutX + 0.04, y + ty);
          }
          
          if (labelConfig.elements.customerQR.enabled && item.qrCodeUrl) {
            try {
              pdf.setFillColor(255, 255, 255);
              pdf.rect(x + qrX - qrPadding, y + qrY - qrPadding, qrSize + qrPadding * 2, qrSize + qrPadding * 2 + 0.1, 'F');
              const img = await loadImageAsDataUrl(item.qrCodeUrl);
              pdf.addImage(img, 'PNG', x + qrX, y + qrY, qrSize, qrSize);
              pdf.setFontSize(4);
              pdf.setFont('helvetica', 'bold');
              pdf.setTextColor(30, 41, 59);
              pdf.text('SCAN TO VERIFY', x + qrX + qrSize / 2, y + qrY + qrSize + 0.08, { align: 'center' });
            } catch (e) {}
          }
          
          if (labelConfig.elements.inventoryQR.enabled && item.inventoryQrCodeUrl) {
            const invQrX = 0.15 + qrPadding;
            try {
              pdf.setFillColor(255, 255, 255);
              pdf.rect(x + invQrX - qrPadding, y + qrY - qrPadding, qrSize + qrPadding * 2, qrSize + qrPadding * 2 + 0.08, 'F');
              const img = await loadImageAsDataUrl(item.inventoryQrCodeUrl);
              pdf.addImage(img, 'PNG', x + invQrX, y + qrY, qrSize, qrSize);
              pdf.setFontSize(3);
              pdf.setTextColor(100);
              pdf.text('INVENTORY', x + invQrX + qrSize / 2, y + qrY + qrSize + 0.06, { align: 'center' });
            } catch (e) {}
          }
          
          pdf.setFontSize(3);
          pdf.setTextColor(150);
          pdf.text('SKU: ' + (item.sku || item.productId), x + labelW / 2, y + labelH - 0.06, { align: 'center' });
        }
        
        const totalPages = Math.ceil(items.length / labelsPerPage);
        const fileName = (currentLabelBatch.metadata?.batchDisplayName || currentLabelBatch.productName || 'labels').replace(/[^a-z0-9]/gi, '_');
        pdf.save(fileName + '_' + items.length + 'labels_' + totalPages + 'pages.pdf');
        
        btn.innerHTML = '<i class="fas fa-check"></i> Done! ' + items.length + ' labels on ' + totalPages + ' page(s)';
        setTimeout(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-download"></i> Download Labels (PDF)'; }, 3000);
        
      } catch (err) {
        console.error('PDF Error:', err);
   alert('PDF Error: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> Download Labels (PDF)';
      }
    };
window.zoomPreview = function(d) {
      previewZoom = Math.max(50, Math.min(200, previewZoom + d));
      document.getElementById('zoomLevel').textContent = previewZoom + '%';
      updatePreview();
    };

    function calculateMaxLabelsPerSheet() {
      const pageW = 8.5, pageH = 11, margin = 0.25;
      const usableW = pageW - (margin * 2);
      const usableH = pageH - (margin * 2);
      const cols = Math.floor(usableW / labelConfig.width);
      const rows = Math.floor(usableH / labelConfig.height);
      return Math.max(1, cols * rows);
    }

    function updateLayoutInfo() {
      const maxPerSheet = calculateMaxLabelsPerSheet();
      const select = document.getElementById('labelsPerSheet');
      const currentVal = parseInt(select.value) || maxPerSheet;
      select.innerHTML = '';
      for (let i = maxPerSheet; i >= 1; i--) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i + (i === maxPerSheet ? ' (recommended)' : '');
        select.appendChild(opt);
      }
      select.value = Math.min(currentVal, maxPerSheet);
      const cols = Math.floor(8 / labelConfig.width);
      const rows = Math.floor(10.5 / labelConfig.height);
      document.getElementById('layoutRecommendation').innerHTML = 'Based on your <strong>' + labelConfig.width + '" × ' + labelConfig.height + '"</strong> labels: <strong>' + maxPerSheet + ' per sheet</strong> (' + Math.max(1,cols) + ' across × ' + Math.max(1,rows) + ' down)';
      const itemCount = currentLabelBatch?.items?.length || 1;
      const labelsPerSheet = parseInt(select.value) || maxPerSheet;
      const totalPages = Math.ceil(itemCount / labelsPerSheet);
      document.getElementById('pageCountInfo').innerHTML = '📋 This will create <strong>' + totalPages + ' page' + (totalPages > 1 ? 's' : '') + '</strong> for <strong>' + itemCount + ' label' + (itemCount > 1 ? 's' : '') + '</strong>';
    }

  function updatePreview() {
  const preview = document.getElementById('labelPreview');
  const scale = previewZoom / 100;
  const pxPerInch = 72;
  const w = labelConfig.width * pxPerInch * scale;
  const h = labelConfig.height * pxPerInch * scale;
  
  preview.style.width = w + 'px';
  preview.style.height = h + 'px';
  
  // Get style settings
  const bgColor = document.getElementById('labelBgColor')?.value || '#ffffff';
  const borderStyle = document.getElementById('labelBorderStyle')?.value || 'none';
  const borderColor = document.getElementById('labelBorderColor')?.value || '#1E293B';
  const borderWidth = parseInt(document.getElementById('labelBorderWidth')?.value) || 2;
  const logoSize = parseInt(document.getElementById('logoSizeSlider')?.value) || 75;
  const netQuantityColor = document.getElementById('netQuantityColor')?.value || '#1E293B';
  
  // Update labelConfig
  labelConfig.bgColor = bgColor;
  labelConfig.borderStyle = borderStyle;
  labelConfig.borderColor = borderColor;
  labelConfig.borderWidth = borderWidth;
  labelConfig.logoSize = logoSize;
  labelConfig.netQuantityColor = netQuantityColor;
  
  // Update element enabled states
  labelConfig.elements.logo.enabled = document.getElementById('includeLogo')?.checked ?? true;
  labelConfig.elements.netQuantity.enabled = document.getElementById('includeNetQuantity')?.checked ?? true;
  labelConfig.elements.nutrition.enabled = document.getElementById('includeNutrition')?.checked ?? false;
  labelConfig.elements.customerQR.enabled = document.getElementById('includeCustomerQR')?.checked ?? true;
  labelConfig.elements.inventoryQR.enabled = document.getElementById('includeInventoryQR')?.checked ?? false;
  
  // Apply background
  preview.style.background = bgColor;
  
  // Apply border
  preview.style.borderRadius = '0';
  if (borderStyle === 'none') {
    preview.style.border = '1px solid #E2E8F0';
  } else if (borderStyle === 'double') {
    preview.style.border = borderWidth + 'px double ' + borderColor;
  } else if (borderStyle === 'dashed') {
    preview.style.border = borderWidth + 'px dashed ' + borderColor;
  } else if (borderStyle === 'rounded') {
    preview.style.border = borderWidth + 'px solid ' + borderColor;
    preview.style.borderRadius = '12px';
  } else {
    preview.style.border = borderWidth + 'px solid ' + borderColor;
  }
  
  // Build preview content
  let html = '';
  const item = currentLabelBatch?.items?.[0] || currentLabelBatch || {};
  const nf = item.metadata?.nutritionFacts || currentLabelBatch?.metadata?.nutritionFacts || {};
  const nq = item.metadata?.netQuantity || currentLabelBatch?.metadata?.netQuantity;
  
  // Calculate QR positions first (we need these for net quantity alignment)
  const qrSize = Math.min(60 * scale, w * 0.28);
  const qrPadding = 10 * scale;
  const qrBottomY = h - qrSize - qrPadding - (12 * scale);
  
  // Logo - BIG, using slider value
  if (labelConfig.elements.logo.enabled && companyLogo) {
    const logoPercent = logoSize / 100;
    const logoW = w * logoPercent;
    const logoH = h * 0.55 * logoPercent;
    const logoX = (w - logoW) / 2;
    const logoY = 8 * scale;
    html += '<div style="position:absolute;left:' + logoX + 'px;top:' + logoY + 'px;width:' + logoW + 'px;height:' + logoH + 'px;"><img src="' + companyLogo + '" style="width:100%;height:100%;object-fit:contain;" /></div>';
  }
  
  // Nutrition Facts (if enabled)
  if (labelConfig.elements.nutrition.enabled) {
    const nutW = Math.min(90 * scale, w * 0.4);
    const nutH = Math.min(100 * scale, h * 0.35);
    const nutX = 8 * scale;
    const nutY = h * 0.38;
    html += '<div style="position:absolute;left:' + nutX + 'px;top:' + nutY + 'px;width:' + nutW + 'px;height:' + nutH + 'px;background:white;border:1px solid #000;font-size:' + (5 * scale) + 'px;padding:' + (3 * scale) + 'px;overflow:hidden;"><strong style="font-size:' + (7 * scale) + 'px;">Nutrition Facts</strong><hr style="margin:2px 0;border:none;border-top:1px solid #000;"/><div>Serving: ' + (nf.servingSize || '___') + '</div><div><strong>Cal: ' + (nf.calories || '0') + '</strong></div><div>Fat: ' + (nf.totalFat || '0') + 'g</div></div>';
  }
  
  // Customer QR (bottom right)
  if (labelConfig.elements.customerQR.enabled && item.qrCodeUrl) {
    const qrX = w - qrSize - qrPadding;
    html += '<div style="position:absolute;left:' + qrX + 'px;top:' + qrBottomY + 'px;width:' + qrSize + 'px;text-align:center;"><img src="' + item.qrCodeUrl + '" style="width:' + qrSize + 'px;height:' + qrSize + 'px;border-radius:4px;background:white;" /><div style="font-size:' + (4 * scale) + 'px;font-weight:bold;color:#1E293B;margin-top:1px;">SCAN TO VERIFY</div></div>';
  }
  
  // Inventory QR (bottom left)
  if (labelConfig.elements.inventoryQR.enabled && item.inventoryQrCodeUrl) {
    html += '<div style="position:absolute;left:' + qrPadding + 'px;top:' + qrBottomY + 'px;width:' + qrSize + 'px;text-align:center;"><img src="' + item.inventoryQrCodeUrl + '" style="width:' + qrSize + 'px;height:' + qrSize + 'px;border-radius:4px;background:white;" /><div style="font-size:' + (3 * scale) + 'px;color:#64748B;margin-top:1px;">INVENTORY</div></div>';
  }
  
  // Net Quantity - NO BOX, just bold text, aligned with QR bottom
  if (labelConfig.elements.netQuantity.enabled && nq) {
    const nqText = nq.display || (nq.value + ' ' + nq.unit);
    const nqFontSize = 11 * scale;
    const nqY = qrBottomY + qrSize - nqFontSize;
    const nqX = labelConfig.elements.inventoryQR.enabled ? (qrPadding + qrSize + (10 * scale)) : qrPadding;
    html += '<div style="position:absolute;left:' + nqX + 'px;top:' + nqY + 'px;font-size:' + nqFontSize + 'px;font-weight:800;color:' + netQuantityColor + ';">' + escapeHtml(nqText) + '</div>';
  }
  
  // SKU at very bottom center
  const sku = item.sku || item.productId || 'SKU';
  html += '<div style="position:absolute;bottom:' + (3 * scale) + 'px;left:0;right:0;text-align:center;font-size:' + (4 * scale) + 'px;color:#94A3B8;">SKU: ' + escapeHtml(sku) + '</div>';
  
  preview.innerHTML = html;
  updateLayoutInfo();
}
    function loadImageAsDataUrl(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          canvas.getContext('2d').drawImage(img, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    // ==========================================
    // LOAD PRODUCTS
    // ==========================================
    async function loadProducts() {
      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Failed to load products');
        allProducts = (data.products || []).filter(p => {
          if (p.mode === 'production' && !p.isFinalized) return false;
          return true;
        });
        let totalProducts = 0, totalBatches = 0;
        allProducts.forEach(p => {
          if (p.isBatchGroup) { totalBatches++; totalProducts += (p.items?.length || p.quantity || 1); }
          else { totalProducts++; }
        });
        document.getElementById('totalProducts').textContent = totalProducts;
        document.getElementById('totalBatches').textContent = totalBatches;
        applyFilters();
      } catch (error) {
        document.getElementById('productsContainer').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Error Loading Products</h3><p>' + error.message + '</p></div>';
      }
    }

    // ==========================================
    // FILTERS & SEARCH
    // ==========================================
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sortBy = document.getElementById('sortSelect').value;
      const typeFilter = document.getElementById('typeSelect').value;
      filteredProducts = allProducts.filter(p => {
        const matchesSearch = !searchTerm || p.productName?.toLowerCase().includes(searchTerm) || p.sku?.toLowerCase().includes(searchTerm) || p.batchNumber?.toLowerCase().includes(searchTerm) || p.productId?.toLowerCase().includes(searchTerm);
        const matchesType = typeFilter === 'all' || (typeFilter === 'batch' && p.isBatchGroup) || (typeFilter === 'single' && !p.isBatchGroup);
        return matchesSearch && matchesType;
      });
      filteredProducts.sort((a, b) => {
        switch (sortBy) {
          case 'newest': return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
          case 'oldest': return new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
          case 'name-az': return (a.productName || '').localeCompare(b.productName || '');
          case 'name-za': return (b.productName || '').localeCompare(a.productName || '');
          default: return 0;
        }
      });
      currentPage = 1;
      renderProducts();
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('sortSelect').value = 'newest';
      document.getElementById('typeSelect').value = 'all';
      applyFilters();
    }

    document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
    document.getElementById('sortSelect').addEventListener('change', applyFilters);
    document.getElementById('typeSelect').addEventListener('change', applyFilters);

    function debounce(func, wait) {
      let timeout;
      return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
    }

    // ==========================================
    // RENDER PRODUCTS
    // ==========================================
    function renderProducts() {
      const container = document.getElementById('productsContainer');
      if (filteredProducts.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><h3>No Finished Products Yet</h3><p>Products will appear here once they\'re minted or finalized from production.</p><a href="dashboard.html"><i class="fas fa-plus"></i> Create Your First Product</a></div>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const startIdx = (currentPage - 1) * itemsPerPage;
      const pageProducts = filteredProducts.slice(startIdx, startIdx + itemsPerPage);
      container.innerHTML = '<div class="products-grid">' + pageProducts.map(product => renderProductCard(product)).join('') + '</div>';
      renderPagination(totalPages);
    }

    function renderProductCard(product) {
      const isBatch = product.isBatchGroup;
      const items = product.items || [];
      const itemCount = items.length || product.quantity || 1;
      const createdDate = product.createdAt ? new Date(product.createdAt).toLocaleDateString() : 'N/A';
      const hasNutrition = product.metadata?.nutritionFacts || (isBatch && product.items?.[0]?.metadata?.nutritionFacts);
      
      let badges = '';
      if (product.isFinalized) badges += '<span class="badge badge-finalized">Finalized</span>';
      else badges += '<span class="badge badge-live">Live</span>';
      if (isBatch) badges += '<span class="badge badge-batch">Batch ' + itemCount + '</span>';
      if (hasNutrition) badges += '<span class="badge badge-nutrition">Nutrition</span>';

      const displayTitle = (isBatch && product.metadata?.batchDisplayName) ? product.metadata.batchDisplayName : product.productName;
      const displaySku = (isBatch && product.metadata?.batchSkuPrefix) ? product.metadata.batchSkuPrefix : (product.sku || product.productId);
      
      let actions = '<a href="' + (product.verificationUrl || '/verify.html?id=' + product.productId) + '" target="_blank" class="btn btn-secondary"><i class="fas fa-eye"></i> View</a>';
      
      if (!isBatch) {
        actions += '<button class="btn btn-primary" onclick=\'openQRModal(' + JSON.stringify(product).replace(/'/g, "\\'") + ')\'><i class="fas fa-qrcode"></i> QR</button>';
        actions += '<button class="btn btn-success" onclick=\'openSingleLabel(' + JSON.stringify(product).replace(/'/g, "\\'") + ')\'><i class="fas fa-tag"></i> Label</button>';
      } else {
        actions += '<button class="btn btn-secondary" onclick=\'openBatchModal(' + JSON.stringify(product).replace(/'/g, "\\'") + ')\'><i class="fas fa-list"></i> Items (' + itemCount + ')</button>';
        actions += '<button class="btn btn-primary" onclick="openZipModal(\'' + product.batchGroupId + '\', \'' + escapeHtml(displayTitle).replace(/'/g, "\\'") + '\')"><i class="fas fa-download"></i> ZIP</button>';
      }

      return '<div class="product-card"><div class="product-card-header"><div><div class="product-card-title">' + escapeHtml(displayTitle) + '</div><div class="product-card-sku">' + escapeHtml(displaySku) + '</div></div><div class="product-card-badges">' + badges + '</div></div><div class="product-card-body"><div class="product-card-meta"><div class="meta-item"><div class="meta-item-label">Batch #</div><div class="meta-item-value">' + escapeHtml(product.batchNumber || 'N/A') + '</div></div><div class="meta-item"><div class="meta-item-label">Created</div><div class="meta-item-value">' + createdDate + '</div></div></div><div class="product-card-actions">' + actions + '</div></div></div>';
    }

    function renderPagination(totalPages) {
      const pagination = document.getElementById('pagination');
      if (totalPages <= 1) { pagination.style.display = 'none'; return; }
      pagination.style.display = 'flex';
      let html = '<button class="pagination-btn" onclick="goToPage(' + (currentPage - 1) + ')" ' + (currentPage === 1 ? 'disabled' : '') + '><i class="fas fa-chevron-left"></i></button>';
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
          html += '<button class="pagination-btn ' + (i === currentPage ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          html += '<span class="pagination-info">...</span>';
        }
      }
      html += '<button class="pagination-btn" onclick="goToPage(' + (currentPage + 1) + ')" ' + (currentPage === totalPages ? 'disabled' : '') + '><i class="fas fa-chevron-right"></i></button>';
      pagination.innerHTML = html;
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ==========================================
    // BATCH MODAL
    // ==========================================
    window.openBatchModal = function(product) {
      if (typeof product === 'string') product = JSON.parse(product);
      const items = product.items || [];
      const batchTitle = product.metadata?.batchDisplayName || product.productName;
      document.getElementById('batchModalTitle').textContent = batchTitle;
      document.getElementById('batchModalSubtitle').textContent = items.length + ' items in batch • Batch #' + (product.batchNumber || 'N/A');
      document.getElementById('batchModalBody').innerHTML = items.map(item => '<div class="batch-modal-item"><div class="batch-modal-item-info"><span class="batch-modal-item-name">' + escapeHtml(item.productName) + '</span><span class="batch-modal-item-sku">SKU: ' + escapeHtml(item.sku) + (item.batchNumber ? ' • Batch #' + escapeHtml(item.batchNumber) : '') + '</span></div><div class="batch-modal-item-actions"><a href="' + item.verificationUrl + '" target="_blank" class="btn btn-secondary" style="padding: 0.5rem 0.75rem;"><i class="fas fa-eye"></i> View</a><button class="btn btn-primary" style="padding: 0.5rem 0.75rem;" onclick=\'openQRModal(' + JSON.stringify(item).replace(/'/g, "\\'") + ')\'><i class="fas fa-qrcode"></i> QR</button></div></div>').join('');
      document.getElementById('batchModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    };

    window.closeBatchModal = function(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('batchModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
    };

    // ==========================================
    // ZIP MODAL
    // ==========================================
    window.openZipModal = function(batchGroupId, productName) {
      currentZipBatchGroupId = batchGroupId;
      currentZipProductName = productName;
      document.getElementById('zipModalSubtitle').textContent = 'Download QR codes for "' + productName + '"';
      // Add Full Label Builder button if not already added
      const zipOptions = document.querySelector('.zip-modal-options');
      if (!document.getElementById('labelBuilderBtn')) {
        const labelBtn = document.createElement('button');
        labelBtn.id = 'labelBuilderBtn';
        labelBtn.className = 'zip-option-btn';
        labelBtn.style.borderColor = '#10B981';
        labelBtn.style.background = '#F0FDF4';
        labelBtn.innerHTML = '<i class="fas fa-tag" style="color: #10B981;"></i><span>Full Label Builder</span><small>Logo + Net Qty + Nutrition + QR</small>';
        labelBtn.onclick = function() { openLabelBuilder(); };
        zipOptions.appendChild(labelBtn);
      }
      document.getElementById('zipModalOverlay').classList.add('show');
    };

    window.closeZipModal = function(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('zipModalOverlay').classList.remove('show');
      currentZipBatchGroupId = null;
      currentZipProductName = null;
    };

    window.downloadBatchZip = async function(type) {
      if (!currentZipBatchGroupId) return;
      const btn = event.target.closest('button');
      const originalHTML = btn.innerHTML;
      btn.classList.add('downloading');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i><span>Downloading...</span><small>Please wait</small>';
      try {
        const batch = allProducts.find(p => p.batchGroupId === currentZipBatchGroupId);
        if (!batch || !batch.items?.length) throw new Error('Batch not found');
        const zip = new JSZip();
        const customerFolder = (type === 'customer' || type === 'both') ? zip.folder('Customer-QR-Codes') : null;
        const inventoryFolder = (type === 'inventory' || type === 'both') ? zip.folder('Inventory-QR-Codes') : null;
        for (const item of batch.items) {
          if (customerFolder && item.qrCodeUrl) {
            const r = await fetch(item.qrCodeUrl);
            customerFolder.file(item.sku + '-customer.png', await r.blob());
          }
          if (inventoryFolder && item.inventoryQrCodeUrl) {
            const r = await fetch(item.inventoryQrCodeUrl);
            inventoryFolder.file(item.sku + '-inventory.png', await r.blob());
          }
        }
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipBlob);
        a.download = currentZipProductName.replace(/[^a-z0-9]/gi, '_') + '_' + (type === 'both' ? 'all-qr' : type + '-qr') + '.zip';
        a.click();
        closeZipModal();
      } catch (err) {
        alert('ZIP error: ' + err.message);
        btn.innerHTML = originalHTML;
        btn.classList.remove('downloading');
      }
    };

    // ==========================================
    // QR MODAL
    // ==========================================
    window.openQRModal = function(product) {
      if (typeof product === 'string') product = JSON.parse(product);
      currentQRData = product;
      document.getElementById('modalSku').textContent = 'SKU: ' + (product.sku || product.productId);
      document.getElementById('customerQRLoading').style.display = 'block';
      document.getElementById('inventoryQRLoading').style.display = 'block';
      document.getElementById('modalCustomerQR').src = product.qrCodeUrl;
      const inventoryBox = document.getElementById('inventoryQRBox');
      const inventoryBtn = document.getElementById('downloadInventoryBtn');
      const bothBtn = document.getElementById('downloadBothBtn');
      if (product.inventoryQrCodeUrl) {
        document.getElementById('modalInventoryQR').src = product.inventoryQrCodeUrl;
        inventoryBox.style.display = 'block';
        inventoryBtn.style.display = 'flex';
        bothBtn.style.display = 'flex';
      } else {
        inventoryBox.style.display = 'none';
        inventoryBtn.style.display = 'none';
        bothBtn.style.display = 'none';
      }
      document.getElementById('qrModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    };

    window.closeQRModal = function(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('qrModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
      currentQRData = null;
    };

    window.downloadQR = async function(type) {
      if (!currentQRData) return;
      const btn = document.getElementById(type === 'customer' ? 'downloadCustomerBtn' : 'downloadInventoryBtn');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;
      try {
        const url = type === 'customer' ? currentQRData.qrCodeUrl : currentQRData.inventoryQrCodeUrl;
        const response = await fetch(url);
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (currentQRData.sku || currentQRData.productId) + '-' + type + '-qr.png';
        a.click();
      } catch (error) {
        window.open(type === 'customer' ? currentQRData.qrCodeUrl : currentQRData.inventoryQrCodeUrl, '_blank');
      } finally {
        btn.innerHTML = '<i class="fas fa-download"></i> ' + (type === 'customer' ? 'Customer' : 'Inventory');
        btn.disabled = false;
      }
    };

    window.downloadBothQRs = async function() {
      if (!currentQRData) return;
      const btn = document.getElementById('downloadBothBtn');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.disabled = true;
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600;
        canvas.height = 380;
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        const customerImg = new Image();
        const inventoryImg = new Image();
        customerImg.crossOrigin = 'anonymous';
        inventoryImg.crossOrigin = 'anonymous';
        await Promise.all([
          new Promise((resolve, reject) => { customerImg.onload = resolve; customerImg.onerror = reject; customerImg.src = currentQRData.qrCodeUrl; }),
          new Promise((resolve, reject) => { inventoryImg.onload = resolve; inventoryImg.onerror = reject; inventoryImg.src = currentQRData.inventoryQrCodeUrl; })
        ]);
        ctx.fillStyle = '#1E293B';
        ctx.font = 'bold 22px Inter, Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(currentQRData.productName || 'Product', canvas.width / 2, 32);
        ctx.fillStyle = '#64748B';
        ctx.font = '14px Inter, Arial, sans-serif';
        ctx.fillText('SKU: ' + (currentQRData.sku || currentQRData.productId), canvas.width / 2, 55);
        ctx.drawImage(customerImg, 80, 75, 140, 140);
        ctx.drawImage(inventoryImg, 380, 75, 140, 140);
        ctx.fillStyle = '#4F46E5';
        ctx.font = 'bold 13px Inter, Arial, sans-serif';
        ctx.fillText('Customer', 150, 237);
        ctx.fillStyle = '#64748B';
        ctx.fillText('Inventory', 450, 237);
        const link = document.createElement('a');
        link.download = (currentQRData.sku || currentQRData.productId) + '-label.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        alert('Error creating label: ' + err.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-layer-group"></i> Both';
        btn.disabled = false;
      }
    };

    // ==========================================
    // HELPERS & INIT
    // ==========================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeQRModal(); closeBatchModal(); closeZipModal(); closeLabelModal(); }
    });

    initCompanyLogo();
    loadProducts();
  </script>
</body>
</html>
