<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard – BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: white;
      border-right: 1px solid #E2E8F0;
      padding: 2rem 0;
      z-index: 100;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.02);
    }

    .sidebar-logo {
      padding: 0 2rem 2rem;
      border-bottom: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }

    .sidebar-logo img {
      max-width: 160px;
      height: auto;
    }

    .sidebar-nav {
      list-style: none;
    }

    .sidebar-nav li {
      margin-bottom: 0.5rem;
    }

    .sidebar-nav a {
      display: flex;
      align-items: center;
      padding: 0.875rem 2rem;
      color: #64748B;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }

    .sidebar-nav a:hover {
      background: #F8FAFC;
      color: #4F46E5;
    }

    .sidebar-nav a.active {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.1) 0%, transparent 100%);
      color: #4F46E5;
      border-left: 3px solid #4F46E5;
    }

    .sidebar-nav a i {
      margin-right: 0.75rem;
      width: 20px;
    }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .dashboard-header {
      margin-bottom: 3rem;
    }

    .dashboard-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: #1E293B;
      margin-bottom: 0.5rem;
    }

    .dashboard-header p {
      font-size: 1.125rem;
      color: #64748B;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }

    .card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .card h3 i {
      color: #4F46E5;
    }

    /* BATCH TOGGLE SWITCH */
    .mode-toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem;
      background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%);
      border-radius: 12px;
      margin-bottom: 2rem;
      border: 2px solid #C7D2FE;
    }

    .mode-toggle-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 600;
      color: #334155;
    }

    .mode-toggle-label i {
      font-size: 1.25rem;
      color: #4F46E5;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: #CBD5E1;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .toggle-switch.active {
      background: #4F46E5;
    }

    .toggle-switch-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-switch-slider {
      transform: translateX(28px);
    }

    .mode-status {
      font-size: 0.875rem;
      color: #64748B;
      margin-left: 1rem;
    }

    .mode-status.batch-active {
      color: #4F46E5;
      font-weight: 600;
    }

    /* BATCH QUANTITY INPUT */
    .batch-quantity-section {
      display: none;
      padding: 1.25rem;
      background: #FEF3C7;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 2px solid #FDE047;
    }

    .batch-quantity-section.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .batch-quantity-section label {
      display: block;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: #92400E;
      font-size: 1rem;
    }

    .batch-quantity-section input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #FDE047;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      background: white;
      color: #92400E;
    }

    .batch-quantity-section input:focus {
      outline: none;
      border-color: #F59E0B;
      box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
    }

    .batch-info-box {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: white;
      border-radius: 8px;
      font-size: 0.875rem;
      color: #92400E;
    }

    .batch-info-box i {
      margin-right: 0.5rem;
      color: #F59E0B;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #334155;
      font-size: 0.95rem;
    }

    .form-group label .required {
      color: #DC2626;
      margin-left: 0.25rem;
    }

    .form-group label .batch-note {
      font-weight: 400;
      color: #64748B;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #F8FAFC;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      background: white;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: #F8FAFC;
    }

    .btn-toggle {
      background: white;
      color: #4F46E5;
      border: 2px solid #E2E8F0;
      box-shadow: none;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn-toggle:hover {
      background: #F8FAFC;
      border-color: #4F46E5;
      transform: none;
    }

    .btn-toggle i.rotate {
      transform: rotate(180deg);
      transition: transform 0.3s;
    }

    .message {
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .message.success {
      background: #F0FDF4;
      color: #16A34A;
      border: 1px solid #BBF7D0;
    }

    .message.error {
      background: #FEF2F2;
      color: #DC2626;
      border: 1px solid #FECACA;
    }

    .message.info {
      background: #EFF6FF;
      color: #2563EB;
      border: 1px solid #BFDBFE;
    }

    .progress-bar-container {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #F8FAFC;
      border-radius: 12px;
      border: 2px solid #E2E8F0;
    }

    .progress-bar-container.show {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #E2E8F0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4F46E5, #7C3AED);
      transition: width 0.3s;
      border-radius: 4px;
    }

    .progress-text {
      font-size: 0.875rem;
      color: #64748B;
      font-weight: 600;
    }

    .product-list {
      list-style: none;
    }

    .product-list li {
      padding: 1.5rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 1px solid #E2E8F0;
      transition: all 0.2s;
    }

    .product-list li:hover {
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .product-list li > div:first-child {
      flex: 1;
    }

    .product-list li strong {
      font-size: 1.125rem;
      color: #1E293B;
    }

    .product-list li small {
      color: #64748B;
      font-size: 0.875rem;
    }

    .product-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .product-actions a {
      padding: 0.5rem 1rem;
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .product-actions a:hover {
      background: #4F46E5;
      color: white;
    }

    .qr-output {
      display: none;
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: white;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #E2E8F0;
    }

    .qr-output.show {
      display: block;
    }

    .qr-output img {
      max-width: 300px;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .qr-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: #94A3B8;
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 1rem;
      color: #CBD5E1;
    }

    .empty-state p {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
    }

    .photo-upload-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .photo-upload-section button {
      flex: 1;
    }

    .photo-preview {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .location-capture {
      margin-bottom: 1.5rem;
    }

    .location-display {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #F0FDF4;
      border-radius: 12px;
      color: #16A34A;
      font-weight: 500;
      border: 1px solid #BBF7D0;
    }

    .batch-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #FEF3C7;
      color: #92400E;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 700;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-logo">
      <img src="https://i.ibb.co/ZK7F7Zp/biztrack-logo-no-bg.png" alt="BizTrack Logo" />
    </div>
    <ul class="sidebar-nav">
      <li><a href="dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
      <li><a href="history.html"><i class="fas fa-history"></i> Product History</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a></li>
      <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
    </ul>
  </div>

  <div class="main-with-sidebar">
    <div class="dashboard-header">
      <h1>Dashboard</h1>
      <p>Mint products to the blockchain with authenticity verification</p>
    </div>

    <div class="card">
      <h3><i class="fas fa-cube"></i> Create Product</h3>

      <!-- MODE TOGGLE: Single Product vs Batch Order -->
      <div class="mode-toggle-container">
        <div class="mode-toggle-label">
          <i class="fas fa-layer-group"></i>
          <span>Batch Order Mode</span>
          <span id="modeStatus" class="mode-status">Single Product</span>
        </div>
        <div id="batchToggle" class="toggle-switch" onclick="toggleBatchMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <!-- BATCH QUANTITY INPUT (hidden by default) -->
      <div id="batchQuantitySection" class="batch-quantity-section">
        <label>
          <i class="fas fa-boxes"></i> How many products in this batch?
        </label>
        <input 
          type="number" 
          id="batchQuantity" 
          min="1" 
          max="100" 
          value="10"
          placeholder="Enter quantity (max 100)"
        />
        <div class="batch-info-box">
          <i class="fas fa-info-circle"></i>
          <strong>Batch minting will:</strong> Create multiple products with auto-incremented SKUs (e.g., PROD-001, PROD-002...), each with unique QR codes, all sharing the same product details and photos.
        </div>
      </div>

      <div class="form-group">
        <label>Product Name <span class="required">*</span></label>
        <input type="text" id="dashProdName" placeholder="e.g., Organic Coffee Beans" />
      </div>

      <div class="form-group">
        <label>
          SKU <span class="required">*</span>
          <span id="skuBatchNote" class="batch-note" style="display: none;">(Will auto-generate: SKU-001, SKU-002, etc.)</span>
        </label>
        <input type="text" id="dashSku" placeholder="e.g., COFFEE-2025" />
      </div>

      <div class="form-group">
        <label>Batch Number</label>
        <input type="text" id="dashBatch" placeholder="e.g., B20250124" />
      </div>

      <div class="form-group">
        <label>Additional Metadata (Optional)</label>
        <textarea id="dashMetadata" placeholder="Add any extra information about this product..."></textarea>
      </div>

      <div class="form-group">
        <label>Product Photos (Optional, max 5)</label>
        <div class="photo-upload-section">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
            <i class="fas fa-image"></i> Choose from Gallery
          </button>
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
            <i class="fas fa-camera"></i> Take Photo
          </button>
        </div>
        <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" />
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
        <div id="photoPreview" class="photo-preview"></div>
      </div>

      <div class="form-group location-capture">
        <label>Location (Optional)</label>
        <button type="button" id="captureLocationBtn" class="btn btn-secondary">
          <i class="fas fa-map-marker-alt"></i> <span id="locationBtnText">Capture Location</span>
        </button>
        <div id="locationDisplay" class="location-display"></div>
      </div>

      <button id="dashCreateBtn" class="btn">
        <i class="fas fa-rocket"></i> <span id="createBtnText">Mint to Blockchain</span>
      </button>

      <div id="progressBarContainer" class="progress-bar-container">
        <div class="progress-bar">
          <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
        </div>
        <div id="progressText" class="progress-text">Processing...</div>
      </div>

      <div id="dashMsg"></div>
    </div>

    <div class="card">
      <h3><i class="fas fa-boxes"></i> Minted Products</h3>
      <ul id="batchList" class="product-list"></ul>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const msgEl = document.getElementById('dashMsg');
      const batchList = document.getElementById('batchList');
      const photoInput = document.getElementById('photoInput');
      const cameraInput = document.getElementById('cameraInput');
      const photoPreview = document.getElementById('photoPreview');
      const captureLocationBtn = document.getElementById('captureLocationBtn');
      const locationDisplay = document.getElementById('locationDisplay');
      const progressBarContainer = document.getElementById('progressBarContainer');
      const progressBarFill = document.getElementById('progressBarFill');
      const progressText = document.getElementById('progressText');

      let selectedPhotos = [];
      let capturedLocation = null;
      let isBatchMode = false;

      // Toggle batch mode
      window.toggleBatchMode = () => {
        isBatchMode = !isBatchMode;
        const toggle = document.getElementById('batchToggle');
        const quantitySection = document.getElementById('batchQuantitySection');
        const modeStatus = document.getElementById('modeStatus');
        const skuBatchNote = document.getElementById('skuBatchNote');
        const createBtnText = document.getElementById('createBtnText');

        if (isBatchMode) {
          toggle.classList.add('active');
          quantitySection.classList.add('show');
          modeStatus.textContent = 'Batch Order';
          modeStatus.classList.add('batch-active');
          skuBatchNote.style.display = 'inline';
          createBtnText.textContent = 'Mint Batch to Blockchain';
        } else {
          toggle.classList.remove('active');
          quantitySection.classList.remove('show');
          modeStatus.textContent = 'Single Product';
          modeStatus.classList.remove('batch-active');
          skuBatchNote.style.display = 'none';
          createBtnText.textContent = 'Mint to Blockchain';
        }
      };

      async function compressImage(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              const MAX_WIDTH = 1200;
              const MAX_HEIGHT = 1200;
              
              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }
              
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              resolve(canvas.toDataURL('image/jpeg', 0.8));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      photoInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        
        for (const file of files) {
          if (selectedPhotos.length >= 5) {
            alert('Maximum 5 photos allowed');
            break;
          }
          
          const compressed = await compressImage(file);
          selectedPhotos.push(compressed);
          displayPhotoPreview();
        }
        
        photoInput.value = '';
      });

      cameraInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        
        for (const file of files) {
          if (selectedPhotos.length >= 5) {
            alert('Maximum 5 photos allowed');
            break;
          }
          
          const compressed = await compressImage(file);
          selectedPhotos.push(compressed);
          displayPhotoPreview();
        }
        
        cameraInput.value = '';
      });

      function displayPhotoPreview() {
        photoPreview.innerHTML = '';
        selectedPhotos.forEach((photo, index) => {
          const div = document.createElement('div');
          div.style.cssText = 'position: relative; width: 100px; height: 100px;';
          div.innerHTML = `
            <img src="${photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 2px solid #E2E8F0;" />
            <button onclick="removePhoto(${index})" style="position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: #DC2626; color: white; border: none; cursor: pointer; font-size: 12px;">✕</button>
          `;
          photoPreview.appendChild(div);
        });
      }

      window.removePhoto = (index) => {
        selectedPhotos.splice(index, 1);
        displayPhotoPreview();
      };

      captureLocationBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
          alert('Geolocation is not supported by your browser');
          return;
        }

        captureLocationBtn.disabled = true;
        document.getElementById('locationBtnText').textContent = 'Getting location...';

        navigator.geolocation.getCurrentPosition(
          (position) => {
            capturedLocation = {
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              accuracy: position.coords.accuracy
            };
            locationDisplay.style.display = 'block';
            locationDisplay.innerHTML = `<i class="fas fa-check-circle"></i> Location captured! (${capturedLocation.latitude.toFixed(4)}, ${capturedLocation.longitude.toFixed(4)})`;
            captureLocationBtn.disabled = false;
            document.getElementById('locationBtnText').textContent = 'Update Location';
          },
          (error) => {
            alert('Unable to get location: ' + error.message);
            captureLocationBtn.disabled = false;
            document.getElementById('locationBtnText').textContent = 'Capture Location';
          }
        );
      });

      const populateBatches = () => {
        const batches = JSON.parse(localStorage.getItem('biztrack-batches') || '[]');
        batchList.innerHTML = '';
        
        if (!batches.length) {
          batchList.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-box-open"></i>
              <p>No products minted yet.</p>
              <p style="margin-top: 0.5rem;">Use the form above to mint your first product.</p>
            </div>
          `;
        } else {
          batches.slice().reverse().forEach((b) => {
            const qrSectionId = `qr-section-${b.productId}`;
            const batchBadge = b.isBatchItem ? `<span class="batch-badge">BATCH ${b.batchItemNumber}/${b.batchTotal}</span>` : '';
            li.innerHTML = `
              <div>
                <strong>${b.productName}</strong> ${batchBadge}
                <br><small>SKU: ${b.sku} • Batch: ${b.batchNumber}</small>
                <br><small>Product ID: ${b.productId}</small>
              </div>
              <div class="product-actions">
                <button class="btn btn-toggle" onclick="toggleQR('${qrSectionId}', '${b.qrCodeIpfsHash}', this)">
                  <i class="fas fa-chevron-down"></i> Show QR Code
                </button>
                <a href="https://livenet.xrpl.org/transactions/${b.xrplTxHash}" target="_blank">
                  <i class="fas fa-external-link-alt"></i> View Transaction
                </a>
              </div>
              <div id="${qrSectionId}" class="qr-output">
                <img src="https://gateway.pinata.cloud/ipfs/${b.qrCodeIpfsHash}" alt="QR Code" />
                <p style="margin-top: 1rem; font-weight: 600; color: #475569;">Scan to verify product authenticity</p>
                <div class="qr-actions">
                  <a href="https://gateway.pinata.cloud/ipfs/${b.qrCodeIpfsHash}" download="BizTrack-QR-${b.productId}.png" class="btn btn-secondary">
                    <i class="fas fa-download"></i> Download QR Code
                  </a>
                </div>
              </div>
            `;
            batchList.appendChild(li);
          });
        }
      };

      window.toggleQR = (sectionId, ipfsHash, button) => {
        const section = document.getElementById(sectionId);
        const icon = button.querySelector('i');
        
        if (section.classList.contains('show')) {
          section.classList.remove('show');
          icon.classList.remove('fa-chevron-up', 'rotate');
          icon.classList.add('fa-chevron-down');
          button.innerHTML = '<i class="fas fa-chevron-down"></i> Show QR Code';
        } else {
          section.classList.add('show');
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-up', 'rotate');
          button.innerHTML = '<i class="fas fa-chevron-up rotate"></i> Hide QR Code';
        }
      };

      populateBatches();

      const createBtn = document.getElementById('dashCreateBtn');
      createBtn.addEventListener('click', async () => {
        const productName = document.getElementById('dashProdName').value.trim();
        const sku = document.getElementById('dashSku').value.trim();
        const batchNumber = document.getElementById('dashBatch').value.trim();
        const metadata = document.getElementById('dashMetadata').value.trim();
        const batchQuantity = isBatchMode ? parseInt(document.getElementById('batchQuantity').value) : 1;
        
        msgEl.innerHTML = '';
        progressBarContainer.classList.remove('show');

        // Validation
        if (!productName) {
          msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Product name is required.</div>';
          return;
        }

        if (!sku) {
          msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> SKU is required.</div>';
          return;
        }

        if (isBatchMode && (!batchQuantity || batchQuantity < 1 || batchQuantity > 100)) {
          msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Batch quantity must be between 1 and 100.</div>';
          return;
        }

        createBtn.disabled = true;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Minting to Blockchain...';
        
        if (isBatchMode) {
          progressBarContainer.classList.add('show');
          progressBarFill.style.width = '10%';
          progressText.textContent = `Preparing to mint ${batchQuantity} products...`;
        } else {
          msgEl.innerHTML = '<div class="message info"><i class="fas fa-info-circle"></i> Uploading photos and data to IPFS...</div>';
        }

        try {
          const response = await fetch('/api/mint-product', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              productName,
              sku,
              batchNumber,
              metadata: metadata ? { notes: metadata } : {},
              photos: selectedPhotos.length > 0 ? selectedPhotos : null,
              location: capturedLocation,
              isBatchOrder: isBatchMode,
              batchQuantity: batchQuantity
            })
          });

          // For batch orders, the response will be a ZIP file
          if (isBatchMode && response.ok && response.headers.get('content-type') === 'application/zip') {
            progressBarFill.style.width = '90%';
            progressText.textContent = 'Finalizing batch... Preparing ZIP file...';

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `BizTrack-QRCodes-${sku}-${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            progressBarFill.style.width = '100%';
            progressText.textContent = `Successfully minted ${batchQuantity} products!`;

            msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> Batch order completed! ${batchQuantity} products minted successfully. QR codes ZIP file downloaded.</div>`;

            // Refresh product list (backend should have saved all to database)
            setTimeout(() => {
              window.location.reload();
            }, 2000);

          } else {
            // Single product response
            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.details || result.error || 'Minting failed');
            }

            msgEl.innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> Product successfully minted to blockchain!</div>`;

            const batches = JSON.parse(localStorage.getItem('biztrack-batches') || '[]');
            batches.push({
              productName,
              sku,
              batchNumber,
              productId: result.productId,
              ipfsHash: result.ipfsHash,
              qrCodeIpfsHash: result.qrCodeIpfsHash,
              xrplTxHash: result.xrplTxHash,
              timestamp: new Date().toISOString()
            });
            localStorage.setItem('biztrack-batches', JSON.stringify(batches));

            // Clear form
            document.getElementById('dashProdName').value = '';
            document.getElementById('dashSku').value = '';
            document.getElementById('dashBatch').value = '';
            document.getElementById('dashMetadata').value = '';
            selectedPhotos = [];
            capturedLocation = null;
            photoPreview.innerHTML = '';
            locationDisplay.style.display = 'none';
            document.getElementById('locationBtnText').textContent = 'Capture Location';

            populateBatches();
          }

        } catch (error) {
          msgEl.innerHTML = `<div class="message error"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
          console.error('Minting error:', error);
        } finally {
          createBtn.disabled = false;
          createBtn.innerHTML = isBatchMode 
            ? '<i class="fas fa-rocket"></i> Mint Batch to Blockchain'
            : '<i class="fas fa-rocket"></i> Mint to Blockchain';
          
          setTimeout(() => {
            progressBarContainer.classList.remove('show');
          }, 3000);
        }
      });
    });
  </script>
</body>
</html>
