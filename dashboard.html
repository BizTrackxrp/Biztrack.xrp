<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard – BizTrack.xrp</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  </head>
  <body>
  <nav class="sidebar">
  <div class="sidebar-logo">
    <img src="8bd1b1ec-0edc-4581-92b8-51ac2db94afe-removebg-preview.png" alt="BizTrack">
  </div>
  <ul class="sidebar-nav">
    <li><a href="index.html">Home</a></li>
    <li><a href="verify.html">Verify Product</a></li>
    <li><a href="dashboard.html" class="active">Dashboard</a></li>
    <li><a href="settings.html">Settings</a></li>
    <li><a href="#" id="connectWalletLink">Connect Wallet</a></li>
  </ul>
</nav>

<div class="main-with-sidebar">
    <div class="dashboard-container">
      <h2>Welcome to your dashboard</h2>
      <p>Manage your products and mint to blockchain.</p>

      <div class="batch-form">
        <h3>Mint New Product</h3>
        <div class="form-group">
          <label for="dashProdName">Product Name</label>
          <input id="dashProdName" type="text" placeholder="e.g. Organic Honey" />
        </div>
        <div class="form-group">
          <label for="dashSku">SKU</label>
          <input id="dashSku" type="text" placeholder="e.g. HNY1234" />
        </div>
        <div class="form-group">
          <label for="dashBatch">Batch Number</label>
          <input id="dashBatch" type="text" placeholder="e.g. 001" />
        </div>
        <div class="form-group">
          <label for="dashMetadata">Additional Info (optional)</label>
          <textarea id="dashMetadata" placeholder="e.g. Harvest date, origin, certifications" rows="3"></textarea>
        </div>
        <button class="btn" id="dashCreateBtn">Mint to Blockchain</button>
        <p id="dashMsg" style="margin-top:0.5rem;"></p>
        
        <div id="dashQrOutput" class="qr-code" style="display:none; margin-top:1rem;">
          <canvas id="qrCanvas"></canvas>
          <p style="margin-top:0.5rem;">Scan to verify product authenticity</p>
          <button class="btn" id="downloadQrBtn" style="margin-top:0.5rem;">Download QR Code</button>
          <a id="blockchainLink" href="#" target="_blank" style="display:block; margin-top:0.5rem;">View on Blockchain Explorer</a>
        </div>
      </div>

      <div class="history-box">
        <h3>Your Minted Products</h3>
        <ul id="batchList">
        </ul>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/wallet.js"></script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // Ensure user is authenticated
        if (!Auth.isLoggedIn()) {
          window.location.href = 'login.html';
          return;
        }

        const batchList = document.getElementById('batchList');
        const msgEl = document.getElementById('dashMsg');
        const qrOutput = document.getElementById('dashQrOutput');
        const qrCanvas = document.getElementById('qrCanvas');
        const downloadQrBtn = document.getElementById('downloadQrBtn');
        const blockchainLink = document.getElementById('blockchainLink');
        
        let currentProductId = null;
        let currentVerificationUrl = null;

        const populateBatches = () => {
          const batches = JSON.parse(localStorage.getItem('biztrack-batches') || '[]');
          batchList.innerHTML = '';
          if (!batches.length) {
            batchList.innerHTML = '<li>No products minted yet. Use the form above to mint your first product.</li>';
          } else {
            batches.slice().reverse().forEach((b) => {
              const li = document.createElement('li');
              li.innerHTML = `
                <strong>${b.productName}</strong> (SKU: ${b.sku}, Batch: ${b.batchNumber})
                <br><small>Product ID: ${b.productId}</small>
                <br><button class="btn" onclick="regenerateQR('${b.productId}', '${b.xrplTxHash}')" style="margin-top:0.5rem; font-size:0.9rem;">Generate QR Code</button>
                <a href="https://livenet.xrpl.org/transactions/${b.xrplTxHash}" target="_blank" style="margin-left:0.5rem;">View Transaction</a>
              `;
              batchList.appendChild(li);
            });
          }
        };

        // Function to generate QR code
        window.regenerateQR = (productId, txHash) => {
          currentProductId = productId;
          currentVerificationUrl = `https://www.biztrack.io/verify?id=${productId}`;
          
          QRCode.toCanvas(qrCanvas, currentVerificationUrl, {
            width: 512,
            margin: 2,
            color: {
              dark: '#000000',
              light: '#FFFFFF'
            }
          }, (error) => {
            if (error) {
              console.error(error);
              msgEl.textContent = 'Error generating QR code';
              msgEl.style.color = '#c00';
            } else {
              qrOutput.style.display = 'block';
              blockchainLink.href = `https://livenet.xrpl.org/transactions/${txHash}`;
              window.scrollTo({ top: qrOutput.offsetTop - 100, behavior: 'smooth' });
            }
          });
        };

        // Download QR code
        downloadQrBtn.addEventListener('click', () => {
          const link = document.createElement('a');
          link.download = `BizTrack-QR-${currentProductId}.png`;
          link.href = qrCanvas.toDataURL();
          link.click();
        });

        // Populate list on load
        populateBatches();

        // Handle product minting
        const createBtn = document.getElementById('dashCreateBtn');
        createBtn.addEventListener('click', async () => {
          const productName = document.getElementById('dashProdName').value.trim();
          const sku = document.getElementById('dashSku').value.trim();
          const batchNumber = document.getElementById('dashBatch').value.trim();
          const metadata = document.getElementById('dashMetadata').value.trim();
          
          msgEl.textContent = '';
          qrOutput.style.display = 'none';

          if (!productName || !sku || !batchNumber) {
            msgEl.textContent = 'Please fill in product name, SKU and batch number.';
            msgEl.style.color = '#c00';
            return;
          }

          // Show loading
          createBtn.disabled = true;
          createBtn.textContent = 'Minting to Blockchain...';
          msgEl.textContent = 'Uploading to IPFS and writing to XRPL...';
          msgEl.style.color = '#0066cc';

          try {
            // Call your minting API
            const response = await fetch('/api/mint-product', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                productName,
                sku,
                batchNumber,
                metadata: metadata ? { notes: metadata } : {}
              })
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.details || result.error || 'Minting failed');
            }

            // Success!
            msgEl.textContent = `✓ Successfully minted to blockchain! Cost: ${result.actualCost.fee} XRP (~$${result.actualCost.feeInUSD})`;
            msgEl.style.color = '#00aa00';

            // Save to localStorage
            const batches = JSON.parse(localStorage.getItem('biztrack-batches') || '[]');
            batches.push({
              productName,
              sku,
              batchNumber,
              productId: result.productId,
              ipfsHash: result.ipfsHash,
              xrplTxHash: result.xrplTxHash,
              timestamp: new Date().toISOString()
            });
            localStorage.setItem('biztrack-batches', JSON.stringify(batches));

            // Generate QR code
            currentProductId = result.productId;
            currentVerificationUrl = result.verificationUrl;
            
            QRCode.toCanvas(qrCanvas, currentVerificationUrl, {
              width: 512,
              margin: 2,
              color: {
                dark: '#000000',
                light: '#FFFFFF'
              }
            });
            
            qrOutput.style.display = 'block';
            blockchainLink.href = result.blockchainExplorer;

            // Clear inputs
            document.getElementById('dashProdName').value = '';
            document.getElementById('dashSku').value = '';
            document.getElementById('dashBatch').value = '';
            document.getElementById('dashMetadata').value = '';

            // Refresh list
            populateBatches();

          } catch (error) {
            msgEl.textContent = `✗ Error: ${error.message}`;
            msgEl.style.color = '#c00';
            console.error('Minting error:', error);
          } finally {
            createBtn.disabled = false;
            createBtn.textContent = 'Mint to Blockchain';
          }
        });
      });
    </script>
</div>
</body>
</html>
