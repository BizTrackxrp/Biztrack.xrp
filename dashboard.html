<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard â€“ BizTrack</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      color: #1E293B;
      line-height: 1.6;
      min-height: 100vh;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 280px;
      height: 100vh;
      background: #0f172a;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .sidebar-logo {
      padding: 0 2rem 2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 2rem;
    }

    .sidebar-logo h1 { color: #fff; font-size: 1.5rem; font-weight: 800; }

    .sidebar-nav { list-style: none; }
    .sidebar-nav li { margin-bottom: 0.5rem; }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      padding: 0.875rem 2rem;
      color: #64748B;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
    }
    .sidebar-nav a:hover { background: #F8FAFC; color: #4F46E5; }
    .sidebar-nav a.active {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.1) 0%, transparent 100%);
      color: #4F46E5;
      border-left: 3px solid #4F46E5;
    }
    .sidebar-nav a i { margin-right: 0.75rem; width: 20px; }

    .sidebar-logout {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-logout button {
      width: 100%;
      padding: 0.875rem 1rem;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .sidebar-logout button:hover { background: rgba(239, 68, 68, 0.2); }

    .main-with-sidebar {
      margin-left: 280px;
      padding: 2rem 3rem;
      min-height: 100vh;
    }

    .dashboard-header { margin-bottom: 3rem; }
    .dashboard-header h1 { font-size: 2.5rem; font-weight: 800; color: #1E293B; margin-bottom: 0.5rem; }
    .dashboard-header p { font-size: 1.125rem; color: #64748B; }

    .usage-counter {
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .usage-counter h4 { font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem; text-transform: uppercase; }
    .usage-counter-numbers { font-size: 2.5rem; font-weight: 800; }
    .usage-counter-numbers small { font-size: 1.25rem; opacity: 0.8; }
    .usage-counter-upgrade {
      background: white;
      color: #4F46E5;
      border: none;
      padding: 0.875rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .usage-counter-upgrade:hover { transform: translateY(-2px); }

    .card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #E2E8F0;
      margin-bottom: 2rem;
    }
    .card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1E293B;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .card h3 i { color: #4F46E5; }

    .batch-toggle-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: #F8FAFC;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 2px solid #E2E8F0;
    }
    .batch-toggle-label { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; color: #334155; }
    .batch-toggle-label i { color: #4F46E5; }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: #CBD5E1;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .toggle-switch.active { background: #4F46E5; }
    .toggle-switch-slider {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .toggle-switch.active .toggle-switch-slider { transform: translateX(28px); }

    .batch-quantity-section {
      display: none;
      padding: 1.5rem;
      background: #FEF3C7;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      border: 2px solid #FDE047;
    }
    .batch-quantity-section.show { display: block; }
    .batch-quantity-section h4 { color: #92400E; margin-bottom: 1rem; }
    .batch-info { margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 8px; font-size: 0.875rem; color: #92400E; }

    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #334155; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      background: #F8FAFC;
    }
    .form-group input:disabled { background: #F1F5F9; color: #94A3B8; cursor: not-allowed; opacity: 0.6; }
    .form-group input:focus:not(:disabled), .form-group textarea:focus {
      outline: none;
      border-color: #4F46E5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      background: white;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .btn {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      width: 100%;
      justify-content: center;
    }
    .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(79, 70, 229, 0.4); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: white;
      color: #4F46E5;
      border: 2px solid #4F46E5;
      box-shadow: none;
      padding: 0.75rem 1.5rem;
      width: auto;
    }
    .btn-secondary:hover { background: #F8FAFC; transform: none; }

    .message { padding: 1rem; border-radius: 12px; margin-top: 1rem; font-weight: 500; display: flex; align-items: flex-start; gap: 0.75rem; }
    .message.success { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; }
    .message.error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .message.info { background: #EFF6FF; color: #2563EB; border: 1px solid #BFDBFE; }

    .product-list { list-style: none; }
    .product-list li { padding: 1.5rem; background: #F8FAFC; border-radius: 12px; margin-bottom: 1rem; border: 1px solid #E2E8F0; }
    .product-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }

    .batch-items { display: none; width: 100%; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #E2E8F0; }
    .batch-items.show { display: block; }
    .batch-item { background: white; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }

    .empty-state { text-align: center; padding: 3rem 1rem; color: #94A3B8; }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

    .batch-badge { background: #4F46E5; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; margin-left: 0.5rem; }

    /* QR Modal */
    .qr-modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .qr-modal-overlay.show { display: flex; }
    .qr-modal {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .qr-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #E2E8F0;
    }
    .qr-modal-header h2 { font-size: 1.5rem; font-weight: 700; color: #1E293B; }
    .qr-modal-close {
      background: none; border: none; font-size: 1.5rem; color: #64748B;
      cursor: pointer; padding: 0.5rem; border-radius: 8px;
    }
    .qr-modal-close:hover { background: #F1F5F9; color: #1E293B; }
    .qr-modal-sku {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .qr-modal-sku span {
      background: #F1F5F9;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1rem;
      color: #334155;
    }
    .qr-codes-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .qr-code-box { text-align: center; }
    .qr-code-box img {
      width: 160px; height: 160px;
      border-radius: 12px;
      border: 2px solid #E2E8F0;
      padding: 8px;
      background: white;
    }
    .qr-code-box.customer img { border-color: #A5B4FC; }
    .qr-code-box.inventory img { border-color: #CBD5E1; }
    .qr-code-label { margin-top: 0.75rem; font-weight: 600; font-size: 0.9rem; }
    .qr-code-box.customer .qr-code-label { color: #4F46E5; }
    .qr-code-box.inventory .qr-code-label { color: #64748B; }
    .qr-download-buttons { display: flex; gap: 0.75rem; justify-content: center; }
    .qr-download-btn {
      padding: 0.75rem 1.25rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      transition: all 0.2s;
    }
    .qr-download-btn.customer {
      background: linear-gradient(135deg, #4F46E5, #7C3AED);
      color: white; border: none;
    }
    .qr-download-btn.customer:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }
    .qr-download-btn.inventory {
      background: white; color: #64748B; border: 2px solid #CBD5E1;
    }
    .qr-download-btn.inventory:hover { background: #F8FAFC; }
    .qr-download-btn.both {
      background: linear-gradient(135deg, #F59E0B, #D97706);
      color: white; border: none;
    }
    .qr-download-btn.both:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }

    @media (max-width: 768px) {
      .sidebar { width: 100%; height: auto; position: relative; }
      .main-with-sidebar { margin-left: 0; padding: 1.5rem; }
      .product-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-logo"><h1>ðŸšš BizTrack</h1></div>
    <ul class="sidebar-nav">
      <li><a href="dashboard.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
      <li><a href="pricing.html"><i class="fas fa-credit-card"></i> Subscription</a></li>
      <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
    </ul>
    <div class="sidebar-logout">
      <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </nav>

  <div class="main-with-sidebar">
    <div class="dashboard-header">
      <h1>Welcome to your dashboard</h1>
      <p>Manage your products and mint to blockchain.</p>
    </div>

    <div class="usage-counter">
      <div class="usage-counter-info">
        <h4>QR Codes Used This Month</h4>
        <div class="usage-counter-numbers">
          <span id="qrUsedCount">0</span> <small>/ <span id="qrLimitCount">10</span></small>
        </div>
        <p style="margin-top: 0.5rem; font-size: 0.875rem; opacity: 0.9;" id="tierName">Free Plan</p>
      </div>
      <button class="usage-counter-upgrade" id="planButton" onclick="window.location.href='pricing.html'">
        <i class="fas fa-arrow-up"></i> <span id="planButtonText">Upgrade Plan</span>
      </button>
    </div>

    <div class="card">
      <h3><i class="fas fa-plus-circle"></i> Mint New Product</h3>
      
      <div class="batch-toggle-container">
        <div class="batch-toggle-label">
          <i class="fas fa-layer-group"></i>
          <span id="batchToggleText">Enable Batch Upload</span>
        </div>
        <div class="toggle-switch" id="batchToggle" onclick="toggleBatchMode()">
          <div class="toggle-switch-slider"></div>
        </div>
      </div>

      <div class="batch-quantity-section" id="batchQuantitySection">
        <h4><i class="fas fa-boxes"></i> Batch Order Settings</h4>
        <div class="form-group">
          <label for="batchQuantity">
            Quantity (1-<span id="maxBatchQuantity">10</span>)
            <span id="remainingQRs" style="color: #059669; font-size: 0.875rem;"></span>
          </label>
          <input id="batchQuantity" type="number" min="1" max="10" value="5" />
        </div>
        <div class="batch-info">
          <strong>Note:</strong> SKUs will be auto-generated (e.g., ORG1234-001, ORG1234-002, ...).
        </div>
      </div>
      
      <div class="form-group">
        <label for="dashProdName">Product Name *</label>
        <input id="dashProdName" type="text" placeholder="e.g. Organic Honey" />
      </div>
      
      <div class="form-group">
        <label for="dashSku" id="skuLabel">SKU</label>
        <input id="dashSku" type="text" placeholder="e.g. HNY1234" />
      </div>
      
      <div class="form-group">
        <label for="dashBatch">Batch Number</label>
        <input id="dashBatch" type="text" placeholder="e.g. 001" />
      </div>
      
      <div class="form-group">
        <label for="dashMetadata">Additional Info (optional)</label>
        <textarea id="dashMetadata" placeholder="e.g. Harvest date, origin, certifications" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label>Photos (optional)</label>
        <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" />
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" />
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
            <i class="fas fa-camera"></i> Take Photo
          </button>
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">
            <i class="fas fa-images"></i> Gallery
          </button>
          <button type="button" class="btn btn-secondary" id="captureLocationBtn">
            <i class="fas fa-map-marker-alt"></i> <span id="locationBtnText">Location</span>
          </button>
        </div>
        <div id="photoPreview" style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap;"></div>
        <p id="locationDisplay" style="margin-top: 0.75rem; color: #10B981; font-size: 0.875rem; display: none;">
          <i class="fas fa-check-circle"></i> Location captured!
        </p>
      </div>
      
      <button class="btn" id="dashCreateBtn">
        <i class="fas fa-rocket"></i>
        <span id="mintButtonText">Mint to Blockchain</span>
      </button>
      
      <div id="dashMsg"></div>
    </div>

    <div class="card">
      <h3><i class="fas fa-box"></i> Your Minted Products</h3>
      <ul id="batchList" class="product-list"></ul>
    </div>
  </div>

  <!-- QR Code Modal -->
  <div class="qr-modal-overlay" id="qrModalOverlay" onclick="closeQRModal(event)">
    <div class="qr-modal" onclick="event.stopPropagation()">
      <div class="qr-modal-header">
        <h2><i class="fas fa-qrcode" style="color: #4F46E5;"></i> QR Codes</h2>
        <button class="qr-modal-close" onclick="closeQRModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="qr-modal-sku">
        <span id="modalSku">SKU: ---</span>
      </div>

      <div class="qr-codes-container">
        <div class="qr-code-box customer">
          <img id="modalCustomerQR" src="" alt="Customer QR" />
          <div class="qr-code-label">Customer</div>
        </div>
        <div class="qr-code-box inventory" id="inventoryQRBox">
          <img id="modalInventoryQR" src="" alt="Inventory QR" />
          <div class="qr-code-label">Inventory</div>
        </div>
      </div>

      <div class="qr-download-buttons">
        <a id="downloadCustomerBtn" class="qr-download-btn customer" href="#" target="_blank">
          <i class="fas fa-mobile-alt"></i> Customer
        </a>
        <a id="downloadInventoryBtn" class="qr-download-btn inventory" href="#" target="_blank">
          <i class="fas fa-barcode"></i> Inventory
        </a>
        <button id="downloadBothBtn" class="qr-download-btn both" onclick="downloadBothQRs()">
          <i class="fas fa-layer-group"></i> Both
        </button>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    requireAuth();

    let isBatchMode = false;
    let selectedPhotos = [];
    let capturedLocation = null;
    let qrUsedThisMonth = 0;
    let qrLimit = 10;
    let currentTier = 'free';

    // ==========================================
    // QR MODAL - Shows both QRs with download options
    // ==========================================
    let currentQRData = null;
    
    window.openQRModal = function(productJson) {
      const product = typeof productJson === 'string' ? JSON.parse(productJson) : productJson;
      currentQRData = product;
      
      document.getElementById('modalSku').textContent = 'SKU: ' + (product.sku || product.productId);
      document.getElementById('modalCustomerQR').src = product.qrCodeUrl;
      
      // Customer download button
      document.getElementById('downloadCustomerBtn').href = product.qrCodeUrl;
      document.getElementById('downloadCustomerBtn').setAttribute('download', (product.sku || product.productId) + '-customer-qr.png');
      
      // Handle inventory QR
      const inventoryBox = document.getElementById('inventoryQRBox');
      const inventoryBtn = document.getElementById('downloadInventoryBtn');
      const bothBtn = document.getElementById('downloadBothBtn');
      
      if (product.inventoryQrCodeUrl) {
        document.getElementById('modalInventoryQR').src = product.inventoryQrCodeUrl;
        inventoryBtn.href = product.inventoryQrCodeUrl;
        inventoryBtn.setAttribute('download', (product.sku || product.productId) + '-inventory-qr.png');
        inventoryBox.style.display = 'block';
        inventoryBtn.style.display = 'flex';
        bothBtn.style.display = 'flex';
      } else {
        inventoryBox.style.display = 'none';
        inventoryBtn.style.display = 'none';
        bothBtn.style.display = 'none';
      }
      
      document.getElementById('qrModalOverlay').classList.add('show');
      document.body.style.overflow = 'hidden';
    };
    
    window.closeQRModal = function(event) {
      if (event && event.target !== event.currentTarget) return;
      document.getElementById('qrModalOverlay').classList.remove('show');
      document.body.style.overflow = '';
      currentQRData = null;
    };
    
    window.downloadBothQRs = async function() {
      if (!currentQRData) return;
      
      const btn = document.getElementById('downloadBothBtn');
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
      btn.disabled = true;
      
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600;
        canvas.height = 380;
        
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        const customerImg = new Image();
        const inventoryImg = new Image();
        customerImg.crossOrigin = 'anonymous';
        inventoryImg.crossOrigin = 'anonymous';
        
        await Promise.all([
          new Promise(function(resolve, reject) {
            customerImg.onload = resolve;
            customerImg.onerror = reject;
            customerImg.src = currentQRData.qrCodeUrl;
          }),
          new Promise(function(resolve, reject) {
            inventoryImg.onload = resolve;
            inventoryImg.onerror = reject;
            inventoryImg.src = currentQRData.inventoryQrCodeUrl;
          })
        ]);
        
        ctx.fillStyle = '#1E293B';
        ctx.font = 'bold 22px Inter, Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(currentQRData.productName || 'Product', canvas.width / 2, 32);
        
        ctx.fillStyle = '#64748B';
        ctx.font = '14px Inter, Arial, sans-serif';
        ctx.fillText('SKU: ' + (currentQRData.sku || currentQRData.productId), canvas.width / 2, 55);
        
        var qrSize = 140;
        var qrY = 75;
        
        ctx.drawImage(customerImg, 80, qrY, qrSize, qrSize);
        ctx.drawImage(inventoryImg, 380, qrY, qrSize, qrSize);
        
        ctx.fillStyle = '#4F46E5';
        ctx.font = 'bold 13px Inter, Arial, sans-serif';
        ctx.fillText('Customer', 150, qrY + qrSize + 22);
        
        ctx.fillStyle = '#64748B';
        ctx.fillText('Inventory', 450, qrY + qrSize + 22);
        
        ctx.strokeStyle = '#E2E8F0';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(300, qrY + 10);
        ctx.lineTo(300, qrY + qrSize - 10);
        ctx.stroke();
        
        ctx.fillStyle = '#94A3B8';
        ctx.font = '9px Inter, Arial, sans-serif';
        ctx.fillText('Verified by BizTrack', canvas.width / 2, canvas.height - 12);
        
        var link = document.createElement('a');
        link.download = (currentQRData.sku || currentQRData.productId) + '-label.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        alert('Error creating label: ' + err.message);
      } finally {
        btn.innerHTML = '<i class="fas fa-layer-group"></i> Both';
        btn.disabled = false;
      }
    };
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeQRModal();
    });

    // ==========================================
    // SUBSCRIPTION & LIMITS
    // ==========================================
    async function loadSubscriptionLimits() {
      try {
        const response = await authenticatedFetch('/api/check-limits');
        const data = await response.json();
        
        if (data.success) {
          qrUsedThisMonth = data.subscription.qrUsed;
          qrLimit = data.subscription.qrLimit;
          currentTier = data.subscription.tier;
          
          document.getElementById('qrUsedCount').textContent = qrUsedThisMonth.toLocaleString();
          document.getElementById('qrLimitCount').textContent = qrLimit.toLocaleString();
          document.getElementById('tierName').textContent = currentTier.charAt(0).toUpperCase() + currentTier.slice(1) + ' Plan';
          
          // Update button text for top tier users
          const topTiers = ['enterprise', 'pharma_enterprise'];
          if (topTiers.includes(currentTier)) {
            document.getElementById('planButtonText').textContent = 'View Plan';
            document.getElementById('planButton').querySelector('i').className = 'fas fa-eye';
          }
          
          const remaining = qrLimit - qrUsedThisMonth;
          const maxBatch = Math.min(data.subscription.maxBatchSize || 10, remaining);
          
          document.getElementById('maxBatchQuantity').textContent = maxBatch;
          document.getElementById('batchQuantity').max = maxBatch;
        }
      } catch (error) {
        console.error('Failed to load limits:', error);
      }
    }

    function toggleBatchMode() {
      isBatchMode = !isBatchMode;
      const toggle = document.getElementById('batchToggle');
      const section = document.getElementById('batchQuantitySection');
      const toggleText = document.getElementById('batchToggleText');
      const mintText = document.getElementById('mintButtonText');
      const skuInput = document.getElementById('dashSku');
      
      if (isBatchMode) {
        toggle.classList.add('active');
        section.classList.add('show');
        toggleText.textContent = 'Batch Mode Enabled âœ“';
        mintText.textContent = 'Mint Batch to Blockchain';
        skuInput.disabled = true;
        skuInput.value = '';
        skuInput.placeholder = 'Auto-generated';
        document.getElementById('remainingQRs').textContent = '(' + (qrLimit - qrUsedThisMonth) + ' available)';
      } else {
        toggle.classList.remove('active');
        section.classList.remove('show');
        toggleText.textContent = 'Enable Batch Upload';
        mintText.textContent = 'Mint to Blockchain';
        skuInput.disabled = false;
        skuInput.placeholder = 'e.g. HNY1234';
        document.getElementById('remainingQRs').textContent = '';
      }
    }

    // ==========================================
    // PHOTO HANDLING
    // ==========================================
    async function compressImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const MAX = 1200;
            if (w > h && w > MAX) { h *= MAX / w; w = MAX; }
            else if (h > MAX) { w *= MAX / h; h = MAX; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    document.getElementById('photoInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    document.getElementById('cameraInput').addEventListener('change', async (e) => {
      for (const file of Array.from(e.target.files)) {
        if (selectedPhotos.length >= 5) break;
        selectedPhotos.push(await compressImage(file));
        displayPhotoPreview();
      }
      e.target.value = '';
    });

    function displayPhotoPreview() {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      selectedPhotos.forEach((photo, i) => {
        const div = document.createElement('div');
        div.style.cssText = 'position: relative; width: 80px; height: 80px;';
        div.innerHTML = '<img src="' + photo + '" style="width:100%;height:100%;object-fit:cover;border-radius:8px;border:2px solid #E2E8F0;"/><button onclick="removePhoto(' + i + ')" style="position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:#DC2626;color:white;border:none;cursor:pointer;font-size:10px;">âœ•</button>';
        preview.appendChild(div);
      });
    }

    window.removePhoto = (i) => { selectedPhotos.splice(i, 1); displayPhotoPreview(); };

    document.getElementById('captureLocationBtn').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      const btn = document.getElementById('captureLocationBtn');
      btn.disabled = true;
      document.getElementById('locationBtnText').textContent = 'Getting...';
      
      const options = {
        enableHighAccuracy: false,
        timeout: 15000,
        maximumAge: 300000
      };
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          capturedLocation = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
          document.getElementById('locationDisplay').style.display = 'block';
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Update';
        },
        (err) => {
          btn.disabled = false;
          document.getElementById('locationBtnText').textContent = 'Location';
          
          if (err.code === 1) {
            alert('Location access denied. Please enable location permissions in your browser settings.');
          } else if (err.code === 2) {
            alert('Location unavailable. Please check your device location settings.');
          } else if (err.code === 3) {
            alert('Location request timed out. Please try again.');
          } else {
            alert('Location error: ' + err.message);
          }
        },
        options
      );
    });

    // ==========================================
    // BATCH ZIP DOWNLOAD
    // ==========================================
    window.downloadBatchZip = async (batchGroupId) => {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ZIP...';

      try {
        const response = await authenticatedFetch('/api/list-products');
        const data = await response.json();
        const batch = data.products.find(b => b.batchGroupId === batchGroupId);
        if (!batch) throw new Error('Batch not found');
        const items = batch.items || [];
        if (!items.length) throw new Error('No items');

        const zip = new JSZip();
        const customerFolder = zip.folder('Customer-QR-Codes');
        const inventoryFolder = zip.folder('Inventory-QR-Codes');
        
        for (const p of items) {
          if (p.qrCodeUrl) {
            const r = await fetch(p.qrCodeUrl);
            customerFolder.file(p.sku + '-customer.png', await r.blob());
          }
          if (p.inventoryQrCodeUrl) {
            const r = await fetch(p.inventoryQrCodeUrl);
            inventoryFolder.file(p.sku + '-inventory.png', await r.blob());
          }
        }

        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(zipBlob);
        a.download = batch.productName.replace(/[^a-z0-9]/gi, '_') + '_batch.zip';
        a.click();
      } catch (err) {
        alert('ZIP error: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-download"></i> ZIP';
      }
    };

    // ==========================================
    // PRODUCT LIST
    // ==========================================
    function populateBatches() {
      const list = document.getElementById('batchList');
      list.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>';
      
      authenticatedFetch('/api/list-products')
        .then(res => res.json())
        .then(data => {
          if (!data.success || !data.products || !data.products.length) {
            list.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><p>No products yet.</p></div>';
            return;
          }

          list.innerHTML = '';
          data.products.forEach(product => {
            const li = document.createElement('li');
            const items = product.items || [];
            
            if (product.isBatchGroup && items.length > 0) {
              const itemsId = 'items-' + product.batchGroupId;
              li.innerHTML = '<div class="product-header"><div><strong>' + product.productName + '</strong><span class="batch-badge">BATCH ' + product.quantity + '</span><br><small>Batch: ' + (product.batchNumber || 'N/A') + '</small></div><div style="display:flex;gap:0.5rem;"><button class="btn btn-secondary" onclick="toggleBatchItems(\'' + itemsId + '\',this)"><i class="fas fa-chevron-down"></i> Items</button><button class="btn btn-secondary" onclick="downloadBatchZip(\'' + product.batchGroupId + '\')"><i class="fas fa-download"></i> ZIP</button></div></div><div id="' + itemsId + '" class="batch-items">' + items.map(function(p) {
                return '<div class="batch-item"><div><strong>' + p.sku + '</strong></div><div style="display:flex;gap:0.5rem;"><a href="' + p.verificationUrl + '" class="btn btn-secondary" style="padding:0.5rem 0.75rem;font-size:0.8rem;" target="_blank"><i class="fas fa-eye"></i></a><button class="btn btn-secondary" style="padding:0.5rem 0.75rem;font-size:0.8rem;" onclick=\'openQRModal(' + JSON.stringify(p).replace(/'/g, "\\'") + ')\'><i class="fas fa-qrcode"></i></button></div></div>';
              }).join('') + '</div>';
            } else {
              li.innerHTML = '<div class="product-header"><div><strong>' + product.productName + '</strong><br><small>SKU: ' + (product.sku || 'N/A') + '</small></div><div style="display:flex;gap:0.5rem;"><a href="' + product.verificationUrl + '" class="btn btn-secondary" target="_blank"><i class="fas fa-eye"></i> View</a><button class="btn btn-secondary" onclick=\'openQRModal(' + JSON.stringify(product).replace(/'/g, "\\'") + ')\'><i class="fas fa-qrcode"></i> QR</button></div></div>';
            }
            list.appendChild(li);
          });
        })
        .catch(err => {
          list.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error: ' + err.message + '</p></div>';
        });
    }

    window.toggleBatchItems = (id, btn) => {
      const items = document.getElementById(id);
      if (items.classList.contains('show')) {
        items.classList.remove('show');
        btn.innerHTML = '<i class="fas fa-chevron-down"></i> Items';
      } else {
        items.classList.add('show');
        btn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
      }
    };

    // ==========================================
    // MINT PRODUCT
    // ==========================================
    document.getElementById('dashCreateBtn').addEventListener('click', async () => {
      const productName = document.getElementById('dashProdName').value.trim();
      const sku = document.getElementById('dashSku').value.trim();
      const batchNumber = document.getElementById('dashBatch').value.trim();
      const metadata = document.getElementById('dashMetadata').value.trim();
      const batchQuantity = isBatchMode ? parseInt(document.getElementById('batchQuantity').value) : 1;
      const msgEl = document.getElementById('dashMsg');
      const btn = document.getElementById('dashCreateBtn');
      
      msgEl.innerHTML = '';
      if (!productName) { msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Product name required.</div>'; return; }
      if (!isBatchMode && !sku) { msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> SKU required.</div>'; return; }

      btn.disabled = true;
      const origText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Minting...';
      msgEl.innerHTML = '<div class="message info"><i class="fas fa-info-circle"></i> Uploading to blockchain...</div>';

      try {
        const token = localStorage.getItem('biztrack-auth-token');
        if (!token) throw new Error('Session expired');

        const response = await fetch('/api/mint-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({
            productName,
            sku: isBatchMode ? undefined : sku,
            batchNumber,
            metadata: metadata ? { notes: metadata } : {},
            photos: selectedPhotos.length ? selectedPhotos : null,
            location: capturedLocation,
            isBatchOrder: isBatchMode,
            batchQuantity
          })
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.details || result.error || 'Minting failed');

        msgEl.innerHTML = '<div class="message success"><i class="fas fa-check-circle"></i> ' + (result.isBatch ? 'Batch minted!' : 'Product minted!') + '</div>';
        
        document.getElementById('dashProdName').value = '';
        document.getElementById('dashSku').value = '';
        document.getElementById('dashBatch').value = '';
        document.getElementById('dashMetadata').value = '';
        selectedPhotos = [];
        capturedLocation = null;
        document.getElementById('photoPreview').innerHTML = '';
        document.getElementById('locationDisplay').style.display = 'none';

        await loadSubscriptionLimits();
        populateBatches();
      } catch (err) {
        msgEl.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> ' + err.message + '</div>';
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Logout?')) logout();
    });

    loadSubscriptionLimits();
    populateBatches();
  </script>
</body>
</html>
